<root>
  <forms>
    <form name="10653(37)">
      <content>
        <field name="ym" controlType="UICombo" title="Период">
          <listquery>
            <query name="n_calc_dist">
            </query>
          </listquery>
          <defaultquery>
            <query name="kr_calc_max">
            </query>
          </defaultquery>
        </field>
        <field name="dep" controlType="UIList" title="Отделение">
          <listquery>
            <query name="kr_org_dep%tbl">
            </query>
          </listquery>
        </field>
        <field name="org" controlType="UIList" title="Организация составившая акт">
          <listquery>
            <query name="hr_bu_org">
            </query>
          </listquery>
        </field>
      </content>
    </form>
  </forms>
  <reports>
    <report name="10653(37)" title="Приложение № 5. Задолженность по актам неучтенного потребления электроэнергии" form="10653(37)" folder="bu" kod-menu="12209" visible="0">
      <customers>
        <customer id="10" />
      </customers>
      <print-templates>
        <excel>
          <template name="10653(37)-5.xml" title="Приложение № 5" multipage="1" />
        </excel>
      </print-templates>
      <params>
        <param name="ym">
          <const>2014.03</const>
        </param>
        <param name="dep">
          <undefined />
        </param>
        <param name="org">
          <const>1234</const>
        </param>
      </params>
      <queries>
        <query name="10653(37)-dep-org" as="a0" title="По подразделениям и организациям составившим акт">
          <withparams>
            <useparam name="ym">
            </useparam>
            <useparam name="dep" />
            <useparam name="org" />
          </withparams>
          <query name="10653(37)-title" as="a1" union="0" title="Доп. данные">
            <withparams>
              <useparam name="ym">
              </useparam>
            </withparams>
            <call function="and">
              <call function="=">
                <column table="a0" column="dep">
                </column>
                <column table="a1" column="dep">
                </column>
              </call>
              <call function="=nvl">
                <column table="a0" column="kod_bu_org">
                </column>
                <column table="a1" column="kod_bu_org">
                </column>
              </call>
            </call>

          </query>
          <query name="10653(37)-rgod" as="a" title="По годам">
            <withparams>
              <useparam name="ym">
              </useparam>
              <useparam name="dep" />
              <useparam name="org" />
            </withparams>
            <call function="and">
              <call function="=">
                <column table="a0" column="dep">
                </column>
                <column table="a" column="dep">
                </column>
              </call>
              <call function="=nvl">
                <column table="a0" column="kod_bu_org">
                </column>
                <column table="a" column="kod_bu_org">
                </column>
              </call>
            </call>
            <query name="10653(37)-rym" as="b" title="По периодам">
              <withparams>
                <useparam name="ym">
                </useparam>
                <useparam name="dep" />
                <useparam name="org" />
              </withparams>
              <call function="and">
                <call function="=">
                  <column table="a" column="rgod">
                  </column>
                  <column table="b" column="rgod">
                  </column>
                </call>
                <call function="=">
                  <column table="a" column="dep">
                  </column>
                  <column table="b" column="dep">
                  </column>
                </call>
                <call function="=nvl">
                  <column table="a" column="kod_bu_org">
                  </column>
                  <column table="b" column="kod_bu_org">
                  </column>
                </call>
              </call>
              <query name="10653(37)-rym-ar" as="c"  title="По районам">
                <withparams>
                  <useparam name="ym">
                  </useparam>
                  <useparam name="dep" />
                  <useparam name="org" />
                </withparams>
                <call function="and">
                  <call function="=">
                    <column table="b" column="rym">
                    </column>
                    <column table="c" column="rym">
                    </column>
                  </call>
                  <call function="=">
                    <column table="b" column="dep">
                    </column>
                    <column table="c" column="dep">
                    </column>
                  </call>
                  <call function="=nvl">
                    <column table="b" column="kod_bu_org">
                    </column>
                    <column table="c" column="kod_bu_org">
                    </column>
                  </call>
                </call>
                <query name="10653(37)-sf" as="d" main="1" title="По актам">
                  <withparams>
                    <useparam name="ym">
                    </useparam>
                    <useparam name="dep" />
                    <useparam name="org" />
                  </withparams>
                  <call function="and">
                    <call function="=">
                      <column table="c" column="rym">
                      </column>
                      <column table="d" column="rym">
                      </column>
                    </call>
                    <call function="=nvl">
                      <column table="c" column="obj_kod_m">
                      </column>
                      <column table="d" column="obj_kod_m">
                      </column>
                    </call>
                    <call function="=">
                      <column table="c" column="dep">
                      </column>
                      <column table="d" column="dep">
                      </column>
                    </call>
                    <call function="=nvl">
                      <column table="c" column="kod_bu_org">
                      </column>
                      <column table="d" column="kod_bu_org">
                      </column>
                    </call>
                  </call>
                </query>
              </query>
            </query>
          </query>
        </query>
      </queries>
    </report>
  </reports>
  <queries>
    <query name="10653(37)-title">
      <params>
        <param name="ym">
          <const>2014.03</const>
        </param>
      </params>
      <select>
        <column table="a" column="puser">
        </column>
        <column table="a" column="fio" as="cu_fio">
        </column>
        <column table="a" column="tel" as="cu_tel">
        </column>
        <call function="date to char" as="dat_otch">
          <call function="ym end time">
            <useparam name="ym">
            </useparam>
          </call>
        </call>
        <column table="b" column="kodp" as="dep" key="1">
        </column>
        <column table="c" column="kod_bu_org" key="1">
        </column>
        <column table="b" column="name" as="dep_name">
        </column>
        <column table="b" column="vis1_fio">
        </column>
        <column table="b" column="vis2_fio">
        </column>
      </select>
      <from>
        <query name="ks_user_cur" as="a">
        </query>
        <query name="kr_org_dep" as="b" join="cross">
        </query>
        <query name="hr_bu_org" as="c" join="cross">
        </query>
      </from>
    </query>
    <query name="10653(37)-dep-org" order="rwn">
      <params>
        <param name="ym">
          <const>2014.03</const>
        </param>
        <param name="dep">
          <undefined />
        </param>
        <param name="org">
          <undefined />
        </param>
      </params>
      <select>
        <column table="a" column="dep" group="1">
        </column>
        <column table="a" column="pr_dolg" group="sum">
        </column>
        <column table="a" column="dep_name" group="max">
        </column>
        <column table="a" column="kod_bu_org" group="1">
        </column>
        <column table="a" column="bu_akt_org_name" group="max">
        </column>
        <column table="a" column="rwn" group="min">
        </column>
        <column table="a" column="dolg_beg" group="sum">
        </column>
        <column table="a" column="nachisl" group="sum">
        </column>
        <column table="a" column="cust" group="sum">
        </column>
        <column table="a" column="opl" group="sum">
        </column>
        <column table="a" column="opl_cust" group="sum">
        </column>
        <column table="a" column="dolg" group="sum">
        </column>
      </select>
      <from>
        <query name="10653(37)" as="a" materialize="1">
          <withparams>
            <useparam name="ym" />
            <useparam name="dep" />
            <useparam name="org" />
          </withparams>
        </query>
      </from>
      <!--<where>
        <call function="and">
          <call function="=">
            <column table="a"  column="dep"></column>
            <useparam name="dep"></useparam>
          </call>
          <call function="=">
            <column table="a"  column="kod_bu_org"></column>
            <useparam name="org"></useparam>
          </call>
        </call>
      </where>-->
    </query>
    <query name="10653(37)-rgod" order="rwn">
      <params>
        <param name="ym">
          <const>2014.03</const>
        </param>
        <param name="dep">
          <undefined />
        </param>
        <param name="org">
          <undefined />
        </param>
      </params>
      <select>
        <column table="a" column="rgod" group="1">
        </column>
        <column table="a" column="pr_dolg" group="sum">
        </column>
        <column table="a" column="rwn" group="min">
        </column>
        <column table="a" column="dolg_beg" group="sum">
        </column>
        <column table="a" column="nachisl" group="sum">
        </column>
        <column table="a" column="cust" group="sum">
        </column>
        <column table="a" column="opl" group="sum">
        </column>
        <column table="a" column="opl_cust" group="sum">
        </column>
        <column table="a" column="dolg" group="sum">
        </column>
        <column table="a" column="dep" group="1">
        </column>
        <column table="a" column="dep_name" group="max">
        </column>
        <column table="a" column="kod_bu_org" group="1">
        </column>
        <column table="a" column="bu_akt_org_name" group="max">
        </column>
      </select>
      <from>
        <query name="10653(37)" as="a" materialize="1">
          <withparams>
            <useparam name="ym" />
            <useparam name="dep" />
            <useparam name="org" />
          </withparams>
        </query>
      </from>
    </query>
    <query name="10653(37)-rym" order="rwn">
      <params>
        <param name="ym">
          <const>2014.03</const>
        </param>
        <param name="dep">
          <undefined />
        </param>
        <param name="org">
          <undefined />
        </param>
      </params>
      <select>
        <column table="a" column="rwn" group="min">
        </column>
        <column table="a" column="rym" group="1">
        </column>
        <column table="a" column="rgod" group="max">
        </column>
        <column table="a" column="mes_name" group="max">
        </column>
        <column table="a" column="pr_dolg" group="sum">
        </column>
        <column table="a" column="dolg_beg" group="sum">
        </column>
        <column table="a" column="nachisl" group="sum">
        </column>
        <column table="a" column="cust" group="sum">
        </column>
        <column table="a" column="opl" group="sum">
        </column>
        <column table="a" column="opl_cust" group="sum">
        </column>
        <column table="a" column="dolg" group="sum">
        </column>
        <column table="a" column="dep" group="1">
        </column>
        <column table="a" column="dep_name" group="max">
        </column>
        <column table="a" column="kod_bu_org" group="1">
        </column>
        <column table="a" column="bu_akt_org_name" group="max">
        </column>
      </select>
      <from>
        <query name="10653(37)" as="a" materialize="1">
          <withparams>
            <useparam name="ym" />
            <useparam name="dep" />
            <useparam name="org" />
          </withparams>
        </query>
      </from>
    </query>
    <query name="10653(37)-rym-ar" order="rwn">
      <params>
        <param name="ym">
          <const>2014.03</const>
        </param>
        <param name="dep">
          <undefined />
        </param>
        <param name="org">
          <undefined />
        </param>
      </params>
      <select>
        <column table="a" column="rym" group="1">
        </column>
        <column table="a" column="rwn" group="min">
        </column>
        <column table="a" column="obj_kod_m" group="1">
        </column>
        <column table="a" column="obj_adr_m_name" group="max">
        </column>
        <column table="a" column="mes_name" group="max">
        </column>
        <column table="a" column="pr_dolg" group="sum">
        </column>
        <column table="a" column="dolg_beg" group="sum">
        </column>
        <column table="a" column="nachisl" group="sum">
        </column>
        <column table="a" column="cust" group="sum">
        </column>
        <column table="a" column="opl" group="sum">
        </column>
        <column table="a" column="opl_cust" group="sum">
        </column>
        <column table="a" column="dolg" group="sum">
        </column>
        <column table="a" column="dep" group="1">
        </column>
        <column table="a" column="dep_name" group="max">
        </column>
        <column table="a" column="kod_bu_org" group="1">
        </column>
        <column table="a" column="bu_akt_org_name" group="max">
        </column>
      </select>
      <from>
        <query name="10653(37)" as="a" materialize="1">
          <withparams>
            <useparam name="ym" />
            <useparam name="dep" />
            <useparam name="org" />
          </withparams>
        </query>
      </from>
    </query>
    <!-- hint="FIRST_ROWS (10)"-->
    <query name="10653(37)-sf" order="rwn">
      <params>
        <param name="ym">
          <const>2014.03</const>
        </param>
        <param name="dep">
          <undefined />
        </param>
        <param name="org">
          <undefined />
        </param>
      </params>
      <select>
        <column table="a" column="*">
        </column>
      </select>
      <from>
        <query name="10653(37)" as="a" materialize="1">
          <withparams>
            <useparam name="ym" />
            <useparam name="dep" />
            <useparam name="org" />
          </withparams>
        </query>
      </from>
    </query>
    <query name="10653(37)" hint="use_nl(a b) use_nl(a c) use_nl(a b1) use_nl(a c1)">
      <params>
        <param name="ym">
          <const>2014.05</const>
        </param>
        <param name="dep">
          <undefined />
        </param>
        <param name="org">
          <undefined />
        </param>
      </params>
      <select>
        <call function="row_number" as="rwn" type="number" title="№ пп">
          <call function="partition by">
            <const>dep,kod_bu_org</const>
          </call>
          <call function="order by 2">
            <const>rym,obj_adr_m_name</const>
          </call>
        </call>
        <!--<column  column="rownum" as="rwn" type="number" title="№ пп"></column>-->
        <column table="a" column="kod_bu_akt">
        </column>
        <column table="a" column="kod_sf">
        </column>
        <column table="a" column="obj_kod_m">
        </column>
        <column table="a" column="obj_adr_m_name" fixed="1">
        </column>
        <column table="a" column="dep">
        </column>
        <column table="a" column="dep_name">
        </column>
        <column table="a" column="kod_bu_org">
        </column>
        <column table="a" column="bu_akt_org_name">
        </column>
        <column table="a" column="kodp">
        </column>
        <column table="a" column="ndog">
        </column>
        <column table="a" column="payer_name">
        </column>
        <column table="a" column="dat_saldo">
        </column>
        <column table="a" column="bu_akt_num">
        </column>
        <column table="a" column="bu_akt_dat">
        </column>
        <call function="case" as="pr_dolg" type="number" title="Признак наличия сальдо на конец периода">
          <call function="when">
            <call function="!=0">
              <column table="this" column="dolg">
              </column>
            </call>
            <const>1</const>
          </call>
          <call function="else">
            <const>0</const>
          </call>
        </call>
        <column table="a" column="rgod">
        </column>
        <column table="a" column="rym" fixed="1">
        </column>
        <call function="mes-name" as="mes_name">
          <call function="mes">
            <column table="a" column="rym">
            </column>
          </call>
        </call>
        <call function="-" as="dolg_beg" title="Задолженность на начало периода">
          <column table="this" column="dolg">
          </column>
          <call function="-nvl">
            <column table="b" column="nachisl">
            </column>
            <column table="c" column="opl">
            </column>
          </call>
        </call>
        <column table="b" column="nachisl" nvl="0">
        </column>
        <column table="b" column="cust" nvl="0">
        </column>
        <column table="c" column="opl" nvl="0">
        </column>
        <column table="c" column="cust" as="opl_cust" nvl="0">
        </column>
        <call function="-" as="dolg" title="Задолженность на конец периода">
          <call function="-nvl">
            <column table="b1" column="nachisl">
            </column>
            <column table="c1" column="opl">
            </column>
          </call>
        </call>
      </select>
      <from>
        <query name="10653(37)-main" as="a">
          <withparams>
            <useparam name="ym" />
            <useparam name="dep" />
            <useparam name="org" />
          </withparams>
        </query>
        <query name="10653(37)-nachisl-ym" as="b" join="left outer" >
          <withparams>
            <useparam name="ym" />
          </withparams>
          <call function="=">
            <column table="a" column="kod_bu_akt">
            </column>
            <column table="b" column="kod_bu_akt">
            </column>
          </call>
        </query>
        <query name="10653(37)-opl-ym" as="c" join="left outer" >
          <withparams>
            <useparam name="ym" />
          </withparams>
          <call function="=">
            <column table="a" column="kod_bu_akt">
            </column>
            <column table="c" column="kod_bu_akt">
            </column>
          </call>
        </query>
        <query name="10653(37)-nachisl-all" as="b1" join="left outer" >
          <withparams>
            <useparam name="ym" />
          </withparams>
          <call function="=">
            <column table="a" column="kod_bu_akt">
            </column>
            <column table="b1" column="kod_bu_akt">
            </column>
          </call>
        </query>
       <query name="10653(37)-opl-all" as="c1" join="left outer">
          <withparams>
            <useparam name="ym" />
          </withparams>
          <call function="=">
            <column table="a" column="kod_bu_akt">
            </column>
            <column table="c1" column="kod_bu_akt">
            </column>
          </call>
        </query>
      </from>
      <where>
        <call function="and">
          <call function="!=0">
            <column table="this" column="dolg">
            </column>
            <column table="b" column="nachisl">
            </column>
            <column table="c" column="opl">
            </column>
          </call>
          <call function="is not null">
            <column table="a"  column="kod_sf"></column>
          </call>
        </call>
      </where>
    </query>
   
    <query name="10653(37)-main" order="dep,kod_bu_org,rym,obj_adr_m_name">
      <params>
        <param name="ym">
          <const>2014.05</const>
        </param>
        <param name="dep">
          <undefined />
        </param>
        <param name="org">
          <undefined />
        </param>
      </params>
      <select>
        <column table="a" column="kod_bu_akt">
        </column>
        <column table="a" column="kod_sf">
        </column>
        <column table="a" column="obj_kod_m">
        </column>
        <column table="a" column="obj_adr_m_name">
        </column>
        <column table="a" column="kodp">
        </column>
        <column table="a" column="ndog">
        </column>
        <column table="a" column="dep">
        </column>
        <column table="a" column="dep_name">
        </column>
        <column table="a" column="kod_bu_org">
        </column>
        <column table="a" column="bu_akt_org_name">
        </column>
        <column table="a" column="payer_name">
        </column>
        <column table="a" column="bu_akt_dat">
        </column>
        <column table="a" column="dat_saldo_bu" as="dat_saldo">
        </column>
        <column table="a" column="bu_akt_num">
        </column>
        <column table="a" column="ym_saldo_bu" as="rym" title="Период возникновения сальдо"/>
        <column table="a" column="god_saldo_bu" as="rgod"/>
       <!-- <column table="a" column="dolg_bu" as="dolg">
        </column>-->

        

        <column table="a" column="sf_ym" as ="ym">
        </column>
      </select>
      <from>
        <query name="10653(52)" as="a"/>
      </from>
      <where>
        <!-- <call function="is not null">
          <column table="a"  column="kod_bu_akt"></column>
        </call>-->
        <call function="and">
          <call function="ls=">
            <column table="a" column="ym_saldo_bu">
            </column>
            <useparam name="ym" />
          </call>
          <call function="in" optional="1">
            <column table="a" column="dep"/>
            <useparam name="dep"/>
          </call>
          <call function="in" optional="1">
            <column table="a" column="kod_bu_org"/>
            <useparam name="org"/>
          </call>
          <call function="is not null">
            <column table="a" column="kod_bu_org"/>
          </call>
        </call>
      </where>
    </query>
    
    <query name="10653(37)-nachisl-all">
      <params>
        <param name="ym">
          <const>2014.01</const>
        </param>
      </params>
      <select>
        <column table="a" column="kod_bu_akt" group="1">
        </column>
        <column table="a" column="nachisl" group="sum">
        </column>
        <column table="a" column="cust" group="sum">
        </column>
      </select>
      <from>
        <query name="10653(52)-ym-nachisl" as="a">
        </query>
      </from>
      <where>
        <call function="and">
          <call function="ls=">
            <column table="a" column="ym">
            </column>
            <useparam name="ym">
            </useparam>
          </call>
        </call>
      </where>
    </query>

    <query name="10653(37)-nachisl-ym">
      <params>
        <param name="ym">
          <const>2014.05</const>
        </param>
      </params>
      <select>
        <column table="a" column="kod_bu_akt" group="1">
        </column>
        <column table="a" column="nachisl" group="sum">
        </column>
        <column table="a" column="cust" group="sum">
        </column>
      </select>
      <from>
        <query name="10653(52)-ym-nachisl" as="a">
        </query>
      </from>
      <where>
        <call function="and">
          <call function="=">
            <column table="a" column="ym">
            </column>
            <useparam name="ym">
            </useparam>
          </call>
        </call>
      </where>
    </query>
   

  <!--  <query name="10653(37)-opl">
      <params>
        <param name="ym">
          <const>2013.01</const>
        </param>
      </params>
      <select>
        <column table="a" column="kod_sf" group="1">
        </column>
        <column table="a" column="opl" group="sum">
        </column>
        <column table="a" column="cust" group="sum">
        </column>
      </select>
      <from>
        <query name="sr_opl" as="a">
        </query>
      </from>
      <where>
        <call function="and">
          <call function="=">
            <column table="a" column="ym">
            </column>
            <useparam name="ym">
            </useparam>
          </call>
        </call>
      </where>
    </query>
    <query name="10653(37)-test">
      <select>
        <column table="a" column="kod_sf" group="1">
        </column>
        <column table="a" column="ym_priz_bu" group="sum">
        </column>
      </select>
      <from>
        <query name="sr_facvip" as="a">
        </query>
      </from>
    </query>-->


    <query name="10653(37)-opl-ym">
      <params>
        <param name="ym">
          <const>2014.05</const>
        </param>
      </params>
      <select>
        <column table="a" column="kod_bu_akt" group="1">
        </column>
        <column table="a" column="opl"  group="sum">
        </column>
        <column table="a" column="cust" group="sum">
        </column>
      </select>
      <from>
        <query name="10653(52)-ym-opl" as="a">
        </query>
      </from>
      <where>
        <call function="and">
          <call function="=">
            <column table="a" column="ym">
            </column>
            <useparam name="ym">
            </useparam>
          </call>
        </call>
      </where>
    </query>

    <query name="10653(37)-opl-all">
      <params>
        <param name="ym">
          <const>2014.05</const>
        </param>
      </params>
      <select>
        <column table="a" column="kod_bu_akt" group="1">
        </column>
        <column table="a" column="opl"  group="sum">
        </column>
        <column table="a" column="cust" group="sum">
        </column>
      </select>
      <from>
        <query name="10653(52)-ym-opl" as="a">
        </query>
      </from>
      <where>
        <call function="and">
          <call function="ls=">
            <column table="a" column="ym">
            </column>
            <useparam name="ym">
            </useparam>
          </call>
        </call>
      </where>
    </query>
    
    
  </queries>
</root>