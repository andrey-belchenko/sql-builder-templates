<root xmlns="sqlbuilder">
  <forms>
    <form name="10653(38)">
      <content>
        <field name="ym" controlType="UIComboRange" title="Период">
          <listquery>
            <query name="n_calc_dist">
            </query>
          </listquery>
          <defaultquery>
            <query name="n_calc_max">
            </query>
          </defaultquery>
        </field>
        <field name="org" controlType="UIList" title="Организация составившая акт">
          <!--<properties>
            <property name="MainView.OptionsView.ColumnAutoWidth">true</property>
            <property name="MainView.OptionsView.ShowColumnHeaders">false</property>
          </properties>-->
          <listquery>
            <query name="hr_bu_org">
            </query>
          </listquery>
          <!--<return>
            <node>
              <call function="in">
                <column table="b" column="kod_bu_org" />
                <call function="array">
                  <fieldvalue />
                </call>
              </call>
            </node>
          </return>-->
        </field>
      </content>
    </form>
  </forms>
  <reports>
    <report name="10653(38)" title="Приложение № 7. Сводный отчет по филиалам по актам неучтенного потребления электроэнергии" form="10653(38)" folder="bu" kod-menu="12209" visible="0">
      <customers>
        <customer id="10" />
      </customers>
      <print-templates>
        <excel>
          <template name="10653(38)-7.xml" title="Приложение № 7" multipage="1" />
        </excel>
      </print-templates>
      <params>
        <param name="ym1">
          <const>2014.01</const>
        </param>
        <param name="ym2">
          <const>2014.02</const>
        </param>
        <param name="org">
          <undefined/>
        </param>
      </params>
      <queries>
        <query name="10653(38)-org" as="a">
          <withparams>
            <useparam name="org" />
          </withparams>
          <query name="10653(38)" as="b" main="1">
            <withparams>
              <useparam name="ym1" />
              <useparam name="ym2" />
              <useparam name="org" />
            </withparams>
            <call function="=">
              <column table="a" column="kod_bu_org">
              </column>
              <column table="b" column="kod_bu_org">
              </column>
            </call>
          </query>
        </query>
        <query name="10653(38)-title" as="a1">
          <withparams>
            <useparam name="ym1" />
            <useparam name="ym2" />
          </withparams>
        </query>
      </queries>
    </report>
  </reports>
  <queries>
    <query name="10653(38)-title">
      <params>
        <param name="ym1">
          <const>2014.03</const>
        </param>
        <param name="ym2">
          <const>2014.03</const>
        </param>
      </params>
      <select>
        <column table="a" column="puser">
        </column>
        <column table="a" column="fio" as="cu_fio">
        </column>
        <column table="a" column="tel" as="cu_tel">
        </column>
        <call function="date to char" as="dat1">
          <call function="ym begin time">
            <useparam name="ym1">
            </useparam>
          </call>
        </call>
        <call function="date to char" as="dat2">
          <call function="ym end time">
            <useparam name="ym2">
            </useparam>
          </call>
        </call>
      </select>
      <from>
        <query name="ks_user_cur" as="a">
        </query>
      </from>
    </query>
    
    <query name="10653(38)-org">
      <params>
        <param name="org">
          <undefined>
          </undefined>
        </param>
      </params>
      <select>
        <column table="a" column="kod_bu_org" group="1" />
        <column table="a" column="org_name" group="max" />
      </select>
      <from>
        <query name="10653(38)-dep" as="a">
          <withparams>
            <useparam name="org" />
          </withparams>
        </query>
      </from>
    </query>
    
    <query name="10653(38)-dep" order="org_name,dep_name">
      <params>
        <param name="org">
          <undefined>
          </undefined>
        </param>
      </params>
      <select>
        <column table="a" column="kodp" as="dep" key="1">
        </column>
        <column table="a" column="name" as="dep_name" fixed="1">
        </column>
        <column table="b" column="kod_bu_org" key="1"/>
        <column table="b" column="name" as="org_name" />
      </select>
      <from>
        <query name="kr_org_dep%tbl" as="a">
        </query>
        <query name="hr_bu_org" as="b" join="cross">
        </query>
      </from>
      <where>
        <call function="and">
          <call function="=">
            <const>1</const>
            <const>1</const>
          </call>
          <call function="in" optional="1">
            <column table="b" column="kod_bu_org"/>
            <useparam name="org"/>
          </call>
        </call>
      </where>
    </query>
    
    <query name="10653(38)">
      <params>
        <param name="ym1">
          <const>2014.04</const>
        </param>
        <param name="ym2">
          <const>2014.04</const>
        </param>
        <param name="org">
          <undefined />
        </param>
      </params>
      <select>
        <column table="a" column="dep">
        </column>
        <column table="a" column="dep_name">
        </column>
        <column table="a" column="kod_bu_org" />
        <column table="a" column="org_name" />
        <column table="n" column="count_n">
        </column>
        <column table="n" column="cust" format="{0:n0}">
        </column>
        <column table="n" column="nachisl">
        </column>
        <column table="fo" column="count_o">
        </column>
        <column table="o" column="cust" as="opl_cust">
        </column>
        <column table="o" column="opl">
        </column>
      </select>
      <from>
        <query name="10653(38)-dep" as="a">
          <withparams>
            <useparam name="org" />
          </withparams>
        </query>
        <query name="10653(38)-nachisl" as="n" join="left outer" materialize="1">
          <call function="and">
            <call function="=">
              <column table="a" column="dep">
              </column>
              <column table="n" column="dep">
              </column>
            </call>
            <call function="=">
              <column table="a" column="kod_bu_org">
              </column>
              <column table="n" column="kod_bu_org">
              </column>
            </call>
          </call>
          <withparams>
            <useparam name="ym1" />
            <useparam name="ym2" />
          </withparams>
        </query>
        <query name="10653(38)-first-opl" as="fo" join="left outer">
          <call function="and">
            <call function="=">
              <column table="a" column="dep">
              </column>
              <column table="fo" column="dep">
              </column>
            </call>
            <call function="=">
              <column table="a" column="kod_bu_org">
              </column>
              <column table="fo" column="kod_bu_org">
              </column>
            </call>
          </call>
          <withparams>
            <useparam name="ym1" />
            <useparam name="ym2" />
          </withparams>
        </query>
        
        
        <query name="10653(38)-opl" as="o" join="left outer" materialize="1">
          <call function="and">
            <call function="=">
              <column table="a" column="dep">
              </column>
              <column table="o" column="dep">
              </column>
            </call>
            <call function="=">
              <column table="a" column="kod_bu_org">
              </column>
              <column table="o" column="kod_bu_org">
              </column>
            </call>
          </call>
          <withparams>
            <useparam name="ym1" />
            <useparam name="ym2" />
          </withparams>
        </query>
      </from>
    </query>
    
    <query name="10653(38)-nachisl">
      <params>
        <param name="ym1">
          <const>2014.04</const>
        </param>
        <param name="ym2">
          <const>2014.04</const>
        </param>
      </params>
      <select>
        <column table="a" column="kod_bu_org" group="1">
        </column>
        <column table="a" column="dep" group="1">
        </column>
        <column table="b" column="prizn" as="count_n" group="sum" title="Количество составленных актов">
        </column>
        <column table="b" column="nachisl" as="nachisl" group="sum">
        </column>
        <column table="b" column="cust" as="cust" group="sum">
        </column>
      </select>
      <from>
        <query name="10653(52)" as="a">
        </query>
        <query name="10653(52)-ym-nachisl" as="b" join="inner">
          <call function="=">
            <column table="a" column="kod_bu_akt"/>
            <column table="b" column="kod_bu_akt"/>
          </call>
        </query>
      </from>
      <where>
        <call function="and">
          <call function="between">
            <column table="b" column="ym"/>
            <useparam name="ym1"></useparam>
            <useparam name="ym2"></useparam>
          </call>
          <call function="is not null">
            <column table="a" column="kod_bu_org"/>
          </call>
          <call function="!=">
            <column table="b" column="nachisl"/>
            <const>0</const>
          </call>
        </call>
      </where>
    </query>


    
    <query name="10653(38)-first-opl1">
      <select>
        <column table="a" column="kod_bu_org" group="1">
        </column>
        <column table="a" column="kod_bu_akt" group="1">
        </column>
        <column table="a" column="dep" group="1">
        </column>
        <column table="a" column="ym_first_opl" group="min">
        </column>
      </select>
      <from>
        <query name="sr_facvip" as="a">
        </query>
      </from>
      <where>
        <call function="is not null">
          <column table="a" column="kod_bu_akt">
          </column>
        </call>
      </where>
    </query>
    
    <query name="10653(38)-first-opl">
      <params>
        <param name="ym1">
          <const>2014.04</const>
        </param>
        <param name="ym2">
          <const>2014.04</const>
        </param>
      </params>
      <select>
        <column table="a" column="kod_bu_org" group="1">
        </column>
        <column table="a" column="dep" group="1">
        </column>
        <column table="a" column="kod_bu_akt" as="count_o" group="count" title="Количество оплаченных актов">
        </column>
      </select>
      <from>
        <query name="10653(38)-first-opl1" as="a" materialize="1">
        </query>
        <!--вынесено для ускорения чтобы сначала применялось условие kod_bu_akt is not null-->
      </from>
      <where>
        <call function="and">
          <call function="between">
            <column table="a" column="ym_first_opl">
            </column>
            <useparam name="ym1">
            </useparam>
            <useparam name="ym2">
            </useparam>
          </call>
        </call>
      </where>
    </query>
    
    <query name="10653(38)-opl">
      <params>
        <param name="ym1">
          <const>2015.01</const>
        </param>
        <param name="ym2">
          <const>2015.01</const>
        </param>
      </params>
      <select>
        <column table="a" column="kod_bu_org" group="1">
        </column>
        <column table="a" column="dep" group="1">
        </column>
        <column table="b" column="opl" group="sum">
        </column>
        <column table="b" column="cust" group="sum" format="{0:n0}">
        </column>
      </select>
      <from>
        <query name="10653(52)" as="a">
        </query>
        <query name="10653(52)-ym-opl" as="b" join="inner">
          <call function="=">
            <column table="a" column="kod_bu_akt"/>
            <column table="b" column="kod_bu_akt"/>
          </call>
        </query>
      </from>
      <where>
        <call function="and">
          <call function="between">
            <column table="b" column="ym">
            </column>
            <useparam name="ym1">
            </useparam>
            <useparam name="ym2">
            </useparam>
          </call>
        </call>
      </where>
    </query>



    <query name="10653(38)-test">
      <select>
        <column table="a" column="dep_name">
        </column>
        <column table="a" column="kod_bu_akt"></column>
        <column table="a" column="ndog">
        </column>
        <column table="a" column="kod_sf"/>
        <column table="a" column="date_isp"/>
      </select>
      <from>
        <query name="hr_bu_akt" as="a">
        </query>
      </from>
     
    </query>
    
  </queries>
</root>