<root>
  <forms>
    <form name="10653(52)">
      <content>
        <field name="ym" controlType="UIComboRange" title="Период составления акта">
          <listquery>
            <query name="n_calc_dist">
            </query>
          </listquery>
          <defaultquery>
            <query name="n_calc_max">
            </query>
          </defaultquery>
        </field>
      </content>
    </form>
  </forms>
  <reports>
    <report name="10653(52)" title="Акты неучтенного потребления(старый)" form="10653(52)" folder="bu" kod-menu="12209"  visible="0" >
      <!--этот отчет не заказывали, замечания = доп. сопровождение-->
      <customers>
        <customer id="10" />
      </customers>
      <params>
        <param name="ym1"/>
        <param name="ym2"/>
      </params>
      <queries>
        <query name="10653(52)" as="a" title="По  актам">
          <columns>
            <column name="sid" type="string" into="sid" key="0" editable="0" />
            <column name="sparentid" type="string" into="sparentid" key="0" editable="0" />
            <column name="kod_bu_akt" type="number" into="n1" key="1" editable="0" />
            <column name="kod_sf" type="number" into="n2" key="0" editable="0" />
            <column name="dep" type="number" into="n3" key="0" editable="0" />
            <column name="dep_name" title="Отделение" type="string" into="s1" key="0" editable="0" />
            <column name="kod_bu_org" type="number" into="n4" key="0" editable="0" />
            <column name="bu_akt_org_name" title="Организация составившая акт" type="string" into="s2" key="0" editable="0" />
            <column name="payer_name" title="Наименование абонента" type="string" into="s3" key="0" editable="0" />
            <column name="kodp" type="number" into="n5" key="0" editable="0" />
            <column name="ndog" title="Номер договора" type="string" into="s4" key="0" editable="0" />
            <column name="num_obj" title="Номер объекта" type="number" into="n6" key="0" editable="0" />
            <column name="obj_kod_m" type="number" into="n7" key="0" editable="0" />
            <column name="obj_adr_m_name" title="Административно-территориальная единица" type="string" into="s5" key="0" editable="0" />
            <column name="obj_adr"/>
            <column name="bu_akt_dat" title="Дата акта б/п" type="date" into="d1" key="0" editable="0" />
            <column name="dat_create"/>
           
            <column name="bu_akt_num" title="Номер акта б/п " type="string" into="s6" key="0" editable="0" />
            <column name="date_isp" title="Дата признания акта б/п" type="date" into="d2" key="0" editable="0" />
            <column name="nachisl" title="Начислено (руб)" type="number" into="n8" key="0" editable="0" />
            <column name="cust"  type="number" into="n9" key="0" editable="0" />
            <column name="rym_min" title="Период потребления с" type="number" into="n10" key="0" editable="0" />
            <column name="rym_max" title="Период потребления по" type="number" into="n11" key="0" editable="0" />
            <column name="sf_name" title="Документ начисления" type="string" into="s7" key="0" editable="0" />
            <column name="sf_ym" title="Отчетный период начисления" type="number" into="n12" key="0" editable="0" />
            <column name="dat_opl_min" title="Дата первой оплаты" type="date" into="d3" key="0" editable="0" />
            <column name="dat_opl_max" title="Дата последней оплаты" type="date" into="d4" key="0" editable="0" />
            <column name="opl" title="Оплачено (руб.)" type="number" into="n13" key="0" editable="0" />
            <column name="opl_cust" type="number" into="n14" key="0" editable="0" />
            <column name="opl_do" title="Оплата до признания (руб.)" type="number" into="n15" key="0" editable="0" />
            <column name="opl_cust_do" title="Оплата до признания (нат. пок.)" type="number" into="n16" key="0" editable="0" />
            <column name="dat_saldo_bu" title="Дата возникновения сальдо" type="date" into="d5" key="0" editable="0" />
            <column name="ym_saldo_bu" title="Период возникновения сальдо" type="number" into="n17" key="0" editable="0" />
            <column name="nachisl_bu1" title="Признано на сумму (руб)" type="number" into="n19" key="0" editable="0" />
            <column name="cust_bu1"/>
            <column name="nachisl_nepr"/>
            <column name="cust_nepr"/>
            <band title="По периодам">
              <band table="b" column="ym_id">
                <band title="Признано">
                  <column table="b" name="nachisl" title="руб"/>
                  <column table="b" name="cust" title="нат. пок."/>
                </band>
                <band title="Оплачено">
                  <column table="b" name="opl" title="руб"/>
                  <column table="b" name="opl_cust" title="нат. пок."/>
                </band>
              </band>
            </band>
          </columns>
          <withparams>
            <useparam name="ym1" />
            <useparam name="ym2" />
          </withparams>
          <query name="10653(52)-ym-nachisl-opl" as="b" title="По периодам">
            <withparams>
              <useparam name="ym1" />
              <useparam name="ym2" />
            </withparams>
            <transpose>
              <dimension>
                <column column="ym_id" title="ym_name">
                </column>
              </dimension>
              <values>
                <column column="nachisl"/>
                <column column="cust"/>
                <column column="opl"/>
                <column column="opl_cust"/>
              </values>
            </transpose>
            <call function="=">
              <column table="a" column="kod_bu_akt"/>
              <column table="b" column="kod_bu_akt"/>
            </call>
          </query>
        </query>
      </queries>
    </report>


  </reports>
  <queries>


    <query name="10653(52)">
      <params>
        <param name="ym1">
          <call function="date to ym">
            <call function="nativity"/>
          </call>
        </param>
        <param name="ym2">
          <call function="date to ym">
            <call function="doomsday"/>
          </call>
        </param>
      </params>
      <select>
        <column table="a" column="kod_bu_akt"/>
        <column table="fv" column="kod_sf" dgroup="max"/>
        <column table="a" column="dep"/>
        <column table="a" column="dep_name"/>
        <column table="a" column="kod_bu_org"/>
        <column table="a" column="org_name" as="bu_akt_org_name"/>
        <column table="a" column="payer_name"/>
        <column table="a" column="kodp"/>
        <column table="a" column="ndog"/>
        <column table="a" column="num_obj"/>
        <column table="a" column="obj_kod_m"/>
        <column table="a" column="obj_adr_m_name"/>
        <column table="a" column="obj_adr"/>
        <column table="a" column="dat" as="bu_akt_dat"/>
     
        <column table="a" column="dat_create" title="Дата занесения"/>
        <column table="a" column="akt_bu_ym_create"/>
        <call function="trunc" as="akt_bu_god_create" fixed="1">
          <column table="this" column="akt_bu_ym_create"/>
        </call>
        <column table="a" column="num" as="bu_akt_num"/>
        <column table="a" column="date_isp"/>
        <call function="nvl" as="nachisl">
          <column table="acc" column="nachisl"  dgroup="sum"/>
          <column table="acc_pre" column="nachisl" as="nachisl_pre"  dgroup="sum"/>
        </call>


        <call function="nvl" as="cust">
          <column table="acc" column="cust"  dgroup="sum"/>
          <column table="acc_pre" column="cust" as="cust_pre"  dgroup="sum"/>
        </call>
        
        
        <call function="nvl" as="cust4">
          <column table="acc" column="cust4"  dgroup="sum"/>
          <column table="acc_pre" column="cust4" as="cust4_pre"  dgroup="sum"/>
        </call>
        
        
        
        <call function="nvl" as="rym_min" title="Период потребления с">
          <column table="acc" column="rym_nvl" as="rym_min" dgroup="min" />
          <column table="acc_pre" column="rym_nvl" as="rym_min_pre" dgroup="min" />
        </call>
       
        <call function="nvl" as="rym_max" title="Период потребления по">
          <column table="acc" column="rym_nvl" as="rym_max" dgroup="max" />
          <column table="acc_pre" column="rym_nvl" as="rym_max_pre" dgroup="max" />
        </call>
       
      
        <column table="fv" column="name" as="sf_name"   dgroup="max"/>
        <column table="fv" column="ym"  as="sf_ym" dgroup="max"/>
        <column table="opl" column="dat_opl" as="dat_opl_min" dgroup="min" title="Дата первой оплаты"/>
        <column table="opl" column="dat_opl"  as="dat_opl_max" dgroup="max" title="Дата последней оплаты"/>
        <column table="fopl" column="opl"  dgroup="sum"/>
        <column table="fopl" column="cust4" as="opl_cust" dgroup="sum"/>
        <column table="fopl_do" column="opl" as="opl_do"  dgroup="sum" title="Оплата до признания (руб.)"/>
        <column table="fopl_do" column="cust" as="opl_cust_do" title="Оплата до признания (нат. пок.)" dgroup="sum"/>
        <call function="earliest" as="dat_saldo_bu" title="Дата возникновения сальдо">
          <column table="opl" column="dat_opl" as="dat_opl_max" dgroup="max" />
          <column table="a" column="date_isp"/>
        </call>
        <call function="date to ym" as="ym_saldo_bu" title="Период возникновения сальдо">
          <column table="this" column="dat_saldo_bu" />
        </call>
        <call function="trunc" as="god_saldo_bu">
          <column table="this" column="ym_saldo_bu"/>
        </call>
        <call function="case" type="number" as="nachisl_bu1" title="Признано на сумму (руб)">
          <call function="when">
            <call function="is null">
              <column table="a" column="date_isp"/>
            </call>
            <column table="fopl" column="opl"  dgroup="sum"/>
          </call>
          <call function="else">
            <column table="this" column="nachisl"  dgroup="sum"/>
          </call>
        </call>
        <call function="case" type="number" as="cust_bu1" title="Признано на сумму (квтч)">
          <call function="when">
            <call function="is null">
              <column table="a" column="date_isp"/>
            </call>
            <column table="fopl" column="cust4"  dgroup="sum"/>
          </call>
          <call function="else">
            <column table="this" column="cust4"  dgroup="sum"/>
          </call>
        </call>
        <call function="-nvl" as="nachisl_nepr" title="Непризнано (руб)">
          <column table="this" column="nachisl"/>
          <column table="this" column="nachisl_bu1"/>
        </call>
        <call function="-nvl" as="cust_nepr" title="Непризнано (нат. пок.)">
          <column table="this" column="cust"/>
          <column table="this" column="cust_bu1"/>
        </call>
      </select>
      <from>
        <query name="hr_bu_akt" as="a">
          <dlink name="sr_facvip" as="fv" usenl="1">
            <dlink name="sr_opl" as="opl" usenl="1">
              <dlink name="sr_facopl" as="fopl" usenl="1">
              </dlink>
            </dlink>
            <dlink name="sr_opl" as="opl_do" usenl="1">
              <link name="v" as="fv1">
                <link name="bua" as="obu">
                </link>
              </link>
              <dlink name="sr_facopl" as="fopl_do" usenl="1">
              </dlink>
              <where>
                <call function="ls=">
                  <column table="opl_do" column="dat_oper"/>
                  <call function="nvl">
                    <column table="obu" column="date_isp"/>
                    <column table="opl_do" column="dat_oper"/>
                  </call>
                </call>
              </where>
            </dlink>
          </dlink>
          <dlink name="nr_account" as="acc_pre">
            <link name="kod_sf"/>
            <where>
              <call function="=">
                <column table="kod_sf" column="tip_bu_akt"></column>
                <const>0</const>
              </call>
            </where>
          </dlink>
          <dlink name="nr_account" as="acc">
            <link name="kod_sf"/>
            <where>
              <call function="=">
                <column table="kod_sf" column="tip_bu_akt"></column>
                <const>1</const>
              </call>
            </where>
          </dlink>
        </query>
      </from>
      <where>
        <call function="and">
          <call function="between">
            <column table="a" column="akt_bu_ym">
            </column>
            <useparam name="ym1">
            </useparam>
            <useparam name="ym2">
            </useparam>
          </call>
        </call>
      </where>
    </query>


   <!-- <query name="10653(52)-ym-prizn" as="ym">
      <withparams>
        <useparam name="ym1"/>
        <useparam name="ym2"/>
      </withparams>
    </query>-->

    <query name="10653(52)-ym-nachisl-opl">
      <params>
        <param name="ym1">
          <const>2013.01</const>
        </param>
        <param name="ym2">
          <const>2014.07</const>
        </param>
      </params>
      <select>
        <column table="ym" column="kod_bu_akt" />
        <column table="ym" column="ym" />
        <call function="*" as="ym_id">
          <column table="ym" column="ym" />
          <const>100</const>
        </call>
        <column table="ym" column="ym_name"/>
        <column table="a" column="nachisl" />
        <column table="a" column="cust" />
        <column table="b" column="opl"/>
        <column table="b" column="cust" as="opl_cust"/>
      </select>
      <from>
        <query name="10653(52)-ym-akt" as="ym">
          <withparams>
            <useparam name="ym1"/>
            <useparam name="ym2"/>
          </withparams>
        </query>
        <query name= "10653(52)-ym-nachisl" as="a" join="left outer">
          <withparams>
            <useparam name="ym1"/>
            <useparam name="ym2"/>
          </withparams>
          <call function="and">
            <call function="=">
              <column table="a" column="ym"/>
              <column table="ym" column="ym"/>
            </call>
            <call function="=">
              <column table="a" column="kod_bu_akt"/>
              <column table="ym" column="kod_bu_akt"/>
            </call>
          </call>
        </query>
        <query name= "10653(52)-ym-opl" as="b" join="left outer">
          <withparams>
            <useparam name="ym1"/>
            <useparam name="ym2"/>
          </withparams>
          <call function="and">
            <call function="=">
              <column table="b" column="ym"/>
              <column table="ym" column="ym"/>
            </call>
            <call function="=">
              <column table="b" column="kod_bu_akt"/>
              <column table="ym" column="kod_bu_akt"/>
            </call>
          </call>
        </query>
       
      </from>
    </query>

    
    <query name="10653(52)-ym-nachisl-gr">
      <params>
        <param name="ym1">
        </param>
        <param name="ym2">
        </param>
      </params>
      <select>
        <column table="a" column="kod_bu_akt" group="1" />
        <column table="a" column="nachisl" group="sum"/>
        <column table="a" column="cust" group="sum"/>
        <column table="a" column="proc" group="sum"/>
        <column table="a" column="proc_cust" group="sum"/>
        <column table="a" column="prizn" group="sum"/>
      </select>
      <from>
        <query name="10653(52)-ym-nachisl" as="a">
        </query>
      </from>
      <where>
        <call function="between">
          <column table="a" column="ym">
          </column>
          <useparam name="ym1">
          </useparam>
          <useparam name="ym2">
          </useparam>
        </call>
      </where>
    </query>
      

    <query name="10653(52)-ym-nachisl">
      <params>
        <param name="ym1">
          <call function="date to ym">
            <call function="nativity"/>
          </call>
        </param>
        <param name="ym2">
          <call function="date to ym">
            <call function="doomsday"/>
          </call>
        </param>
      </params>
      <select>
        <column table="a" column="dep" group="1" />
        <column table="a" column="kod_bu_akt" group="1" />
        <column table="a" column="ym" group="1" />
        <column table="a" column="nachisl" group="sum"/>
        <column table="a" column="cust" group="sum"/>
        <column table="a" column="proc" group="sum"/>
        <column table="a" column="proc_cust" group="sum"/>
        <column table="a" column="prizn" group="sum"/>
      </select>
      <from>
        <query as="a">
          <union>
            <query name="10653(52)-ym-priz">
              <withparams>
                <useparam name="ym1"/>
                <useparam name="ym2"/>
              </withparams>
            </query>
            <query name="10653(52)-ym-opl-priz">
              <withparams>
                <useparam name="ym1"/>
                <useparam name="ym2"/>
              </withparams>
            </query>
          </union>
        </query>
      </from>
    </query>
    
    
    <query name="10653(52)-ym-priz">
      <params>
        <param name="ym1">
          <const>2013.01</const>
        </param>
        <param name="ym2">
          <const>2014.07</const>
        </param>
      </params>
      <select>
        <column table="a" column="kod_bu_akt"/>
        <column table="a" column="dep"/>
        <call function="date to ym" as="ym" title="Период признания">
          <column table="a" column="date_isp"/>
        </call>
        <call function="-nvl" as="nachisl" title="Начислено(руб)">
          <column table="a" column="nachisl"/>
          <column table="a" column="opl_do"/>
        </call>
        <call function="-nvl" as="cust" title="Начислено(нат. пок.)">
          <column table="a" column="cust"/>
          <column table="a" column="opl_cust_do"/>
        </call>
        <call function="/nvl" as="proc">
          <column table="this" column="nachisl"/>
          <column table="a" column="nachisl"/>
        </call>
        <call function="/nvl" as="proc_cust">
          <column table="this" column="cust"/>
          <column table="a" column="cust"/>
        </call>
        <const as="prizn" type="number">1</const>
      </select>
      <from>
        <query name="10653(52)" as="a">
          <withparams>
            <useparam name="ym1"/>
            <useparam name="ym2"/>
          </withparams>
        </query>
      </from>
      <where>
 
          <call function="is not null">
            <column table="a" column="date_isp"/>
          </call>
     

        
      </where>
    </query>

    <query name="10653(52)-ym-opl-priz">
      <params>
        <param name="ym1">
          <const>2013.01</const>
        </param>
        <param name="ym2">
          <const>2014.07</const>
        </param>
      </params>
      <select>
        <column table="obu" column="kod_bu_akt"/>
        <column table="d" column="dep"/>
        <column table="a" column="ym"/>
        <column table="fopl" column="opl" as="opl" dgroup="sum"/>
        <column table="fopl" column="cust" as="cust" dgroup="sum"/>
        <call function="/nvl" as="proc">
          <column table="this" column="opl"/>
          <column table="acc" column="nachisl" dgroup="sum"/>
        </call>
        <call function="/nvl" as="proc_cust">
          <column table="this" column="cust"/>
          <column table="acc" column="cust" dgroup="sum"/>
        </call>
        <const as="prizn" type="number">0</const>
      </select>
      <from>
        <query name="sr_opl" as="a">
          <link name="v" as="fv1">
            <link name="bua" as="obu">
              <dlink name="nr_account" as="acc">
              </dlink>
            </link>
          </link>
          <dlink name="sr_facopl" as="fopl" usenl="1">
          </dlink>
          <link name="d"/>
        </query>
      </from>
      <where>
        <call function="and">
          <call function="between">
            <column table="obu" column="akt_bu_ym">
            </column>
            <useparam name="ym1">
            </useparam>
            <useparam name="ym2">
            </useparam>
          </call>
          <call function="ls=">
            <column table="a" column="dat_oper"/>
            <call function="nvl">
              <column table="obu" column="date_isp"/>
              <column table="a" column="dat_oper"/>
            </call>
          </call>
          <call function="is not null">
            <column table="fv1" column="kod_bu_akt"/>
          </call>
        </call>
      </where>
    </query>


    <query name="10653(52)-ym-opl">
      <params>
        <param name="ym1">
        </param>
        <param name="ym2">
        </param>
      </params>
      <select>
        <column table="obu" column="kod_bu_akt" group="1"/>
        <column table="a" column="ym" group="1"/>
        <column table="fopl" column="opl" as="opl" dgroup="sum" group="sum"/>
        <column table="fopl" column="cust" as="cust" dgroup="sum" group="sum"/>
      </select>
      <from>
        <query name="sr_opl" as="a">
          <link name="v" as="fv1">
            <link name="bua" as="obu">
            </link>
          </link>
          <dlink name="sr_facopl" as="fopl" usenl="1">
          </dlink>
        </query>
      </from>
      <where>
        <call function="and">
          <call function="between" optional="1">
            <column table="obu" column="akt_bu_ym">
            </column>
            <useparam name="ym1">
            </useparam>
            <useparam name="ym2">
            </useparam>
          </call>
          <call function="is not null">
            <column table="fv1" column="kod_bu_akt"/>
          </call>
        </call>
      </where>
    </query>


    <query name="10653(52)-ym-akt" >
      <params>
        <param name="ym1">
          <const>2011.01</const>
        </param>
        <param name="ym2">
          <const>2014.07</const>
        </param>
      </params>
      <select>
        <column table="a" column="ym" title="Период"/>
        <column table="a" column="ym_name" title="Период"/>
        <column table="b" column="kod_bu_akt"/>
      </select>
      <from>
        <query name="10653(52)-ym" as="a">
          <withparams>
            <useparam name="ym1"/>
            <useparam name="ym2"/>
          </withparams>
        </query>
        <query name="10653(52)" as="b" join="cross">
          <withparams>
            <useparam name="ym1"/>
            <useparam name="ym2"/>
          </withparams>
        </query>
      </from>
    </query>

    <query name="10653(52)-ym" >
      <params>
        <param name="ym1">
          <const>2011.01</const>
        </param>
        <param name="ym2">
          <const>2014.07</const>
        </param>
      </params>
      <select>
        <column table="a" column="ym" title="Период"/>
        <column table="a" column="name" as="ym_name" title="Период"/>
      </select>
      <from>
        <query name="n_calc_dist" as="a" materialize="1"/>
        <query name="10653(52)-dates" as="b" join="cross">
          <withparams>
            <useparam name="ym1"/>
            <useparam name="ym2"/>
          </withparams>
        </query>
      </from>
      <where>
        <call function="and">
          <call function="between">
            <column table="a" column="ym"/>
            <call function="date to ym">
              <column table="b" column="date1"/>
            </call>
            <call function="date to ym">
              <column table="b" column="date2"/>
            </call>
          </call>
        </call>
      </where>
    </query>
    
    <query name="10653(52)-dates">
      <params>
        <param name="ym1">
          <const>2011.01</const>
        </param>
        <param name="ym2">
          <const>2014.07</const>
        </param>
      </params>
      <select>
        <call function="earliest" as="date1" title="Дата1" group="min">
          <column table="a" column="date_isp" />
          <column table="opl" column="dat_opl" dgroup="min" as="min_dat_opl"/>
        </call>
        <call function="latest" as="date2" title="Дата2" group="max">
          <column table="a" column="date_isp"  dgroup="max" />
          <column table="opl" column="dat_opl" dgroup="max" as="min_dat_opl"/>
        </call>
      </select>
      <from>
        <query name="hr_bu_akt" as="a">
          <dlink name="sr_facvip" as="fv" usenl="1">
            <dlink name="sr_opl" as="opl" usenl="1">
            </dlink>
          </dlink>
          <dlink name="nr_account" as="acc">
          </dlink>
        </query>
      </from>
      <where>
        <call function="and">
          <call function="between">
            <column table="a" column="akt_bu_ym">
            </column>
            <useparam name="ym1">
            </useparam>
            <useparam name="ym2">
            </useparam>
          </call>
        </call>
      </where>
    </query>
  </queries>


</root>