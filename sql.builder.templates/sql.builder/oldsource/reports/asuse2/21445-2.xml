<root xmlns="sqlbuilder">
  <parts>
    <part id="21445-2-cols-for-group">
      <column table="a" column="dep">
      </column>
      <column table="a" column="vid_t_teplo">
      </column>
    </part>
    <part id="21445-2-cols-for-group-dog">
      <column table="a" column="dep">
      </column>
      <column table="a" column="nump">
      </column>
      <column table="a" column="kod_dog">
      </column>
      <column table="a" column="ndog">
      </column>
      <column table="a" column="vid_t_teplo">
      </column>
    </part>

    <part id="21445-2-cond">
      <params>
        <param name="ym"/>
      </params>
      <call function="or">
        <call function="gt">
          <column table="a" column="dog_dat_fin"/>
          <call function="ym begin time">
            <useparam name="ym" />
          </call>
        </call>
        <call function="!=">
          <column table="a" column="dog_pr_active"/>
          <const>1</const>
        </call>
      </call>
    </part>
  </parts>
  <forms>
    <form name="21445" with-behavior="0">
      <content>
        <field name="ym" controlType="UICombo" title="Период">
          <listquery>
            <query name="n_calc_dist">
            </query>
          </listquery>
          <defaultquery>
            <query name="kr_calc_max">
            </query>
          </defaultquery>
        </field>
        <field name="bankpol" controlType="UIList" title="Счет получателя оплаты">
          <properties>
            <property name="MainView.OptionsView.ShowAutoFilterRow">true</property>
            <property name="MainView.OptionsView.ColumnAutoWidth">true</property>
          </properties>
          <listquery>
            <query name="ks_bankpol%tbl">
            </query>
          </listquery>
          <return>
            <call function="in">
              <column table="a" column="kodbpol" />
              <fieldvalue />
            </call>
          </return>
        </field>
      </content>
    </form>
    <form name="21445-dog" with-behavior="0">
      <field name="ym" controlType="UICombo" title="Период">
        <listquery>
          <query name="n_calc_dist">
          </query>
        </listquery>
        <defaultquery>
          <query name="kr_calc_max">
          </query>
        </defaultquery>
      </field>
      <usefield field="asuse_kod_group_cust_parent"/>
      <usefield field="asuse_kod_group_cust"/>
    </form>
  </forms>
  <reports>
    <!-- <band table="b" column="kodbpol">
            <column table="b" name="opl" title="руб."/>
            <column table="b" name="cust" title="нат. пок."/>
          </band>-->
    <report name="21445-2" title="Оборотная ведомость по видам товара" form="21445" folder="oborot">
      <customers>
        <!--<customer id="101" />-->
      </customers>
      <params>
        <param name="ym">
        </param>
        <param name="bankpol">
        </param>
      </params>
      <columns>
        <column table="a" name="dep_name" />
        <column table="a" name="vid_t_teplo_gr_name" />
        <column table="a" name="vid_t_teplo_name" />
        <band title="Задолженность на начало периода">
          <column table="a" name="dolg_beg" title="Сумма" />
          <column table="a" name="dolg_cust_beg" title="Количество" />
        </band>
        <band title="Начислено">
          <column table="a" name="nachisl" title="Сумма" />
          <column table="a" name="cust" title="Количество" />
        </band>
        <band title="Оплачено">
          <band table="b" column="opl" title="Сумма">
            <column table="a" name="opl" title="Всего" />
          </band>
          <band table="b" column="cust" title="Количество">
            <column table="a" name="opl_cust" title="Всего" />
          </band>
        </band>
        <band title="Задолженность на конец периода">
          <column table="a" name="dolg" title="Сумма" />
          <column table="a" name="dolg_cust" title="Количество" />
        </band>
      </columns>
      <queries>
        <query name="21445-2" as="a">
          <withparams>
            <useparam name="ym">
            </useparam>
          </withparams>
          <query name="21445-2-opl" as="b">
            <withparams>
              <useparam name="ym">
              </useparam>
              <part>
                <call function="and">
                  <usepart part="1=1" />
                  <useparam name="bankpol">
                  </useparam>
                </call>
              </part>
            </withparams>
            <call function="and">
              <call function="=">
                <column table="a" column="dep">
                </column>
                <column table="b" column="dep">
                </column>
              </call>
              <call function="=">
                <column table="a" column="vid_t_teplo">
                </column>
                <column table="b" column="vid_t_teplo">
                </column>
              </call>
            </call>
            <transpose>
              <dimension>
                <column column="kodbpol" title="pol_rs_name">
                </column>
              </dimension>
              <values>
                <column column="opl">
                </column>
                <column column="cust">
                </column>
              </values>
            </transpose>
          </query>
        </query>
      </queries>
    </report>
    <report name="21445-2-dog" title="Оборотная ведомость по видам товара (детализация по договорам)" form="21445-dog"  folder="oborot">
      <customers>
        <!--<customer id="101" />-->
      </customers>
      <params>
        <param name="ym">
        </param>
        <param name="kod_group_cust_parent"/>
        <param name="kod_group_cust"/>
      </params>
      <columns>
        <column table="a" name="dep_name" />
        <column table="a" name="nump" />
        <column table="a" name="ndog" />
        <column table="a" name="name_group_cust_parent" title="Группа потребителей"/>
        <column table="a" name="name_group_cust" title="Подгруппа потребителей"/>
        <column table="a" name="pr_active_name" />
        <column table="a" name="dog_dat_fin" />
        <column table="a" name="vid_t_teplo_gr_name" />
        <column table="a" name="vid_t_teplo_name" />
        <band title="Задолженность на начало периода">
          <column table="a" name="dolg_beg" title="Сумма" />
          <column table="a" name="dolg_cust_beg" title="Количество" />
        </band>
        <band title="Начислено">
          <column table="a" name="nachisl" title="Сумма" />
          <column table="a" name="cust" title="Количество" />
        </band>
        <band title="Оплачено">
          <column table="a" name="opl" title="Сумма" />
          <column table="a" name="opl_cust" title="Количество" />
        </band>
        <band title="Задолженность на конец периода">
          <column table="a" name="dolg" title="Сумма" />
          <column table="a" name="dolg_cust" title="Количество" />
        </band>
      </columns>
      <queries>
        <query name="21445-2-dog" as="a">
          <withparams>
            <useparam name="ym"></useparam>
            <useparam name="kod_group_cust_parent"/>
            <useparam name="kod_group_cust"/>
          </withparams>
        </query>
      </queries>
    </report>
    <report name="21445-2-opl" title="Оплата по видам товара" form="21445"  folder="opl">
      <customers>
        <!--<customer id="101" />-->
      </customers>
      <params>
        <param name="ym">
        </param>
        <param name="bankpol">
        </param>
      </params>
      <columns>
        <column table="a" name="dep_name" />
        <column table="a" name="pfact_prev_name" title="Тип оплаты">
        </column>
        <column table="a" name="vid_t_teplo_gr_name" />
        <column table="a" name="vid_t_teplo_name" />
        <band table="b" column="opl" title="Оплачено (руб)">
          <column table="a" name="opl" title="Всего" />
        </band>
      </columns>
      <queries>
        <query name="21445-2-opl-full" as="a">
          <withparams>
            <useparam name="ym">
            </useparam>
          </withparams>
          <query name="21445-2-opl-full-nachisl" as="b">
            <withparams>
              <useparam name="ym">
              </useparam>
              <part>
                <call function="and">
                  <usepart part="1=1" />
                  <useparam name="bankpol">
                  </useparam>
                </call>
              </part>
            </withparams>
            <call function="and">
              <call function="=">
                <column table="a" column="dep">
                </column>
                <column table="b" column="dep">
                </column>
              </call>
              <call function="=">
                <column table="a" column="vid_t_teplo">
                </column>
                <column table="b" column="vid_t_teplo">
                </column>
              </call>
              <call function="=">
                <column table="a" column="pfact_prev">
                </column>
                <column table="b" column="pfact_prev">
                </column>
              </call>
            </call>
            <transpose>
              <dimension>
                <column column="kodbpol" title="pol_rs_name">
                </column>
              </dimension>
              <values>
                <column column="opl">
                </column>
                <column column="cust">
                </column>
              </values>
            </transpose>
          </query>
        </query>
        <query name="21445-2-opl-full-kred" as="c" union="1">
          <withparams>
            <useparam name="ym">
            </useparam>
          </withparams>
          <query name="21445-2-opl-full-kred-b" as="d">
            <withparams>
              <useparam name="ym">
              </useparam>
              <part>
                <call function="and">
                  <usepart part="1=1" />
                  <useparam name="bankpol">
                  </useparam>
                </call>
              </part>
            </withparams>
            <call function="and">
              <call function="=">
                <column table="c" column="dep">
                </column>
                <column table="d" column="dep">
                </column>
              </call>
            </call>
            <transpose>
              <dimension>
                <column column="kodbpol" title="pol_rs_name">
                </column>
              </dimension>
              <values>
                <column column="opl">
                </column>
              </values>
            </transpose>
          </query>
        </query>
      </queries>
    </report>
    <report name="21445-2-opl-kred" title="Оплата по видам товара kred" form="21445">
      <params>
        <param name="ym">
        </param>
        <param name="bankpol">
        </param>
      </params>
      <queries>
        <query name="21445-2-opl-full-kred" as="a">
          <withparams>
            <useparam name="ym">
            </useparam>
          </withparams>
          <query name="21445-2-opl-full-kred-b" as="b">
            <withparams>
              <useparam name="ym">
              </useparam>
              <part>
                <call function="and">
                  <usepart part="1=1" />
                  <useparam name="bankpol">
                  </useparam>
                </call>
              </part>
            </withparams>
            <call function="and">
              <call function="=">
                <column table="a" column="dep">
                </column>
                <column table="b" column="dep">
                </column>
              </call>
            </call>
            <transpose>
              <dimension>
                <column column="kodbpol" title="pol_rs_name">
                </column>
              </dimension>
              <values>
                <column column="opl">
                </column>
              </values>
            </transpose>
          </query>
        </query>
      </queries>
    </report>
  </reports>
  <queries>

    <query name="21445-2-dog">
      <params>
        <param name="ym">
          <const>2014.01</const>
        </param>
        <param name="kod_group_cust_parent"/>
        <param name="kod_group_cust"/>
      </params>
      <select>
        <column table="a" column="*"/>
        <column table="dog" column="dat_fin" as="dog_dat_fin" />
        <column table="dog" column="pr_active_name" />
        <column table="kod_group_cust_parent" column="name" as="name_group_cust_parent"  title="Группа потребителей"/>
        <column table="kod_group_cust" column="name" as="name_group_cust" title="Подгруппа потребителей" />
      </select>
      <from>
        <query name="21445-2"  as="a">
          <withparams>
            <useparam name="ym">
            </useparam>
            <nodes>
              <usepart part="21445-2-cols-for-group-dog" />
            </nodes>
          </withparams>
        </query>
        <query name="kr_dogovor" as="dog" join="left outer">
          <call function="=">
            <column table="a" column="kod_dog"/>
            <column table="dog" column="kod_dog"/>
          </call>
          <link name="kod_dog_dop" as="kod_dog_dop">
            <link name="kod_group_cust" as="kod_group_cust">
              <link name="kod_group_cust_parent" as="kod_group_cust_parent"/>
            </link>
          </link>
        </query>
      </from>
      <where>
        <call function="and">
          <call function="true"/>
          <call function="in" optional="1">
            <column table="kod_group_cust_parent" column="kod_group_cust" />
            <useparam name="kod_group_cust_parent" />
          </call>
          <call function="in" optional="1">
            <column table="kod_group_cust" column="kod_group_cust" />
            <useparam name="kod_group_cust" />
          </call>
        </call>
      </where>
    </query>
    
    
    <query name="21445-2" order="dep_name,vid_t_teplo_name">
      <params>
        <param name="ym">
          <const>2014.01</const>
        </param>
        <param name="cols-for-group">
          <nodes>
            <usepart part="21445-2-cols-for-group" />
          </nodes>
        </param>
      </params>
      <select>
        <column table="a" column="*">
        </column>
        <call function="-nvl" as="dolg_beg" title="Задолженность на начало периода (руб)">
          <column table="s" column="dolg">
          </column>
          <call function="-nvl">
            <column table="n" column="nachisl">
            </column>
            <column table="o" column="opl">
            </column>
          </call>
        </call>
        <call function="-nvl" as="dolg_cust_beg" title="Задолженность на начало периода (квтч)">
          <column table="s" column="dolg_cust">
          </column>
          <call function="-nvl">
            <column table="n" column="cust">
            </column>
            <column table="o" column="cust">
            </column>
          </call>
        </call>
        <column table="n" column="nachisl">
        </column>
        <column table="n" column="cust">
        </column>
        <column table="o" column="opl">
        </column>
        <column table="o" column="cust" as="opl_cust">
        </column>
        <column table="s" column="dolg" title="Задолженность на конец периода (руб)">
        </column>
        <column table="s" column="dolg_cust" title="Задолженность на конец периода (нат. пок.)">
        </column>
      </select>
      <from>
        <query name="21445-2-bb" as="a">
          <withparams>
            <useparam name="ym">
            </useparam>
            <useparam name="cols-for-group" />
          </withparams>
        </query>
        <query name="21445-2-n" as="n" join="left outer">
          <withparams>
            <useparam name="ym">
            </useparam>
            <useparam name="cols-for-group" />
          </withparams>
          <usepart part="add-join">
            <useparam name="cols-for-group" />
            <const>a</const>
            <const>n</const>
          </usepart>
        </query>
        <query name="21445-2-o" as="o" join="left outer">
          <withparams>
            <useparam name="ym">
            </useparam>
            <useparam name="cols-for-group" />
          </withparams>
          <usepart part="add-join">
            <useparam name="cols-for-group" />
            <const>a</const>
            <const>o</const>
          </usepart>
        </query>
        <query name="21445-2-s" as="s" join="left outer">
          <withparams>
            <useparam name="ym">
            </useparam>
            <useparam name="cols-for-group" />
          </withparams>
          <usepart part="add-join">
            <useparam name="cols-for-group" />
            <const>a</const>
            <const>s</const>
          </usepart>
        </query>
      </from>
      <where>
        <call function="is not null">
          <column table="a" column="vid_t_teplo_name">
          </column>
        </call>
      </where>
    </query>
    <query name="21445-2-bb">
      <params>
        <param name="ym"></param>
        <param name="cols-for-group">
        </param>
      </params>
      <select>
        <usepart part="add-cols-add-group">
          <useparam name="cols-for-group" />
          <const>a</const>
        </usepart>
        <column table="a" column="dep_name" group="max">
        </column>
        <column table="a" column="vid_t_teplo_gr_name" group="max">
        </column>
        <column table="a" column="vid_t_teplo_name" group="max">
        </column>
      </select>
      <from>
        <query name="sr_facras" as="a" />
      </from>
      <where>
        <usepart part="21445-2-cond">
            <useparam name="ym"/>
        </usepart>
      </where>
    </query>
    <query name="21445-2-o">
      <params>
        <param name="ym">
        </param>
        <param name="cols-for-group" />
      </params>
      <select>
        <usepart part="add-cols-add-group">
          <useparam name="cols-for-group" />
          <const>a</const>
        </usepart>
        <column table="a" column="opl" group="sum" />
        <column table="a" column="cust" group="sum" />
      </select>
      <from>
        <query name="sr_facopl" as="a">
        </query>
      </from>
      <where>
        <call function="and">
          <usepart part="21445-2-cond">
            <useparam name="ym"/>
          </usepart>
          <call function="=">
            <column table="a" column="ym">
            </column>
            <useparam name="ym" />
          </call>
        </call>
      </where>
    </query>
    
    <query name="21445-2-n">
      <params>
        <param name="ym">
        </param>
        <param name="cols-for-group" />
      </params>
      <select>
        <usepart part="add-cols-add-group">
          <useparam name="cols-for-group" />
          <const>a</const>
        </usepart>
        <column table="a" column="nachisl" group="sum" />
        <column table="a" column="cust" group="sum" />
      </select>
      <from>
        <query name="sr_facras" as="a">
        </query>
      </from>
      <where>
        <call function="and">
          <usepart part="21445-2-cond">
            <useparam name="ym"/>
          </usepart>
          <call function="=">
            <column table="a" column="ym">
            </column>
            <useparam name="ym">
            </useparam>
          </call>
        </call>
      </where>
    </query>
    
    <query name="21445-2-s">
      <params>
        <param name="ym">
        </param>
        <param name="cols-for-group" />
      </params>
      <select>
        <usepart part="add-cols-add-group">
          <useparam name="cols-for-group" />
          <const>a</const>
        </usepart>
        <column table="a" column="dep_name" group="max">
        </column>
        <column table="a" column="vid_t_teplo_name" group="max">
        </column>
        <column table="a" column="vid_t_teplo_gr_name" group="max">
        </column>
        <column table="a" column="dolg" group="sum" />
        <column table="a" column="dolg_cust" group="sum" />
      </select>
      <from>
        <query name="sr_facras" as="a">
          <withparams>
            <call function="ym end time">
              <useparam name="ym">
              </useparam>
            </call>
          </withparams>
        </query>
      </from>
      <where>
        <call function="and">
          <usepart part="21445-2-cond">
            <useparam name="ym"/>
          </usepart>
          <call function="ls=">
            <column table="a" column="ym">
            </column>
            <useparam name="ym" />
          </call>
        </call>
      </where>
    </query>
    
    <query name="21445-2-opl">
      <params>
        <param name="ym">
          <const>2013.03</const>
        </param>
        <param name="bankpol">
        </param>
      </params>
      <select>
        <usepart part="add-cols-add-group">
          <nodes>
            <column table="a" column="kodbpol">
            </column>
            <usepart part="21445-2-cols-for-group">
            </usepart>
          </nodes>
          <const>a</const>
        </usepart>
        <column table="a" column="pol_rs_name" group="max">
        </column>
        <column table="a" column="opl" group="sum" />
        <column table="a" column="cust" group="sum" />
      </select>
      <from>
        <query name="sr_facopl" as="a">
        </query>
      </from>
      <where>
        <call function="and">
          <call function="=">
            <column table="a" column="ym">
            </column>
            <useparam name="ym">
            </useparam>
          </call>
          <usepart part="ext-cond">
            <const>a</const>
            <useparam name="bankpol">
            </useparam>
          </usepart>
        </call>
      </where>
    </query>
    <query name="21445-2-bb-opl">
      <params>
        <param name="ym">
          <const>2013.03</const>
        </param>
      </params>
      <select>
        <usepart part="add-cols-add-group">
          <nodes>
            <usepart part="21445-2-cols-for-group">
            </usepart>
            <column table="a" column="pfact_prev">
            </column>
          </nodes>
          <const>a</const>
        </usepart>
        <column table="a" column="dep_name" group="max">
        </column>
        <column table="a" column="vid_t_teplo_gr_name" group="max">
        </column>
        <column table="a" column="vid_t_teplo_name" group="max">
        </column>
        <column table="a" column="pfact_prev_name" group="max">
        </column>
        <column table="a" column="opl" group="sum" />
      </select>
      <from>
        <query name="sr_facopl" as="a" />
      </from>
      <where>
        <call function="=">
          <column table="a" column="ym">
          </column>
          <useparam name="ym">
          </useparam>
        </call>
      </where>
    </query>
    <query name="21445-2-opl-full" order="dep_name,vid_t_teplo_name">
      <params>
        <param name="ym">
          <const>2014.01</const>
        </param>
      </params>
      <select>
        <column table="a" column="*">
        </column>
      </select>
      <from>
        <query name="21445-2-bb-opl" as="a">
          <withparams>
            <useparam name="ym" />
          </withparams>
        </query>
      </from>
      <where>
        <call function="is not null">
          <column table="a" column="vid_t_teplo_name">
          </column>
        </call>
      </where>
    </query>
    <query name="21445-2-opl-full-nachisl">
      <params>
        <param name="ym">
          <const>2013.03</const>
        </param>
        <param name="bankpol">
        </param>
      </params>
      <select>
        <usepart part="add-cols-add-group">
          <nodes>
            <column table="a" column="kodbpol">
            </column>
            <usepart part="21445-2-cols-for-group">
            </usepart>
            <column table="a" column="pfact_prev">
            </column>
          </nodes>
          <const>a</const>
        </usepart>
        <column table="a" column="pol_rs_name" group="max">
        </column>
        <column table="a" column="opl" group="sum" />
        <column table="a" column="cust" group="sum" />
      </select>
      <from>
        <query name="sr_facopl" as="a">
        </query>
      </from>
      <where>
        <call function="and">
          <call function="=">
            <column table="a" column="ym">
            </column>
            <useparam name="ym">
            </useparam>
          </call>
          <usepart part="ext-cond">
            <const>a</const>
            <useparam name="bankpol">
            </useparam>
          </usepart>
        </call>
      </where>
    </query>
    <query name="21445-2-opl-full-kred">
      <params>
        <param name="ym">
          <const>2014.01</const>
        </param>
      </params>
      <select>
        <!--<const as="vid_t_teplo" type="number">0</const>-->
        <usepart part="add-cols-add-group">
          <nodes>
            <column table="a" column="dep">
            </column>
          </nodes>
          <const>a</const>
        </usepart>
        <column table="a" column="dep_name" group="max">
        </column>
        <const as="pfact_prev_name" type="string">'Переплата/Оплата аванса переходящая на следующий месяц'</const>
        <column table="a" column="oplf" group="sum" as="opl" />
      </select>
      <from>
        <query name="sr_opl" as="a" />
      </from>
      <where>
        <call function="and">
          <call function="between">
            <column table="a" column="dat_opl">
            </column>
            <call function="ym begin time">
              <useparam name="ym">
              </useparam>
            </call>
            <call function="ym end time">
              <useparam name="ym">
              </useparam>
            </call>
          </call>
          <call function="=">
            <column table="a" column="ym">
            </column>
            <useparam name="ym">
            </useparam>
          </call>
          <call function="in">
            <column table="a" column="kod_type_opl">
            </column>
            <call function="array">
              <const>1</const>
              <const>2</const>
              <const>5</const>
              <const>6</const>
            </call>
          </call>
        </call>
      </where>
    </query>
    <query name="21445-2-opl-full-kred-b">
      <params>
        <param name="ym">
          <const>2014.01</const>
        </param>
      </params>
      <select>
        <usepart part="add-cols-add-group">
          <nodes>
            <column table="a" column="kodbpol">
            </column>
            <column table="a" column="dep">
            </column>
          </nodes>
          <const>a</const>
        </usepart>
        <column table="a" column="pol_rs_name" group="max">
        </column>
        <column table="a" column="oplf" group="sum" as="opl" />
      </select>
      <from>
        <query name="sr_opl" as="a" />
      </from>
      <where>
        <call function="and">
          <call function="between">
            <column table="a" column="dat_opl">
            </column>
            <call function="ym begin time">
              <useparam name="ym">
              </useparam>
            </call>
            <call function="ym end time">
              <useparam name="ym">
              </useparam>
            </call>
          </call>
          <call function="=">
            <column table="a" column="ym">
            </column>
            <useparam name="ym">
            </useparam>
          </call>
          <call function="in">
            <column table="a" column="kod_type_opl">
            </column>
            <call function="array">
              <const>1</const>
              <const>2</const>
              <const>5</const>
              <const>6</const>
            </call>
          </call>
        </call>
      </where>
    </query>
  </queries>
</root>