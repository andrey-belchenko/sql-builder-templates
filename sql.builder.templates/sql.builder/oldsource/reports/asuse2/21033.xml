<root>
  <forms>
    <form name="21033">
      <content>
        <field name="ym" controlType="UIControlCombo" title="Отчетный период">
          <listquery>
            <query name="n_calc_dist">
            </query>
          </listquery>
          <defaultquery>
            <query name="kr_calc_max">
            </query>
          </defaultquery>
        </field>
        <field name="date" controlType="UIControlDate" title="Дата" valuequery="ym-end-date">
          <return>
            <call function="date">
              <fieldvalue />
            </call>
          </return>
        </field>
        
        
        <field name="dep" controlType="UIControlList" title="Отделение">
          <properties>
            <property name="MainView.OptionsView.ColumnAutoWidth">true</property>
            <property name="MainView.OptionsView.ShowColumnHeaders">false</property>
          </properties>
          <listquery>
            <query name="kr_org_dep%tbl">
            </query>
          </listquery>
          <return>
            <call function="in">
              <column table="a" column="dep" />
              <call function="array">
                <fieldvalue />
              </call>
            </call>
          </return>
        </field>
      </content>
    </form>
  </forms>
  <reports>
    <report name="21033-rep" title="Сомнительная задолженность (Ведомость,Акт)1" form="21033"  folder="somn_dolg">
      <customers>
        <!--<customer id="101" />-->
      </customers>
      <print-templates>
        <excel>
          <template name="21033-ved.xml" title="Ведомость" />
        </excel>
        <excel>
          <template name="21033-akt.xml" title="Акт" />
        </excel>
      </print-templates>
      <params>
        <param name="date">
        </param>
        <param name="ym">
        </param>
      </params>
      <queries>
        <query name="21033" as="a" >
          <withparams>
            <useparam name="date">
            </useparam>
          </withparams>
        </query>
        <query name="21033-title-dog" as="b" union="0" >
          <withparams>
            <useparam name="date">
            </useparam>
            <useparam name="ym">
            </useparam>
          </withparams>
        </query>
      </queries>
    </report>
    <report name="21033-dog-rep" title="Сомнительная задолженность (Справка)1" form="21033" folder="somn_dolg">
      <columns>
        <column table="a" name="rwn" />
        <column table="a" name="dep_name" />
        <column table="a" name="nump" />
        <column table="a" name="inn_kpp" type="string" title="ИНН/КПП контрагента" />
        <column table="a" name="payer_name" title="Наименование контрагента" />
        <column table="a" name="dolg" title="Сумма, включаемая в Резерв" />
        <column table="a" name="ostatok_full" title="Остаток(руб)" />
        <band title="Изменение величины резерва по сомнительным долгам в целях бухгалтерсокго учета">
          <band title="Отчисления в резерв">
            <column table="a" name="nachisl" title="за отчетный месяц" />
            <column table="a" name="nachisl_god" title="с начала года" />
          </band>
          <band title="Погашение, восстановление резерва">
            <column table="a" name="opl" title="за отчетный месяц" />
            <column table="a" name="opl_god" title="с начала года" />
          </band>
          <band title="Списание за счет резерва">
            <column table="a" name="spis" title="за отчетный месяц" />
            <column table="a" name="spis_god" title="с начала года" />
          </band>
        </band>
      </columns>
      <customers>
        <!--<customer id="101" />-->
      </customers>
      <print-templates>
        <excel>
          <template name="21033-spravka.xml" title="Справка" />
        </excel>
      </print-templates>
      <params>
        <param name="date">
        </param>
        <param name="ym">
        </param>
        <param name="dep">
        </param>
      </params>
      <queries>
        <query name="21033-dog" as="a">
          <withparams>
            <useparam name="date">
            </useparam>
            <useparam name="ym">
            </useparam>
            <part>
              <useparam name="dep">
              </useparam>
            </part>
          </withparams>
        </query>
        <query name="21033-title-dog" as="b" union="0">
          <withparams>
            <useparam name="date">
            </useparam>
            <useparam name="ym">
            </useparam>
            <part>
              <useparam name="dep">
              </useparam>
            </part>
          </withparams>
        </query>
      </queries>
    </report>
  </reports>
  <queries>

    <query name="ym-end-date">
      <params>
        <param name="ym" type="number"/>
      </params>
      <select>
        <call function="ym next day" as="dat">
          <useparam name="ym"/>
        </call>
      </select>
      <from>
        <table name="dual" as="a"/>
      </from>
    </query>




    <query name="21033-title-dog">
      <params>
        <param name="date">
          <call function="date">
            <const>'01.02.2014'</const>
          </call>
        </param>
        <param name="ym">
          <const>2014.01</const>
        </param>
        <param name="cond">
          <undefined />
        </param>
      </params>
      <select>
        <const as="id" group="1" type="number">1</const>
        <call function="" as="dat" type="date" title="Дата формирования">
          <useparam name="date" />
        </call>
        <call function="" as="ym" type="number" title="Отчетный период">
          <useparam name="ym" />
        </call>
        <column table="a" column="dep_name" group="stragg_dist">
        </column>
        <column table="a" column="dolg" group="sumnvl">
        </column>
        <column table="a" column="nachisl" group="sumnvl">
        </column>
        <column table="a" column="opl" group="sumnvl">
        </column>
        <column table="a" column="nachisl_god" group="sumnvl">
        </column>
        <column table="a" column="opl_god" group="sumnvl">
        </column>
        <column table="a" column="spis" group="sumnvl">
        </column>
        <column table="a" column="spis_god" group="sumnvl">
        </column>
      </select>
      <from>
        <query name="21033-dog" as="a">
          <withparams>
            <useparam name="date">
            </useparam>
            <useparam name="ym">
            </useparam>
          </withparams>
        </query>
      </from>
      <where>
        <call function="and">
          <usepart part="1=1" />
          <usepart part="ext-cond">
            <const>a</const>
            <useparam name="cond">
            </useparam>
          </usepart>
        </call>
      </where>
    </query>
    <query name="21033">
      <params>
        <param name="date">
          <call function="date">
            <const>'01.03.2014'</const>
          </call>
        </param>
      </params>
      <select>
        <column column="rownum" as="rwn" type="number" title="№ пп">
        </column>

        <column table="a" column="kod_sf">
        </column>
        <call function="||" as="inn_kpp">
          <column table="a" column="inn">
          </column>
          <const>' / '</const>
          <column table="a" column="kpp">
          </column>
        </call>
        <column table="a" column="payer_name">
        </column>
        <column table="a" column="dep" />
        <column table="a" column="dep_name">
        </column>
        <column table="a" column="kodp">
        </column>
        <column table="a" column="nump">
        </column>
        <column table="a" column="dog_name">
        </column>
        <column table="a" column="name">
        </column>
        <column table="a" column="nachisl">
        </column>
        <column table="a" column="dat_sf" title="Дата возникновения задолженности">
        </column>
        <column table="a" column="dat_bzad_nvl">
        </column>
        <column table="a" column="days_dolg">
        </column>
        <call function="if" as="dolg" type="number">
          <call function="ls=">
            <column table="a" column="dat_sf" />
            <useparam name="date"/>
          </call>
          <call function="+nvl">
            <column table="a" column="dolg"/>
            <column table="a" column="nachisl_recalc_neg"/>
          </call>
          <const>0</const>
        </call>
        
        <column table="a" column="nachisl_recalc_neg">
        </column>
        <column table="a" column="opl">
        </column>
        <column table="a" column="days_dolg_diap">
        </column>
        <column table="a" column="vid_t_teplo_gr_name">
        </column>
        <call function="case" as="reserv" type="number" title="Сумма, включаемая в резерв">
          <call function="when">
            <call function="gt=">
              <column table="a" column="days_dolg"/>
              <const>90</const>
            </call>
            <column table="this" column="dolg"/>
          </call>
          <call function="when">
            <call function="gt=">
              <column table="a" column="days_dolg"/>
              <const>45</const>
            </call>
            <call function="/">
              <column table="this" column="dolg"/>
              <const>2</const>
            </call>
          </call>
        </call>
        <column table="a" column="kred_dolg">
        </column>
      </select>
      <from>
        <query name="sr_facvip" as="a">
          <withparams>
            <useparam name="date">
            </useparam>
          </withparams>
        </query>
      </from>
      <where>
        <call function="and">
          <call function="=">
            <column table="a" column="vid_real">
            </column>
            <const>2</const>
          </call>
          <call function="=">
            <column table="a" column="tep_el">
            </column>
            <const>2</const>
          </call>
          <call function="gt=">
            <call function="nvl">
              <column table="a" column="dog_dat_fin">
              </column>
              <useparam name="date">
              </useparam>
            </call>
            <useparam name="date">
            </useparam>
          </call>
          <call function="!=">
            <call function="nvl">
              <column table="a" column="deb_dolg">
              </column>
              <column table="a" column="dolg">
              </column>
            </call>
            <const>0</const>
          </call>
          <call function="!=nvl">
            <column table="a" column="dolg">
            </column>
            <const>0</const>
          </call>
          <call function="or">
            <call function="is null">
              <column table="a" column="fk_rym"/>
            </call>
            <call function="gt">
              <column table="a" column="nachisl">
              </column>
              <const>0</const>
            </call>
          </call>
  
          <!--<call function="=">
            <column table="a" column="kodp"/>

            <const>4159</const>
          </call>-->
        
          <!--<call function="ls">
            <column column="rownum"></column>
            <const>10</const>
          </call>-->
          <!--<call function="is not null">
            <column table="a" column="days_dolg_diap"></column>
          </call>-->
        </call>
      </where>
    </query>


    
    <query name="21033-dog">
      <params>
        <param name="date">
          <call function="date">
            <const>'01.03.2014'</const>
          </call>
        </param>
        <param name="ym">
          <const>2014.02</const>
        </param>
        <param name="cond">
          <undefined />
        </param>
      </params>
      <select>
        <column column="rownum" as="rwn" type="number" title="№ пп">
        </column>
        <column table="a" column="*">
        </column>
        <column table="n" column="nachisl">
        </column>
        <column table="o" column="opl">
        </column>
        <column table="ny" column="nachisl" as="nachisl_god">
        </column>
        <column table="oy" column="opl" as="opl_god">
        </column>
        <const as="spis" type="number">null</const>
        <const as="spis_god" type="number">null</const>
      </select>
      <from>
        <query name="21033-dog-dolg" as="a">
          <withparams>
            <useparam name="date">
            </useparam>
            <useparam name="ym">
            </useparam>
          </withparams>
        </query>
        <query name="21033-dog-nachisl-ym" as="n" join="left outer">
          <withparams>
            <useparam name="date">
            </useparam>
            <useparam name="ym">
            </useparam>
          </withparams>
          <call function="=">
            <column table="a" column="kodp" />
            <column table="n" column="kodp" />
          </call>
        </query>
        <query name="21033-dog-opl-ym" as="o" join="left outer">
          <withparams>
            <useparam name="date">
            </useparam>
            <useparam name="ym">
            </useparam>
          </withparams>
          <call function="=">
            <column table="a" column="kodp" />
            <column table="o" column="kodp" />
          </call>
        </query>
        <query name="21033-dog-nachisl-year" as="ny" join="left outer">
          <withparams>
            <useparam name="date">
            </useparam>
            <useparam name="ym">
            </useparam>
          </withparams>
          <call function="=">
            <column table="a" column="kodp" />
            <column table="ny" column="kodp" />
          </call>
        </query>
        <query name="21033-dog-opl-year" as="oy" join="left outer">
          <withparams>
            <useparam name="date">
            </useparam>
            <useparam name="ym">
            </useparam>
          </withparams>
          <call function="=">
            <column table="a" column="kodp" />
            <column table="oy" column="kodp" />
          </call>
        </query>
      </from>
      <where>
        <call function="and">
          <usepart part="1=1" />
          <usepart part="ext-cond">
            <const>a</const>
            <useparam name="cond">
            </useparam>
          </usepart>
        </call>
      </where>
    </query>
    <query name="21033-dog-dolg">
      <params>
        <param name="date">
          <call function="date">
            <const>'04.03.2014'</const>
          </call>
        </param>
        <param name="ym">
          <const>2014.02</const>
        </param>
      </params>
      <select>
        <column table="a" column="dep_name" group="max">
        </column>
        <column table="a" column="dep" group="max">
        </column>
        <column table="a" column="kodp" group="1">
        </column>
        <column table="a" column="nump" group="max">
        </column>
        <column table="a" column="inn_kpp" group="max">
        </column>
        <column table="a" column="payer_name" group="max">
        </column>
        <column table="a" column="dolg" as="ostatok_full" group="sum"/>
 

        <call function="if" as="dolg" type="number" group="sum">
          <call function="gt">
            <column table="a" column="days_dolg" />
            <const>0</const>
          </call>
          <column table="a" column="dolg"/>
          <const>0</const>
        </call>
      </select>
      <from>
        <query name="21033" as="a">
          <withparams>
            <useparam name="date">
            </useparam>
          </withparams>
        </query>
      </from>
    </query>
    
    <query name="21033-dog-nachisl-ym">
      <params>
        <param name="date">
          <call function="date">
            <const>'04.03.2014'</const>
          </call>
        </param>
        <param name="ym">
          <const>2014.02</const>
        </param>
      </params>
      <select>
        <column table="a" column="kodp" group="1">
        </column>
        <column table="a" column="nachisl" group="sum">
        </column>
      </select>
      <from>
        <query name="sr_facvip" as="a">
        </query>
      </from>
      <where>
        <call function="and">
          <call function="=">
            <column table="a" column="vid_real">
            </column>
            <const>2</const>
          </call>
          <call function="=">
            <column table="a" column="ym">
            </column>
            <useparam name="ym"/>
          </call>
          <!--<call function="between">
            <column table="a" column="dat_bzad_nvl">
            </column>
            <call function="ym begin time">
              <useparam name="ym">
              </useparam>
            </call>
            <call function="ym end time">
              <useparam name="ym">
              </useparam>
            </call>
          </call>-->
        </call>
      </where>
    </query>
    
    <query name="21033-dog-nachisl-year">
      <params>
        <param name="date">
          <call function="date">
            <const>'04.03.2014'</const>
          </call>
        </param>
        <param name="ym">
          <const>2014.02</const>
        </param>
      </params>
      <select>
        <column table="a" column="kodp" group="1">
        </column>
        <column table="a" column="nachisl" group="sum">
        </column>
      </select>
      <from>
        <query name="sr_facvip" as="a">
        </query>
      </from>
      <where>
        <call function="and">
          <call function="=">
            <column table="a" column="vid_real">
            </column>
            <const>2</const>
          </call>
          <call function="between">
            <call function="ym end time">
              <column table="a" column="ym"/>
            </call>
            <call function="year begin time">
              <call function="trunc">
                <useparam name="ym"/>
              </call>
            </call>
            <call function="ym end time">
              <useparam name="ym"/>
            </call>
          </call>
          <!--<call function="between">
            <column table="a" column="dat_bzad_nvl">
            </column>
            <call function="year begin time">
              <call function="trunc">
                <useparam name="ym">
                </useparam>
              </call>
            </call>
            <call function="ym end time">
              <useparam name="ym">
              </useparam>
            </call>
          </call>-->
        </call>
      </where>
    </query>
    
    <query name="21033-dog-opl-ym">
      <params>
        <param name="date">
          <call function="date">
            <const>'04.03.2014'</const>
          </call>
        </param>
        <param name="ym">
          <const>2014.02</const>
        </param>
      </params>
      <select>
        <column table="a" column="kodp" group="1">
        </column>
        <column table="a" column="opl" group="sum">
        </column>
      </select>
      <from>
        <query name="sr_opl" as="a">
        </query>
      </from>
      <where>
        <call function="and">
          <call function="=">
            <column table="a" column="vid_real">
            </column>
            <const>2</const>
          </call>
          <!--<call function="ls=">
            <column table="a" column="dat_bzad_nvl">
            </column>
            <call function="ym end time">
              <useparam name="ym">
              </useparam>
            </call>
          </call>-->
          <call function="=">
            <column table="a" column="ym">
            </column>
            <useparam name="ym">
            </useparam>
          </call>
        </call>
      </where>
    </query>
    
    <query name="21033-dog-opl-year">
      <params>
        <param name="date">
          <call function="date">
            <const>'04.03.2014'</const>
          </call>
        </param>
        <param name="ym">
          <const>2014.02</const>
        </param>
      </params>
      <select>
        <column table="a" column="kodp" group="1">
        </column>
        <column table="a" column="opl" group="sum">
        </column>
      </select>
      <from>
        <query name="sr_opl" as="a">
        </query>
      </from>
      <where>
        <call function="and">
          <call function="=">
            <column table="a" column="vid_real">
            </column>
            <const>2</const>
          </call>
          <!--<call function="ls=">
            <column table="a" column="dat_bzad_nvl">
            </column>
            <call function="ym end time">
              <useparam name="ym">
              </useparam>
            </call>
          </call>-->
          <call function="=">
            <call function="trunc">
              <column table="a" column="ym">
              </column>
            </call>
            <call function="trunc">
              <useparam name="ym">
              </useparam>
            </call>
          </call>
        </call>
      </where>
    </query>
    

  </queries>
</root>