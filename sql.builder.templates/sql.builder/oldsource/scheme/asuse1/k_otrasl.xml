<root>
  <queries>
    <query name="k_otrasl">
      <select>
        <column table="a" column="kod_otrasl" type="number">
        </column>
        <column table="a" column="name" type="string">
        </column>
        <column table="fi" column="full_name" as="fl_full_name" title="Отрасль">
        </column>
        <call function="||" as="full_name" title="Подотрасль">
          <column table="a" column="okonh">
          </column>
          <const>' '</const>
          <column table="a" column="name">
          </column>
        </call>
      </select>
      <from>
        <table name="k_otrasl" as="a">
        </table>
        <query name="k_otrasl_first" as="f" view="1" join="left outer">
          <call function="=">
            <column table="a" column="kod_otrasl">
            </column>
            <column table="f" column="kod_otrasl">
            </column>
          </call>
        </query>
        <query name="k_otrasl" as="fi" join="left outer">
          <call function="=">
            <column table="f" column="first_level">
            </column>
            <column table="fi" column="kod_otrasl">
            </column>
          </call>
        </query>
      </from>
    </query>
    <query name="k_otrasl_first">
      <select>
        <column table="a" column="kod_otrasl" type="number">
        </column>
        <column table="a" column="first_level" type="number">
        </column>
      </select>
      <from>
        <table name="k_otrasl_first" as="a" view="1">
        </table>
      </from>
    </query>
  </queries>
  <views>
    <view name="k_otrasl_first">
      select
      KOD_OTRASL,
      nvl( first_level,KOD_OTRASL) first_level
      from
      (
      select
      (select kod_otrasl from k_otrasl b where level=a.maxl-1 connect by  b.kod_otrasl=prior b.parent start with b.kod_otrasl =a.kod_otrasl ) first_level,
      a.KOD_OTRASL from
      (
      select
      (select max(level) from k_otrasl b connect by  b.kod_otrasl=prior b.parent start with b.kod_otrasl =a.kod_otrasl ) maxl,
      a.KOD_OTRASL
      from k_otrasl a
      ) a
      ) where first_level is not null
    </view>
  </views>
</root>