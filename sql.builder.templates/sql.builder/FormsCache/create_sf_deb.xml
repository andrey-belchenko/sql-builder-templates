<?xml version="1.0" encoding="utf-8"?>
<root>
  <form name="create_sf_deb" timestamp="28.12.2023 14:42:13" title="Создание документа на оплату" with-behavior="0" form-size="497;185" file="sql.builder.templates\sql.builder\projects\asuse2\reports\arbitrage\forms\create_ur_deb.xml" elid="155" ord="155" leaf="0" lvl="2" pelid="">
    <fieldgroup title="Создание документа на оплату" noborder="1" id="23901211">
      <field id="5156486" controlType="UIDate" type="date" elid="388" ord="388" leaf="1" lvl="2" pelid="" column-mandatory="1" title="Дата документа" name="dat_deb" show-checkbox="0" default="dat_sf" />
      <field id="4858312" controlType="UICheck" checked="1" type="number" elid="387" ord="387" leaf="1" lvl="2" pelid="" title="Автоматически генерировать номер" name="auto_num" show-checkbox="0" />
      <field id="56163985" controlType="UIText" type="string" elid="389" ord="389" leaf="1" lvl="2" pelid="" name="num" title="Номер документа" mandatory="auto_num" show-checkbox="0" mandatory-invert="1" visible="auto_num" visible-invert="1" />
    </fieldgroup>
    <empty-item id="58804650" />
    <label id="29638753" />
    <uicommand title="Создать платёжный документ и привязать счёт" action-type="custom" editable="is_form_valid" id="17265959">
      <useaction name="sg_dop_plat.form_dop_deb" editable="can_create_sf" width-perc="50" id="45040040">
        <useparam name="kod_sf" id="27350048" />
        <useparam name="auto_num" id="40266432" />
        <useparam name="num" id="53746128" />
        <useparam name="dat_deb" id="29972526" />
      </useaction>
      <useaction action-type="close" id="38311922" />
    </uicommand>
  </form>
  <params>
    <param name="kod_sf" type="number" />
    <param name="dat_sf" type="date" />
  </params>
  <dataset>
    <params>
      <param name="kod_sf" type="number" />
      <param name="dat_sf" type="date" />
    </params>
    <fields>
      <field type="date" name="dat_deb" parname="dat_deb" title="Дата документа" ColumnMandatory="1" ClientDefault="dat_sf" />
      <field type="number" name="auto_num" parname="auto_num" title="Автоматически генерировать номер" />
      <field type="string" name="num" parname="num" title="Номер документа" MandatoryInvert="1" ClientMandatory="auto_num" VisibleInvert="1" ClientVisible="auto_num" />
      <field type="string" name="is_form_valid" parname="is_form_valid" />
      <field type="string" name="is_form_valid_not" parname="is_form_valid_not" />
      <field type="string" name="a_has_changes" parname="a_has_changes" />
    </fields>
    <table name="a" auto-refresh="" async="" only-visible-refresh="" only-force-refresh="" ref-column="" multi-select-column="" multi-select-target="" update-target="sr_facvip" key="kod_sf" is-ms-upd="1" is-top="1" key-dimension="kod_sf">
      <select-text>
--
select a.is_new as is_new, /*number*/
a.is_not_new as is_not_new, /*number*/
a.kod_sf as kod_sf/*number*//*key*/

from (
--sr_facvip
select a.kod_sf as kod_sf, /*number*//*key*/
0 as is_new, /*number*/
1 as is_not_new/*number*/

from sr_facvip
a
--\sr_facvip
where
a.vid_sf not in (2 , 9) )
a
--\sr_facvip
where
a.kod_sf = :kod_sf --\
</select-text>
      <columns>
        <column name="is_new" table="a" type="number" title="" is-user-editable="1" />
        <column name="is_not_new" table="a" type="number" title="" is-user-editable="1" />
        <column name="kod_sf" table="a" type="number" title="" is-user-editable="1" is-updateable="1" is-updateable-ext="1" update-target="kod_sf" temp-col-name="n1" />
      </columns>
      <insert-text>begin 
for r in  
 ( select  
:kod_sf as kod_sf 
 
from dual ) 
 
loop 
insert into sr_facvip 
(kod_sf 
) 
 values  
(r.kod_sf 
) 
 returning  
kod_sf into :kod_sf; 
end loop; 
end; 
</insert-text>
      <delete-text>delete from sr_facvip where kod_sf=:kod_sf</delete-text>
      <update-temp-text>begin 
delete from rr_temp 
where 
skod='a' 
and 
names=:form_id 
and 
f2=:kod_sf; 
if :row_state_id=1  then 
for r in  
 ( select  
:kod_sf as kod_sf 
 
from dual ) 
 
loop 
insert into rr_temp 
(skod 
,names 
,f2 
,f3 
,n1 
) 
 values  
('a' 
,:form_id 
,:kod_sf 
,:row_state_id 
,r.kod_sf 
); 
end loop; 
else 
for r in  
 ( select  
:kod_sf as kod_sf 
,a.tep_el 
,a.kod_deb 
,a.kodp 
,a.kod_dog 
,a.vid_real 
,a.vid_sf 
,a.vid_pl 
,a.num_sf 
,a.dat_sf 
,a.ym 
,a.dat_priem 
,a.pr_old 
,a.pr_sv 
,a.pr_osn 
,a.gru_pl 
,a.den 
,a.kod_dog_r 
,a.dat_uchet 
,a.dat_ezad 
,a.vist_day 
,a.num_sf_uch 
,a.ym_uch 
,a.d_m 
,a.u_m 
,a.pr_hand 
,a.vid_avans 
,a.prim_uo 
,a.kod_sf_old 
,a.kodp_plat 
,a.kod_sf_konsol 
,a.vid_recalc 
,a.kod_dog_link 
,a.pr_uch_av 
,a.kod_bu_akt 
,a.kod_sf_first 
,a.tip_bu_akt 
,a.kniga 
,a.dat_pen_ezad 
,a.dat_zadol 
,a.nom_sf 
,a.proc 
 
from sr_facvip a  where kod_sf=:kod_sf) 
 
loop 
insert into rr_temp 
(skod 
,names 
,f2 
,f3 
,n1 
,n2 
,n3 
,n4 
,n5 
,n6 
,n7 
,n8 
,n9 
,d1 
,n10 
,d2 
,n11 
,n12 
,n13 
,n14 
,n15 
,n16 
,d3 
,d4 
,n17 
,n18 
,n19 
,d5 
,s1 
,n20 
,n21 
,s2 
,n22 
,n23 
,n24 
,n25 
,n26 
,n27 
,n28 
,n29 
,n30 
,n31 
,d6 
,d7 
,s3 
,n32 
) 
 values  
('a' 
,:form_id 
,:kod_sf 
,:row_state_id 
,r.kod_sf 
,r.tep_el 
,r.kod_deb 
,r.kodp 
,r.kod_dog 
,r.vid_real 
,r.vid_sf 
,r.vid_pl 
,r.num_sf 
,r.dat_sf 
,r.ym 
,r.dat_priem 
,r.pr_old 
,r.pr_sv 
,r.pr_osn 
,r.gru_pl 
,r.den 
,r.kod_dog_r 
,r.dat_uchet 
,r.dat_ezad 
,r.vist_day 
,r.num_sf_uch 
,r.ym_uch 
,r.d_m 
,r.u_m 
,r.pr_hand 
,r.vid_avans 
,r.prim_uo 
,r.kod_sf_old 
,r.kodp_plat 
,r.kod_sf_konsol 
,r.vid_recalc 
,r.kod_dog_link 
,r.pr_uch_av 
,r.kod_bu_akt 
,r.kod_sf_first 
,r.tip_bu_akt 
,r.kniga 
,r.dat_pen_ezad 
,r.dat_zadol 
,r.nom_sf 
,r.proc 
); 
end loop; 
end if; 
end; 
</update-temp-text>
      <clear-temp-text>delete from rr_temp where skod='a' and names=:form_id</clear-temp-text>
      <update-text>begin
update sr_facvip set  
(kod_sf 
) 
= 
 ( select  
:kod_sf as kod_sf 
 
from dual ) 
 
where 
kod_sf=:kod_sf 
;
end;
</update-text>
      <scheme>
        <table name="sr_facvip" as="a">
          <columns>
            <column name="is_new" type="number" invisible-in-column-chooser="1" visible="0" />
            <column name="is_not_new" type="number" invisible-in-column-chooser="1" visible="0" />
            <column name="kod_sf" type="number" invisible-in-column-chooser="1" visible="0" />
          </columns>
          <viewcolumns />
        </table>
      </scheme>
      <single-row-refresh-cmd>
        <root>
          <params>
            <param name="kod_sf_prm" type="number" column="" />
            <param name="form_id" type="number" column="" />
          </params>
          <select>
            <params>
              <param name="kod_sf_prm" type="number" column="" />
              <param name="form_id" type="number" column="" />
            </params>
            <query>
--
select a.is_new as is_new, /*number*/
a.is_not_new as is_not_new, /*number*/
a.kod_sf as kod_sf/*number*//*key*/

from (
--sr_facvip
select a.kod_sf as kod_sf, /*number*//*key*/
a.is_new as is_new, /*number*/
a.is_not_new as is_not_new/*number*/

from (select a.kod_sf as kod_sf,0 as is_new,1 as is_not_new,a.vid_sf as vid_sf  from sr_facvip a where not exists (select * from rr_temp t where t.skod ='a' and t.names=:form_id  and a.kod_sf=t.f2 ) and   a.kod_sf in :kod_sf_prm   union all  select t.n1 as kod_sf,decode (f3,1,1,0) as is_new,decode (f3,1,0,1) as is_not_new,t.n7 as vid_sf  from rr_temp t where t.skod ='a' and t.names=:form_id  and t.f3!=3  and t.f2 in :kod_sf_prm )
a
--\(select a.kod_sf as kod_sf,0 as is_new,1 as is_not_new,a.vid_sf as vid_sf  from sr_facvip a where not exists (select * from rr_temp t where t.skod ='a' and t.names=:form_id  and a.kod_sf=t.f2 ) and   a.kod_sf in :kod_sf_prm   union all  select t.n1 as kod_sf,decode (f3,1,1,0) as is_new,decode (f3,1,0,1) as is_not_new,t.n7 as vid_sf  from rr_temp t where t.skod ='a' and t.names=:form_id  and t.f3!=3  and t.f2 in :kod_sf_prm )
where
a.vid_sf not in (2 , 9) )
a
--\sr_facvip
--\
</query>
          </select>
          <procedure>
            <params />
          </procedure>
        </root>
      </single-row-refresh-cmd>
    </table>
  </dataset>
</root>