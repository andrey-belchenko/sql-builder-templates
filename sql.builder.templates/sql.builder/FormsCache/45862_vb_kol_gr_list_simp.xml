<?xml version="1.0" encoding="utf-8"?>
<root>
  <form name="45862_vb_kol_gr_list_simp" timestamp="28.12.2023 14:39:05" title="1. Формирование Кольцевых групп" file="sql.builder.templates\sql.builder\projects\45862\form\forms.xml" elid="65" ord="65" leaf="0" lvl="2" pelid="">
    <field id="38258317" name="ym" controlType="UICombo" type="number" title="Период" mandatory="1" elid="533" ord="533" leaf="0" lvl="2" pelid="" column-mandatory="1" show-checkbox="0">
      <listquery>
        <query name="kr_calc_list"></query>
      </listquery>
      <defaultquery>
        <query name="kr_calc_max"></query>
      </defaultquery>
    </field>
    <field id="14424911" controlType="UICombo" type="number" elid="399" ord="399" leaf="1" lvl="2" pelid="" title="Филиал" name="kod_fl" column-mandatory="1" show-checkbox="0">
      <listquery>
        <query name="jv_rep_cons_d_fl" />
      </listquery>
    </field>
    <field id="26322813" controlType="UITextEx" type="string" elid="392" ord="392" leaf="1" lvl="2" pelid="" name="init_dummy" show-checkbox="0" column-visible="0">
      <defaultquery>
        <query name="45862_init_filial" />
      </defaultquery>
    </field>
    <field id="52931851" controlType="UITextEx" type="string" elid="392" ord="392" leaf="1" lvl="2" pelid="" name="ym_editable" show-checkbox="0" column-visible="0">
      <defaultquery>
        <query name="45862_ym_editable">
          <withparams>
            <useparam name="ym" />
            <useparam name="kod_fl" />
          </withparams>
        </query>
      </defaultquery>
    </field>
    <field id="53924692" controlType="UITextEx" type="string" elid="392" ord="392" leaf="1" lvl="2" pelid="" name="kg_add_allow_flag" show-checkbox="0" column-visible="0">
      <defaultquery>
        <query name="45862_kg_add_allow_flag">
          <withparams>
            <useparam name="ym" />
            <useparam name="kod_fl" />
          </withparams>
        </query>
      </defaultquery>
    </field>
    <grid table="gn" show-toolbar="1" auto-filter="1" id="18810841">
      <toolbar id="32708565">
        <uicommand button-type="grid-save" column-visible="0" name="grid-save" control-name="ButtonCommit" file="sql.builder.templates\sql.builder\projects\common\main.xml" elid="365" ord="365" leaf="1" lvl="2" pelid="" title="" id="39436402" />
        <uicommand button-type="grid-add" column-visible="0" name="grid-add" control-name="ButtonAddRow" file="sql.builder.templates\sql.builder\projects\common\main.xml" elid="363" ord="363" leaf="1" lvl="2" pelid="" title="" id="9754526" />
        <uicommand button-type="grid-delete" column-visible="0" name="grid-delete" control-name="ButtonDeleteRow" file="sql.builder.templates\sql.builder\projects\common\main.xml" elid="367" ord="367" leaf="1" lvl="2" pelid="" title="" id="47227882" />
        <uicommand action-type="custom" type="Delete" title="Удалить" button-type="custom-delete" editable="kg_add_allow_flag" name="custom-delete" icon="Delete_24" file="sql.builder.templates\sql.builder\projects\common\main.xml" elid="379" ord="379" leaf="1" lvl="2" pelid="" id="56005801">
          <useaction action-type="client-remove-row" action-rows="selected" id="20049787" />
        </uicommand>
        <uicommand action-type="custom" button-type="custom-commit" editable="gn_has_changes" name="custom-commit" icon="Commit_24" title="Сохранить" file="sql.builder.templates\sql.builder\projects\common\main.xml" elid="378" ord="378" leaf="1" lvl="2" pelid="" id="34906932">
          <useaction action-type="save" id="15517465" />
          <useaction action-type="refresh-form" object="gn" id="17119286" />
        </uicommand>
        <uicommand action-type="custom" title="Кольцевая группа" button-type="custom-add-form" editable="kg_add_allow_flag" name="custom-add-form" icon="AddForm_24" file="sql.builder.templates\sql.builder\projects\common\main.xml" elid="376" ord="376" leaf="1" lvl="2" pelid="" id="13279192">
          <useaction action-type="dynamic-form-create" call="45862_vb_kol_gr" modal="1" id="61284270">
            <const id="38128101">null</const>
            <useparam name="kod_fl" id="7523484" />
            <useparam name="ym" id="63200351" />
          </useaction>
          <useaction action-type="refresh-form" object="gn" id="26840855" />
        </uicommand>
      </toolbar>
      <columns id="5419741">
        <field table="gn" name="is_not_new" title="" controlType="UIText" edit-mask="N2" rows-limit="100" id="55832345" />
        <field table="gn" name="kod_kol_gr" title="Код кольцевой группы" controlType="UICombo" rows-limit="100" id="66750845" />
        <field table="gn" name="name_exp" title="Наименование" width="576" controlType="UIText" rows-limit="100" id="959652">
          <buttons id="43713839">
            <uicommand action-type="custom" title="Настройка" visible="kod_fl" side="Right" id="23616479">
              <useaction action-type="save" id="11309883" />
              <useaction action-type="dynamic-form" call="45862_vb_kol_gr" editable="gn_is_not_new" modal="1" title="Настройка" visible="1" side="Right" id="63485891">
                <useparam name="kod_nastr" id="62552935" />
                <useparam name="kod_fl" id="26971265" />
                <useparam name="ym" id="20190921" />
              </useaction>
              <useaction action-type="refresh-form" object="gn" id="9309028" />
            </uicommand>
          </buttons>
        </field>
        <field table="gn" name="kol_gr_comment" title="Дополнение" width="383" controlType="UIText" rows-limit="100" id="35132099" />
        <field table="gn" name="kod_fl" title="Филиал" controlType="UICombo" rows-limit="100" id="36036845" />
        <field table="gn" name="kod_kol_gr_nastr" title="" controlType="UIText" edit-mask="N2" rows-limit="100" id="27332844" />
      </columns>
    </grid>
  </form>
  <dataset>
    <fields>
      <field type="number" name="ym" parname="ym" title="Период" ColumnMandatory="1" />
      <field type="number" name="kod_fl" parname="kod_fl" title="Филиал" ColumnMandatory="1" />
      <field type="string" name="init_dummy" parname="init_dummy" title="" ColumnVisible="0" />
      <field type="string" name="ym_editable" parname="ym_editable" title="" ColumnVisible="0" />
      <field type="string" name="kg_add_allow_flag" parname="kg_add_allow_flag" title="" ColumnVisible="0" />
      <field type="string" name="is_form_valid" parname="is_form_valid" />
      <field type="string" name="is_form_valid_not" parname="is_form_valid_not" />
      <field type="string" name="gn_has_changes" parname="gn_has_changes" />
    </fields>
    <table name="gn" auto-refresh="1" async="" only-visible-refresh="" only-force-refresh="" ref-column="" multi-select-column="" multi-select-target="" update-target="vb_kol_gr_nastr" key="kod_kol_gr_nastr" is-ms-upd="1" is-top="1">
      <select-text>
--
select gn.is_not_new as is_not_new, /*number*/
gn.kod_kol_gr as kod_kol_gr, /*Код кольцевой группы*//*number*/
gn.name_exp as name_exp, /*Наименование*//*string*/
gn.kol_gr_comment as kol_gr_comment, /*Дополнение*//*string*/
gn.kod_fl as kod_fl, /*Филиал*//*number*/
gn.kod_kol_gr_nastr as kod_kol_gr_nastr, /*number*//*key*/
kod_kol_gr_x_n.name as kod_kol_gr_x_n, /*Код кольцевой группы*//*string*/
kod_fl_x_n.name as kod_fl_x_n, /*Филиал*//*string*/
gn.is_new as is_new/*number*/

from (
--vb_kol_gr_nastr
select a.kod_kol_gr_nastr as kod_kol_gr_nastr, /*number*//*key*/
a.kod_kol_gr as kod_kol_gr, /*Код кольцевой группы*//*number*/
 case  when (a.name is null )  then '' else a.name end  as name_exp, /*Наименование*//*string*/
a.s as s, /*Период с*//*number*/
a.po as po, /*Период по*//*number*/
a.kod_fl as kod_fl, /*Код филиала*//*number*/
a.kol_gr_comment as kol_gr_comment, /*Дополнение*//*string*/
0 as is_new, /*number*/
1 as is_not_new/*number*/

from vb_kol_gr_nastr
a
--\vb_kol_gr_nastr
)
gn
--\vb_kol_gr_nastr
left outer join
(
--jv_rep_cons_d_fl
select a.kod_fl as kod_fl, /*number*//*key*/
a.name as name/*Филиал*//*string*/

from jv_rep_cons_d_fl
a
--\jv_rep_cons_d_fl
)
kod_fl_x_n on gn.kod_fl = kod_fl_x_n.kod_fl--\jv_rep_cons_d_fl
left outer join
(
--vb_kol_gr
select a.kod_kol_gr as kod_kol_gr, /*number*//*key*/
a.name as name/*Наименование*//*string*/

from vb_kol_gr
a
--\vb_kol_gr
)
kod_kol_gr_x_n on gn.kod_kol_gr = kod_kol_gr_x_n.kod_kol_gr--\vb_kol_gr
where
(( nvl( gn.po , :ym  ) )  &gt;= :ym )  and (( nvl( gn.s , :ym  ) )  &lt;= :ym )  {  and (gn.kod_fl = :kod_fl )  }  and ( nvl( :init_dummy  ,0)=1 ) --\
</select-text>
      <columns>
        <column name="is_not_new" table="gn" type="number" title="" parname="gn_is_not_new" ColumnVisible="0" />
        <column name="kod_kol_gr" table="gn" type="number" title="Код кольцевой группы" parname="kod_kol_gr" ColumnVisible="0" is-updateable="1" is-updateable-ext="1" update-target="kod_kol_gr" temp-col-name="n4">
          <dep-refresh-cmd>
            <root table="gn">
              <params>
                <param name="kod_kol_gr_nastr_prm" type="number" column="" />
                <param name="form_id" type="number" column="" />
              </params>
              <select>
                <params>
                  <param name="kod_kol_gr_nastr_prm" type="number" column="" />
                  <param name="form_id" type="number" column="" />
                </params>
                <query>
--
select kod_kol_gr_x_n.name as kod_kol_gr_x_n, /*Код кольцевой группы*//*string*/
gn.kod_kol_gr_nastr as kod_kol_gr_nastr/*number*//*key*/

from (
--vb_kol_gr_nastr
select a.kod_kol_gr_nastr as kod_kol_gr_nastr, /*number*//*key*/
a.kod_kol_gr as kod_kol_gr/*Код кольцевой группы*//*number*/

from (select a.kod_kol_gr_nastr as kod_kol_gr_nastr,a.kod_kol_gr as kod_kol_gr  from vb_kol_gr_nastr a where not exists (select * from rr_temp t where t.skod ='gn' and t.names=:form_id  and a.kod_kol_gr_nastr=t.f2 ) and   a.kod_kol_gr_nastr in :kod_kol_gr_nastr_prm   union all  select t.n3 as kod_kol_gr_nastr,t.n4 as kod_kol_gr  from rr_temp t where t.skod ='gn' and t.names=:form_id  and t.f3!=3  and t.f2 in :kod_kol_gr_nastr_prm )
a
--\(select a.kod_kol_gr_nastr as kod_kol_gr_nastr,a.kod_kol_gr as kod_kol_gr  from vb_kol_gr_nastr a where not exists (select * from rr_temp t where t.skod ='gn' and t.names=:form_id  and a.kod_kol_gr_nastr=t.f2 ) and   a.kod_kol_gr_nastr in :kod_kol_gr_nastr_prm   union all  select t.n3 as kod_kol_gr_nastr,t.n4 as kod_kol_gr  from rr_temp t where t.skod ='gn' and t.names=:form_id  and t.f3!=3  and t.f2 in :kod_kol_gr_nastr_prm )
)
gn
--\vb_kol_gr_nastr
left outer join
(
--vb_kol_gr
select a.kod_kol_gr as kod_kol_gr, /*number*//*key*/
a.name as name/*Наименование*//*string*/

from vb_kol_gr
a
--\vb_kol_gr
)
kod_kol_gr_x_n on gn.kod_kol_gr = kod_kol_gr_x_n.kod_kol_gr--\vb_kol_gr
--\
</query>
              </select>
              <procedure>
                <params />
              </procedure>
            </root>
          </dep-refresh-cmd>
          <dependants>
            <dependant name="kod_kol_gr_x_n" table="gn" />
          </dependants>
        </column>
        <column name="name_exp" table="gn" type="string" title="Наименование" ColumnEditable="0" is-refreshed="1">
          <value-refresh-cmd>
            <root>
              <params>
                <param name="kod_kol_gr_nastr_prm" type="number" column="" />
                <param name="form_id" type="number" column="" />
              </params>
              <select>
                <params>
                  <param name="kod_kol_gr_nastr_prm" type="number" column="" />
                  <param name="form_id" type="number" column="" />
                </params>
                <query>
--
select gn.name_exp as name_exp, /*Наименование*//*string*/
gn.kod_kol_gr_nastr as kod_kol_gr_nastr/*number*//*key*/

from (
--vb_kol_gr_nastr
select a.kod_kol_gr_nastr as kod_kol_gr_nastr, /*number*//*key*/
 case  when (a.name is null )  then '' else a.name end  as name_exp/*Наименование*//*string*/

from (select a.kod_kol_gr_nastr as kod_kol_gr_nastr,a.name as name  from vb_kol_gr_nastr a where not exists (select * from rr_temp t where t.skod ='gn' and t.names=:form_id  and a.kod_kol_gr_nastr=t.f2 ) and   a.kod_kol_gr_nastr in :kod_kol_gr_nastr_prm   union all  select t.n3 as kod_kol_gr_nastr,t.s2 as name  from rr_temp t where t.skod ='gn' and t.names=:form_id  and t.f3!=3  and t.f2 in :kod_kol_gr_nastr_prm )
a
--\(select a.kod_kol_gr_nastr as kod_kol_gr_nastr,a.name as name  from vb_kol_gr_nastr a where not exists (select * from rr_temp t where t.skod ='gn' and t.names=:form_id  and a.kod_kol_gr_nastr=t.f2 ) and   a.kod_kol_gr_nastr in :kod_kol_gr_nastr_prm   union all  select t.n3 as kod_kol_gr_nastr,t.s2 as name  from rr_temp t where t.skod ='gn' and t.names=:form_id  and t.f3!=3  and t.f2 in :kod_kol_gr_nastr_prm )
)
gn
--\vb_kol_gr_nastr
--\
</query>
              </select>
              <procedure>
                <params />
              </procedure>
            </root>
          </value-refresh-cmd>
        </column>
        <column name="kol_gr_comment" table="gn" type="string" title="Дополнение" ClientEditable="ym_editable" is-user-editable="1" is-updateable="1" is-updateable-ext="1" update-target="kol_gr_comment" temp-col-name="s1" />
        <column name="kod_fl" table="gn" type="number" title="Филиал" ColumnEditable="0" ClientDefault="kod_fl" ColumnMandatory="1" is-updateable="1" is-updateable-ext="1" update-target="kod_fl" temp-col-name="n1">
          <dep-refresh-cmd>
            <root table="gn">
              <params>
                <param name="kod_kol_gr_nastr_prm" type="number" column="" />
                <param name="form_id" type="number" column="" />
              </params>
              <select>
                <params>
                  <param name="kod_kol_gr_nastr_prm" type="number" column="" />
                  <param name="form_id" type="number" column="" />
                </params>
                <query>
--
select kod_fl_x_n.name as kod_fl_x_n, /*Филиал*//*string*/
gn.kod_kol_gr_nastr as kod_kol_gr_nastr/*number*//*key*/

from (
--vb_kol_gr_nastr
select a.kod_kol_gr_nastr as kod_kol_gr_nastr, /*number*//*key*/
a.kod_fl as kod_fl/*Код филиала*//*number*/

from (select a.kod_kol_gr_nastr as kod_kol_gr_nastr,a.kod_fl as kod_fl  from vb_kol_gr_nastr a where not exists (select * from rr_temp t where t.skod ='gn' and t.names=:form_id  and a.kod_kol_gr_nastr=t.f2 ) and   a.kod_kol_gr_nastr in :kod_kol_gr_nastr_prm   union all  select t.n3 as kod_kol_gr_nastr,t.n1 as kod_fl  from rr_temp t where t.skod ='gn' and t.names=:form_id  and t.f3!=3  and t.f2 in :kod_kol_gr_nastr_prm )
a
--\(select a.kod_kol_gr_nastr as kod_kol_gr_nastr,a.kod_fl as kod_fl  from vb_kol_gr_nastr a where not exists (select * from rr_temp t where t.skod ='gn' and t.names=:form_id  and a.kod_kol_gr_nastr=t.f2 ) and   a.kod_kol_gr_nastr in :kod_kol_gr_nastr_prm   union all  select t.n3 as kod_kol_gr_nastr,t.n1 as kod_fl  from rr_temp t where t.skod ='gn' and t.names=:form_id  and t.f3!=3  and t.f2 in :kod_kol_gr_nastr_prm )
)
gn
--\vb_kol_gr_nastr
left outer join
(
--jv_rep_cons_d_fl
select a.kod_fl as kod_fl, /*number*//*key*/
a.name as name/*Филиал*//*string*/

from jv_rep_cons_d_fl
a
--\jv_rep_cons_d_fl
)
kod_fl_x_n on gn.kod_fl = kod_fl_x_n.kod_fl--\jv_rep_cons_d_fl
--\
</query>
              </select>
              <procedure>
                <params />
              </procedure>
            </root>
          </dep-refresh-cmd>
          <dependants>
            <dependant name="kod_fl_x_n" table="gn" />
          </dependants>
        </column>
        <column name="kod_kol_gr_nastr" table="gn" type="number" title="" parname="kod_nastr" ColumnVisible="0" is-updateable="1" is-updateable-ext="1" update-target="kod_kol_gr_nastr" temp-col-name="n3" />
        <column name="kod_kol_gr_x_n" table="gn.kod_kol_gr" type="string" title="Код кольцевой группы" text-source-for="kod_kol_gr" is-refreshed="1">
          <value-refresh-cmd>
            <root>
              <params>
                <param name="kod_kol_gr_nastr_prm" type="number" column="" />
                <param name="form_id" type="number" column="" />
              </params>
              <select>
                <params>
                  <param name="kod_kol_gr_nastr_prm" type="number" column="" />
                  <param name="form_id" type="number" column="" />
                </params>
                <query>
--
select kod_kol_gr_x_n.name as kod_kol_gr_x_n, /*Код кольцевой группы*//*string*/
gn.kod_kol_gr_nastr as kod_kol_gr_nastr/*number*//*key*/

from (
--vb_kol_gr_nastr
select a.kod_kol_gr_nastr as kod_kol_gr_nastr, /*number*//*key*/
a.kod_kol_gr as kod_kol_gr/*Код кольцевой группы*//*number*/

from (select a.kod_kol_gr_nastr as kod_kol_gr_nastr,a.kod_kol_gr as kod_kol_gr  from vb_kol_gr_nastr a where not exists (select * from rr_temp t where t.skod ='gn' and t.names=:form_id  and a.kod_kol_gr_nastr=t.f2 ) and   a.kod_kol_gr_nastr in :kod_kol_gr_nastr_prm   union all  select t.n3 as kod_kol_gr_nastr,t.n4 as kod_kol_gr  from rr_temp t where t.skod ='gn' and t.names=:form_id  and t.f3!=3  and t.f2 in :kod_kol_gr_nastr_prm )
a
--\(select a.kod_kol_gr_nastr as kod_kol_gr_nastr,a.kod_kol_gr as kod_kol_gr  from vb_kol_gr_nastr a where not exists (select * from rr_temp t where t.skod ='gn' and t.names=:form_id  and a.kod_kol_gr_nastr=t.f2 ) and   a.kod_kol_gr_nastr in :kod_kol_gr_nastr_prm   union all  select t.n3 as kod_kol_gr_nastr,t.n4 as kod_kol_gr  from rr_temp t where t.skod ='gn' and t.names=:form_id  and t.f3!=3  and t.f2 in :kod_kol_gr_nastr_prm )
)
gn
--\vb_kol_gr_nastr
left outer join
(
--vb_kol_gr
select a.kod_kol_gr as kod_kol_gr, /*number*//*key*/
a.name as name/*Наименование*//*string*/

from vb_kol_gr
a
--\vb_kol_gr
)
kod_kol_gr_x_n on gn.kod_kol_gr = kod_kol_gr_x_n.kod_kol_gr--\vb_kol_gr
--\
</query>
              </select>
              <procedure>
                <params />
              </procedure>
            </root>
          </value-refresh-cmd>
        </column>
        <column name="kod_fl_x_n" table="gn.kod_fl" type="string" title="Филиал" text-source-for="kod_fl" is-refreshed="1">
          <value-refresh-cmd>
            <root>
              <params>
                <param name="kod_kol_gr_nastr_prm" type="number" column="" />
                <param name="form_id" type="number" column="" />
              </params>
              <select>
                <params>
                  <param name="kod_kol_gr_nastr_prm" type="number" column="" />
                  <param name="form_id" type="number" column="" />
                </params>
                <query>
--
select kod_fl_x_n.name as kod_fl_x_n, /*Филиал*//*string*/
gn.kod_kol_gr_nastr as kod_kol_gr_nastr/*number*//*key*/

from (
--vb_kol_gr_nastr
select a.kod_kol_gr_nastr as kod_kol_gr_nastr, /*number*//*key*/
a.kod_fl as kod_fl/*Код филиала*//*number*/

from (select a.kod_kol_gr_nastr as kod_kol_gr_nastr,a.kod_fl as kod_fl  from vb_kol_gr_nastr a where not exists (select * from rr_temp t where t.skod ='gn' and t.names=:form_id  and a.kod_kol_gr_nastr=t.f2 ) and   a.kod_kol_gr_nastr in :kod_kol_gr_nastr_prm   union all  select t.n3 as kod_kol_gr_nastr,t.n1 as kod_fl  from rr_temp t where t.skod ='gn' and t.names=:form_id  and t.f3!=3  and t.f2 in :kod_kol_gr_nastr_prm )
a
--\(select a.kod_kol_gr_nastr as kod_kol_gr_nastr,a.kod_fl as kod_fl  from vb_kol_gr_nastr a where not exists (select * from rr_temp t where t.skod ='gn' and t.names=:form_id  and a.kod_kol_gr_nastr=t.f2 ) and   a.kod_kol_gr_nastr in :kod_kol_gr_nastr_prm   union all  select t.n3 as kod_kol_gr_nastr,t.n1 as kod_fl  from rr_temp t where t.skod ='gn' and t.names=:form_id  and t.f3!=3  and t.f2 in :kod_kol_gr_nastr_prm )
)
gn
--\vb_kol_gr_nastr
left outer join
(
--jv_rep_cons_d_fl
select a.kod_fl as kod_fl, /*number*//*key*/
a.name as name/*Филиал*//*string*/

from jv_rep_cons_d_fl
a
--\jv_rep_cons_d_fl
)
kod_fl_x_n on gn.kod_fl = kod_fl_x_n.kod_fl--\jv_rep_cons_d_fl
--\
</query>
              </select>
              <procedure>
                <params />
              </procedure>
            </root>
          </value-refresh-cmd>
        </column>
        <column name="is_new" table="gn" type="number" title="" is-user-editable="1" />
      </columns>
      <insert-text>begin 
for r in  
 ( select  
:kod_kol_gr as kod_kol_gr 
,:kol_gr_comment as kol_gr_comment 
,:kod_fl as kod_fl 
,:kod_kol_gr_nastr as kod_kol_gr_nastr 
 
from dual ) 
 
loop 
insert into vb_kol_gr_nastr 
(kod_kol_gr 
,kol_gr_comment 
,kod_fl 
,kod_kol_gr_nastr 
) 
 values  
(r.kod_kol_gr 
,r.kol_gr_comment 
,r.kod_fl 
,r.kod_kol_gr_nastr 
) 
 returning  
kod_kol_gr_nastr into :kod_kol_gr_nastr; 
end loop; 
end; 
</insert-text>
      <delete-text>delete from vb_kol_gr_nastr where kod_kol_gr_nastr=:kod_kol_gr_nastr</delete-text>
      <update-temp-text>begin 
delete from rr_temp 
where 
skod='gn' 
and 
names=:form_id 
and 
f2=:kod_kol_gr_nastr; 
if :row_state_id=1  then 
for r in  
 ( select  
:kod_kol_gr as kod_kol_gr 
,:kol_gr_comment as kol_gr_comment 
,:kod_fl as kod_fl 
,:kod_kol_gr_nastr as kod_kol_gr_nastr 
 
from dual ) 
 
loop 
insert into rr_temp 
(skod 
,names 
,f2 
,f3 
,n4 
,s1 
,n1 
,n3 
) 
 values  
('gn' 
,:form_id 
,:kod_kol_gr_nastr 
,:row_state_id 
,r.kod_kol_gr 
,r.kol_gr_comment 
,r.kod_fl 
,r.kod_kol_gr_nastr 
); 
end loop; 
else 
for r in  
 ( select  
:kod_kol_gr as kod_kol_gr 
,:kol_gr_comment as kol_gr_comment 
,:kod_fl as kod_fl 
,:kod_kol_gr_nastr as kod_kol_gr_nastr 
,a.name 
,a.s 
,a.po 
,a.u_m 
,a.d_m 
,a.is_auto_kg 
 
from vb_kol_gr_nastr a  where kod_kol_gr_nastr=:kod_kol_gr_nastr) 
 
loop 
insert into rr_temp 
(skod 
,names 
,f2 
,f3 
,n4 
,s1 
,n1 
,n3 
,s2 
,n2 
,n5 
,s3 
,d1 
,n6 
) 
 values  
('gn' 
,:form_id 
,:kod_kol_gr_nastr 
,:row_state_id 
,r.kod_kol_gr 
,r.kol_gr_comment 
,r.kod_fl 
,r.kod_kol_gr_nastr 
,r.name 
,r.s 
,r.po 
,r.u_m 
,r.d_m 
,r.is_auto_kg 
); 
end loop; 
end if; 
end; 
</update-temp-text>
      <clear-temp-text>delete from rr_temp where skod='gn' and names=:form_id</clear-temp-text>
      <update-text>begin
update vb_kol_gr_nastr set  
(kod_kol_gr 
,kol_gr_comment 
,kod_fl 
,kod_kol_gr_nastr 
) 
= 
 ( select  
:kod_kol_gr as kod_kol_gr 
,:kol_gr_comment as kol_gr_comment 
,:kod_fl as kod_fl 
,:kod_kol_gr_nastr as kod_kol_gr_nastr 
 
from dual ) 
 
where 
kod_kol_gr_nastr=:kod_kol_gr_nastr 
;
end;
</update-text>
      <events>
        <useaction event-name="instead-object-delete" name="vb_kol_gr_pack.del_kg_nastr">
          <useparam name="kod_nastr" />
          <useparam name="ym" />
        </useaction>
      </events>
      <scheme>
        <table name="vb_kol_gr_nastr" as="gn">
          <columns>
            <column name="is_not_new" type="number" title="" visible="0" />
            <column name="kod_kol_gr" type="number" invisible-in-column-chooser="1" visible="0" />
            <column name="name_exp" type="string" title="Наименование" />
            <column name="kol_gr_comment" type="string" title="Дополнение" />
            <column name="kod_fl" type="number" invisible-in-column-chooser="1" visible="0" />
            <column name="kod_kol_gr_nastr" type="number" title="" visible="0" />
            <column name="kod_kol_gr_x_n" type="string" title="Код кольцевой группы" visible="0" />
            <column name="kod_fl_x_n" type="string" title="Филиал" />
            <column name="is_new" type="number" invisible-in-column-chooser="1" visible="0" />
          </columns>
          <viewcolumns>
            <column name="is_not_new" type="number" title="" visible="0" />
            <column name="kod_kol_gr_x_n" type="string" title="Код кольцевой группы" visible="0" />
            <column name="kod_kol_gr" type="number" invisible-in-column-chooser="1" visible="0" />
            <column name="name_exp" type="string" title="Наименование" />
            <column name="kol_gr_comment" type="string" title="Дополнение" />
            <column name="kod_fl_x_n" type="string" title="Филиал" />
            <column name="kod_fl" type="number" invisible-in-column-chooser="1" visible="0" />
            <column name="kod_kol_gr_nastr" type="number" title="" visible="0" />
            <column name="is_new" type="number" invisible-in-column-chooser="1" visible="0" />
          </viewcolumns>
        </table>
      </scheme>
      <single-row-refresh-cmd>
        <root>
          <params>
            <param name="kod_kol_gr_nastr_prm" type="number" column="" />
            <param name="form_id" type="number" column="" />
          </params>
          <select>
            <params>
              <param name="kod_kol_gr_nastr_prm" type="number" column="" />
              <param name="form_id" type="number" column="" />
            </params>
            <query>
--
select gn.is_not_new as is_not_new, /*number*/
gn.kod_kol_gr as kod_kol_gr, /*Код кольцевой группы*//*number*/
gn.name_exp as name_exp, /*Наименование*//*string*/
gn.kol_gr_comment as kol_gr_comment, /*Дополнение*//*string*/
gn.kod_fl as kod_fl, /*Филиал*//*number*/
gn.kod_kol_gr_nastr as kod_kol_gr_nastr, /*number*//*key*/
kod_kol_gr_x_n.name as kod_kol_gr_x_n, /*Код кольцевой группы*//*string*/
kod_fl_x_n.name as kod_fl_x_n, /*Филиал*//*string*/
gn.is_new as is_new/*number*/

from (
--vb_kol_gr_nastr
select a.kod_kol_gr_nastr as kod_kol_gr_nastr, /*number*//*key*/
a.kod_kol_gr as kod_kol_gr, /*Код кольцевой группы*//*number*/
 case  when (a.name is null )  then '' else a.name end  as name_exp, /*Наименование*//*string*/
a.kod_fl as kod_fl, /*Код филиала*//*number*/
a.kol_gr_comment as kol_gr_comment, /*Дополнение*//*string*/
a.is_new as is_new, /*number*/
a.is_not_new as is_not_new/*number*/

from (select a.kod_kol_gr_nastr as kod_kol_gr_nastr,a.kod_kol_gr as kod_kol_gr,a.name as name,a.kod_fl as kod_fl,a.kol_gr_comment as kol_gr_comment,0 as is_new,1 as is_not_new  from vb_kol_gr_nastr a where not exists (select * from rr_temp t where t.skod ='gn' and t.names=:form_id  and a.kod_kol_gr_nastr=t.f2 ) and   a.kod_kol_gr_nastr in :kod_kol_gr_nastr_prm   union all  select t.n3 as kod_kol_gr_nastr,t.n4 as kod_kol_gr,t.s2 as name,t.n1 as kod_fl,t.s1 as kol_gr_comment,decode (f3,1,1,0) as is_new,decode (f3,1,0,1) as is_not_new  from rr_temp t where t.skod ='gn' and t.names=:form_id  and t.f3!=3  and t.f2 in :kod_kol_gr_nastr_prm )
a
--\(select a.kod_kol_gr_nastr as kod_kol_gr_nastr,a.kod_kol_gr as kod_kol_gr,a.name as name,a.kod_fl as kod_fl,a.kol_gr_comment as kol_gr_comment,0 as is_new,1 as is_not_new  from vb_kol_gr_nastr a where not exists (select * from rr_temp t where t.skod ='gn' and t.names=:form_id  and a.kod_kol_gr_nastr=t.f2 ) and   a.kod_kol_gr_nastr in :kod_kol_gr_nastr_prm   union all  select t.n3 as kod_kol_gr_nastr,t.n4 as kod_kol_gr,t.s2 as name,t.n1 as kod_fl,t.s1 as kol_gr_comment,decode (f3,1,1,0) as is_new,decode (f3,1,0,1) as is_not_new  from rr_temp t where t.skod ='gn' and t.names=:form_id  and t.f3!=3  and t.f2 in :kod_kol_gr_nastr_prm )
)
gn
--\vb_kol_gr_nastr
left outer join
(
--jv_rep_cons_d_fl
select a.kod_fl as kod_fl, /*number*//*key*/
a.name as name/*Филиал*//*string*/

from jv_rep_cons_d_fl
a
--\jv_rep_cons_d_fl
)
kod_fl_x_n on gn.kod_fl = kod_fl_x_n.kod_fl--\jv_rep_cons_d_fl
left outer join
(
--vb_kol_gr
select a.kod_kol_gr as kod_kol_gr, /*number*//*key*/
a.name as name/*Наименование*//*string*/

from vb_kol_gr
a
--\vb_kol_gr
)
kod_kol_gr_x_n on gn.kod_kol_gr = kod_kol_gr_x_n.kod_kol_gr--\vb_kol_gr
--\
</query>
          </select>
          <procedure>
            <params />
          </procedure>
        </root>
      </single-row-refresh-cmd>
    </table>
  </dataset>
</root>