<?xml version="1.0" encoding="utf-8"?>
<root>

  <!--<forms>
    <form name="fingen_nach_period">
      <content>
        <field name="ym" controlType="UIComboRange" title="Период">
          <listquery>
            <query name="kr_calc_list">
            </query>
          </listquery>
          <defaultquery>
            <query name="kr_calc_max">
            </query>
          </defaultquery>
        </field>
        <field name="dep" controlType="UIList" title="Отделения">
          <listquery>
            <query name="kr_dep">
            </query>
          </listquery>
        </field>
        <field name="kod_dog" controlType="UIList" title="Абоненты и договоры">
          <listquery>
            <query name="kr_dogovor_list(dep)">
            </query>
          </listquery>
        </field>
        <field name="vidreal" controlType="UIList" title="Виды реализации">
          <listquery>
            <query name="sk_vid_real_list">
            </query>
          </listquery>
        </field>
        <field name="vidt_filtr" controlType="UIList" title="Виды товаров (фильтр)">
          <listquery>
            <query name="sk_nachisl(vidreal)">
            </query>
          </listquery>
        </field>
        <field name="vidt_col" controlType="UIList" title="Виды товаров (транспонирование)">
          <listquery>
            <query name="sk_nachisl(vidreal)">
            </query>
          </listquery>
        </field>
        <field name="edizm_filtr" controlType="UIList" title="Натуральные показатели (фильтр)">
          <listquery>
            <query name="sk_edizm_list">
            </query>
          </listquery>
        </field>
        <field name="edizm_col" controlType="UIList" title="Натуральные показатели (транспонирование)">
          <listquery>
            <query name="sk_edizm_list">
            </query>
          </listquery>
        </field>
        <field name="typeopl_filtr" controlType="UIList" title="Типы оплат (фильтр)">
          <listquery>
            <query name="sk_type_opl_list">
            </query>
          </listquery>
        </field>
        <field name="typeopl_col" controlType="UIList" title="Типы оплат (транспонирование)">
          <listquery>
            <query name="sk_type_opl_list">
            </query>
          </listquery>
        </field>
        <field name="vidopl_filtr" controlType="UIList" title="Виды оплат (фильтр)">
          <listquery>
            <query name="ss_vidopl_list">
            </query>
          </listquery>
        </field>
        <field name="vidopl_col" controlType="UIList" title="Виды оплат (транспонирование)">
          <listquery>
            <query name="ss_vidopl_list">
            </query>
          </listquery>
        </field>
      </content>
    </form>

    <form name="fingen_opl_nach_period">
      <content>
        <field name="ym" controlType="UIComboRange" title="Период">
          <listquery>
            <query name="kr_calc_list">
            </query>
          </listquery>
          <defaultquery>
            <query name="kr_calc_max">
            </query>
          </defaultquery>
        </field>
        <field name="dep" controlType="UIList" title="Отделения">
          <listquery>
            <query name="kr_dep">
            </query>
          </listquery>
        </field>
        <field name="kod_dog" controlType="UIList" title="Абоненты и договоры">
          <listquery>
            <query name="kr_dogovor_list(dep)">
            </query>
          </listquery>
        </field>
        <field name="vidreal" controlType="UIList" title="Виды реализации">
          <listquery>
            <query name="sk_vid_real_list">
            </query>
          </listquery>
        </field>
        <field name="vidt_filtr" controlType="UIList" title="Виды товаров (фильтр)">
          <listquery>
            <query name="sk_nachisl(vidreal)">
            </query>
          </listquery>
        </field>
        <field name="vidt_col" controlType="UIList" title="Виды товаров (транспонирование)">
          <listquery>
            <query name="sk_nachisl(vidreal)">
            </query>
          </listquery>
        </field>
        <field name="edizm_filtr" controlType="UIList" title="Натуральные показатели (фильтр)">
          <listquery>
            <query name="sk_edizm_list">
            </query>
          </listquery>
        </field>
        <field name="edizm_col" controlType="UIList" title="Натуральные показатели (транспонирование)">
          <listquery>
            <query name="sk_edizm_list">
            </query>
          </listquery>
        </field>
        <field name="typeopl_filtr" controlType="UIList" title="Типы оплат (фильтр)">
          <listquery>
            <query name="sk_type_opl_list">
            </query>
          </listquery>
        </field>
        <field name="typeopl_col" controlType="UIList" title="Типы оплат (транспонирование)">
          <listquery>
            <query name="sk_type_opl_list">
            </query>
          </listquery>
        </field>
        <field name="vidopl_filtr" controlType="UIList" title="Виды оплат (фильтр)">
          <listquery>
            <query name="ss_vidopl_list">
            </query>
          </listquery>
        </field>
        <field name="vidopl_col" controlType="UIList" title="Виды оплат (транспонирование)">
          <listquery>
            <query name="ss_vidopl_list">
            </query>
          </listquery>
        </field>
      </content>
    </form>
  </forms>

  <reports>
    <report name="fingen_nach_period" title="Генератор выписок/начислений" form="fingen_nach_period" autobands="1">
      <params>
        <param name="ym1">
          <const>2009.03</const>
        </param>
        <param name="ym2">
          <const>2009.08</const>
        </param>
        <param name="kod_dog">
          <array>162,270,297,401,775,834,1009,1039,1771,2021,10010863,10019549</array>
        </param>
        <param name="vidreal"></param>
        <param name="vidt_filtr"></param>
        <param name="vidt_col"></param>
        <param name="edizm_filtr"></param>
        <param name="edizm_col"></param>
      </params>
      <customers>
        <customer id="-1"/>
      </customers>
      <queries>
        <query name="fingen_nach_period" as="a">
          --><!--<columns>
            <column table="a" name="namep" />
            <column table="a" name="ndog" />
            <column table="a" name="nachisl"/>
            <column table="a" name="nachisl_not_nal"/>
            <column table="a" name="nal"/>
          </columns>--><!--
          <withparams>
            <useparam name="ym1"/>
            <useparam name="ym2"/>
            <useparam name="kod_dog"/>
            <useparam name="vidreal"/>
            <useparam name="vidt_filtr"/>
            <useparam name="vidt_col"/>
            <useparam name="edizm_filtr"/>
            <useparam name="edizm_col"/>
          </withparams>
        </query>
      </queries>
    </report>

    <report name="fingen_opl_nach_period" title="Генератор оплат" form="fingen_opl_nach_period">
      <params>
        <param name="ym1">
          <const>2009.03</const>
        </param>
        <param name="ym2">
          <const>2009.08</const>
        </param>
        <param name="kod_dog">
          <array>162,270,297,401,775,834,1009,1039,1771,2021,10010863,10019549</array>
        </param>
        <param name="vidreal"></param>
        <param name="typeopl_filtr"></param>
        <param name="typeopl_col"></param>
        <param name="vidopl_filtr"></param>
        <param name="vidopl_col"></param>
      </params>
      <customers>
        <customer id="-1"/>
      </customers>
      <queries>
        <query name="fingen_opl_nach_period" as="a">
          --><!--<columns>
            <column table="a" name="namep" />
            <column table="a" name="ndog" />
            <column table="a" name="nachisl"/>
            <column table="a" name="nachisl_not_nal"/>
            <column table="a" name="nal"/>
          </columns>--><!--
          <withparams>
            <useparam name="ym1"/>
            <useparam name="ym2"/>
            <useparam name="kod_dog"/>
            <useparam name="vidreal"/>
            <useparam name="typeopl_filtr"></useparam>
            <useparam name="typeopl_col"></useparam>
            <useparam name="vidopl_filtr"></useparam>
            <useparam name="vidopl_col"></useparam>
          </withparams>
        </query>
      </queries>
    </report>


    <report name="fingen" title="Финансовый генератор отчетов" form="fingen_nach_period" autobands="1">
      <params>
        <param name="ym1">
          <const>2009.03</const>
        </param>
        <param name="ym2">
          <const>2009.08</const>
        </param>
      </params>
      <customers>
        <customer id="-1"/>
      </customers>
      <queries>
        <query name="fingen_united" as="a">
          --><!--<columns>
            <column table="a" name="vid_real_name" />
            <column table="a" name="nachisl" />
          </columns>--><!--
          <withparams>
            <useparam name="ym1"/>
            <useparam name="ym2"/>
          </withparams>
        </query>
      </queries>
    </report>
  </reports>-->

  <queries>

   

    <query name="fingenbyt_test">
      <select>
        <!--<column table="a" column="*" />-->
        <column table="a" column="ndog" />
        <column table="a" column="payer_nump" />
        <column table="a" column="payer_name" />
        <!--<column table="a" column="cust_teplo" />-->
        <column table="a" column="vid_real_name" />
        <!--<column table="a" column="nachisl_bef" />
        <column table="a" column="opl_nach_bef" />-->
        <column table="a" column="ostatok_beg" />
        <column table="a" column="kredit_beg" />
        <column table="a" column="nachisl" />
        <!--<column table="a" column="nachisl_by_vid_t" />
        <column table="a" column="nachisl_by_edizm" />-->
        <!--<column table="a" column="cust" />-->
        <!--<column table="a" column="cust_by_vid_t" />
        <column table="a" column="cust_by_edizm" />-->
        <column table="a" column="opl_nach" />
        <column table="a" column="opl_nach_by_ym" />
        
        <!--<column table="a" column="opl_nach_cust" />-->
        <column table="a" column="opl" />
        <column table="a" column="opl_per" />
        <column table="a" column="opl_avans"/>
        <column table="a" column="opl_avans_per" />
        <!--<column table="a" column="kredit_per" />
        <column table="a" column="kredit_end" />-->
        <column table="a" column="ostatok_end" />
      </select>
      <from>
        <query name="fingenbyt_united" as="a">
          <withparams>
            <call function="ym begin time">
              <const>2014.01</const>
            </call>
              <call function="ym end time">
                <const>2014.01</const>
              </call>
            <const>599179</const>
          </withparams>
        </query>
      </from>
    </query>


    <!--<array>
      2566815
    </array>-->
    <query name="fingenbyt_united" cstyle="union">
      <params>
        <param name="date1">
          <call function="ym begin time">
            <const>2014.01</const>
          </call>
        </param>
        <param name="date2">
          <call function="ym end time">
            <const>2014.06</const>
          </call>
        </param>
        <param name="kod_dog">
          <const>599179</const>
        </param>
        <param name="vid_real"></param>
        <param name="vid_t"></param>
        <param name="edizm"></param>
        <param name="typeopl"></param>
        <param name="vidopl"></param>
        <param name="vidt_col">
          <!--<array>77,22</array>-->
        </param>
        <param name="edizm_col">
          <!--<array>3,4</array>-->
        </param>
        <param name="typeopl_col"></param>
        <param name="vidopl_col"></param>
        <param name="kod_tipdog"></param>
      </params>
      <select>
        <column table="*" column="kod_dog" group="1"/>
        <column table="*" column="vid_t" group="1"/>
        <column table="*" column="vid_real" group="1"/>
        <column table="*" column="edizm" group="1"/>
        <column table="*" column="kod_opl" group="1"/>

        <!--вроде kod_opl_main не нужен в общих измерениях перенести в push с подключением через kod_opl-->
        <column table="*" column="kod_opl_main" group="1"/>
        <column table="*" column="kod_izv" group="1"/>
        <!--Бельченко: ym rym пока нигде не используются , может бвть вообще убрать-->
        <!--<column table="*" column="rym" group="1"/>-->
        <column table="*" column="ym" group="1"/>

        <column table="*" column="kod_numobj" group="1"/>
        <column table="kod_dog" column="ndog"  group="kod_dog"/>
        <column table="kod_dog" column="tep_el"  group="kod_dog"/>
        <column table="kod_vdog" column="kod_tipdog" group="1"/>
        <column table="vid_t" column="name" as="vid_t_name" group="vid_t"/>
        <column table="vid_t" column="num_t" group="vid_t"/>
        <column table="dep" column="kodp" as="dep" group="1"/>
        <column table="dep" column="name" as="dep_name" group="dep" title="Отделение"/>
        <column table="kodp" column="kodp" group="1"/>
        <column table="kodp" column="name" as="payer_name" title="Наименование абонента" group="kodp" />
        <column table="kodp" column="nump" as="payer_nump" title="Номер абонента" group="kodp" />
        <column table="kod_m" column="kod_m" as="kod_ministry" group="kodp"/>
        <column table="kod_m" column="name" as="ministry_name" group="kodp"/>
        <column table="kod_ist" column="kod_ist" as="kod_istfin" group="kodp" />
        <column table="kod_ist" column="name" as="istfin_name" title="Источник финансирования" group="kodp" />
        <column table="vid_real" column="name" as="vid_real_name" group="vid_real"/>

        <column table="kod_type_opl" column="name" as="typeopl_name" title="Тип оплаты" group="kod_opl" />
        
        <column table="kod_izv" column="num_izv" as="num_izv" group="kod_izv"/>
        <column table="kod_izv" column="date_izv" as="date_izv" group="kod_izv"/>
        <column table="kod_izv" column="ym" as="ym_nach" group="kod_izv"/>
        <column table="kod_opl_main" column="num_opl" group="kod_opl_main" />
        <column table="kod_opl_main" column="dat_opl" group="kod_opl_main" />
        <column table="kod_opl" column="ym" as="ym_opl" group="kod_opl"/>
        <column table="kod_opl_main" column="ym" as="ym_opl_main" group="kod_opl_main"/>
        <column table="kod_opl_main" column="kod_vidopl" group="kod_opl_main"/>
        <column table="kod_vidopl" column="full_name" as="vidopl_full_name" group="kod_opl_main"/>
        
        
        <column table="nach_bef" column="nachisl" as="nachisl_bef" group="sum" title=""/>
        <column table="opl_nach_bef" column="opl" as="opl_nach_bef" group="sum" title=""/>
        <!--<column table="nach_bef" column="nachisl_0" as="nachisl_0_bef" group="sum" title=""/>
        <column table="opl_nach_bef" column="opl_0" as="opl_0_bef" group="sum" title=""/>
        <column table="nach_bef" column="nachisl_2" as="nachisl_2_bef" group="sum" title=""/>
        <column table="opl_nach_bef" column="opl_2" as="opl_2_bef" group="sum" title=""/>-->

        <call function="-nvl" as="ostatok_beg" class-title="Сальдо на начало периода" title="Дебиторская задолженность, руб.">
          <column table="this" column="nachisl_bef"/>
          <column table="this" column="opl_nach_bef"/>
        </call>
        <!--<call function="-nvl" as="ostatok_0_beg" class-title="Сальдо на начало периода" title="Задолженность аванса, руб.">
          <column table="this" column="nachisl_0_bef"/>
          <column table="this" column="opl_0_bef"/>
        </call>
        <call function="-nvl" as="ostatok_2_beg" class-title="Сальдо на начало периода" title="Задолженность основная реализация, руб.">
          <column table="this" column="nachisl_2_bef"/>
          <column table="this" column="opl_2_bef"/>
        </call>-->
        <column table="opl_kredit_bef" column="opl_kred" as="kredit_beg" class-title="Сальдо на начало периода" title="Кредиторская задолженность, руб." group="sum"/>
        <!--<column table="nach_bef" column="ym_dolg" group="min"/>
        <column table="nach_period" column="ym_dolg" as="ym_dolg_per" group="min"/>-->
        <column table="nach_period" column="nachisl" group="sum"/>
        <!--<column table="nach_period" column="nal" group="sum"/>-->
        <column table="nach_period" column="nachisl_by_ym" group="sum"/>
        <!--<column table="nach_period" column="nachisl_0" as="nachisl_0" group="sum"/>
        <column table="nach_period" column="nachisl_0_30" group="sum"/>
        <column table="nach_period" column="nachisl_0_40" group="sum"/>-->
        
        <column table="nach_period" column="cust" group="sum"/>
        <column table="nach_period" column="nachisl_by_vid_t" group="sum"/>
        <column table="nach_period" column="cust_by_vid_t" group="sum"/>
        <!--<column table="nach_period" column="nachisl_by_edizm" group="sum"/>
        <column table="nach_period" column="cust_by_edizm" group="sum"/>-->

        <column table="opl_nach_period" column="opl" as="opl_nach" group="sum" title="Оплата начислений, руб."/>
        <column table="opl_nach_period" column="opl_by_ym" as="opl_nach_by_ym" group="sum" title="Оплата начислений, руб."/>
        <column table="opl_nach_period" column="cust" as="opl_nach_cust" group="sum"/>

        <column table="opl_period" column="opl" group="sum"/>
        <!--<column table="opl_period" column="oplf" group="sum"/>
        <column table="opl_period" column="oplf_by_ym" group="sum"/>-->
        <column table="opl_period" column="opl_per" group="sum"/>
        <!--<column table="opl_period" column="opl_storno_per" group="sum"/>-->
        <column table="opl_period" column="opl_pfact_per" group="sum"/>
        <column table="opl_period" column="opl_avans" group="sum"/>
        <column table="opl_period" column="opl_pfact_avans" group="sum"/>
        <!--<column table="opl_period" column="opl_storno_avans" group="sum"/>-->
        <column table="opl_period" column="opl_avans_per" group="sum"/>
        <!--<column table="opl_period" column="opl_storno_avans_per" group="sum"/>-->
        <column table="opl_period" column="opl_pfact_avans_per" group="sum"/>
        <column table="opl_period" column="opl_kred" as="kredit_per" group="sum"/>
        
        <!--<column table="opl_period" column="opl_kred_avans_no_pros" group="sum"/>-->
       

        <call function="+nvl" as="ostatok_end" class-title="Сальдо на конец периода"  title="Дебиторская задолженность, руб.">
          <column table="this" column="ostatok_beg" />
          <call function="-nvl" >
            <column table="this" column="nachisl"/>
            <column table="this" column="opl_nach"/>
          </call>
        </call>
        <call function="+nvl" as="kredit_end" class-title="Сальдо на конец периода">
          <column table="this" column="kredit_beg" />
          <column table="this" column="kredit_per" />
        </call>
        
        <!--<call function="+nvl" as="kredit_avans_end" class-title="Сальдо на конец периода">
          <column table="this" column="kredit_avans_beg" />
          <column table="this" column="opl_kred_avans_no_pros" />
        </call>-->
        
      </select>
      <from>

        <query name="fingenbyt_nach_period" as="nach_bef">
          <withparams>
            <call function="nativity"></call>
            <call function="-sec">
              <call function="nvlu">
                <useparam name="date1"/>
                <call function="nativity"/>
              </call>
            </call>
            <useparam name="vidt_col"/>
          </withparams>
        </query>

        <query name="fingenbyt_opl_nach_period" as="opl_nach_bef">
          <withparams>
            <call function="nativity"></call>
            <call function="-sec">
              <call function="nvlu">
                <useparam name="date1"/>
                <call function="nativity"/>
              </call>
            </call>
            <useparam name="vidt_col"/>
            <useparam name="typeopl"/>
            <useparam name="vidopl"/>
          </withparams>
        </query>

        <query name="fingenbyt_opl_period" as="opl_kredit_bef">
          <withparams>
            <call function="nativity"></call>
            <call function="-sec">
              <call function="nvlu">
                <useparam name="date1"/>
                <call function="nativity"/>
              </call>
            </call>
            <useparam name="typeopl"/>
            <useparam name="vidopl"/>
          </withparams>
        </query>
        
        <query name="fingenbyt_nach_period" as="nach_period" title="Начисления">
          <withparams>
            <useparam name="date1"/>
            <useparam name="date2"/>
            <useparam name="vidt_col"/>
          </withparams>
        </query>
        <query name="fingenbyt_opl_nach_period" as="opl_nach_period">
          <withparams>
            <useparam name="date1"/>
            <useparam name="date2"/>
            <useparam name="vidt_col"/>
            <useparam name="typeopl"/>
            <useparam name="vidopl"/>
          </withparams>
        </query>
        <query name="fingenbyt_opl_period" as="opl_period">
          <withparams>
            <useparam name="date1"/>
            <useparam name="date2"/>
            <useparam name="typeopl"/>
            <useparam name="vidopl"/>
          </withparams>
        </query>
      </from>
      <push>
        <from>
          <query name="kr_dogovor" as="kod_dog" join="left outer">
            <using>
              <column column="kod_dog"/>
            </using>
            <link name="dep"/>
            <link name="kodp">
              <link name="kod_m"/>
            </link>
            <link name="kod_vdog"/>
            <link name="kod_ist"/>
          </query>
          <query name="sk_nachisl" as="vid_t" join="left outer">
            <using>
              <column column="vid_t"/>
            </using>
          </query>
          <query name="sk_vid_real" as="vid_real" join="left outer">
            <using>
              <column column="vid_real" />
            </using>
          </query>
          <query name="tsr_opl" as="kod_opl" join="left outer">
            <using>
              <column column="kod_opl" />
            </using>
            <link name="kod_type_opl"/>
          </query>
          <query name="tsr_opl" as="kod_opl_main" join="left outer">
            <call function="=">
              <column table="*" column="kod_opl_main" />
              <column table="kod_opl_main" column="kod_opl" />
            </call>
            <link name="kod_vidopl" as="kod_vidopl"/>
          </query>
          <query name="kr_dopdoc" as ="kod_dopdoc" join="left outer">
            <using>
              <column column="kod_vidopl"/>
            </using>
          </query>
          <query name="tnr_izv" as="kod_izv" join="left outer">
            <using>
              <column column="kod_izv" />
            </using>
          </query>
        </from>
        <where>
          <call function="and">
            <call function="true"/>
            <call function="in" optional="1">
              <column table="*" column="kod_dog"/>
              <useparam name="kod_dog"/>
            </call>
            <call function="in" optional="1">
              <column table="vid_real" column="vid_real"/>
              <useparam name="vid_real"/>
            </call>
            <call function="in" optional="1">
              <column table="vid_t" column="vid_t"/>
              <useparam name="vid_t"/>
            </call>
          </call>
        </where>
      </push>
    </query>

          
    <query name="fingenbyt_nach_period">
      <params>
        <param name="date1">
          <const>sysdate-4000</const>
        </param>
        <param name="date2">
          <const>sysdate</const>
        </param>
        <param name="vidt_col">
          <const>25</const>
        </param>

      </params>
      <select>
        <column table="a" column="kod_account"/>
        <column table="a" column="kod_dog"/>
        <column table="a" column="kod_izv"/>
        <const as="kod_opl">null</const>
        <const as="kod_opl_main">null</const>
        <column table="a" column="vid_t"/>
        <column table="a" column="rym"/>
        <column table="a" column="ym" />
        <column table="a" column="kod_numobj" />
        <column table="a" column="tarif" />
        <column table="vid_t" column="vid_real" />
        <column table="vid_t" column="edizm" />

        <column table="a" column="price" />
        
        <call function="nvl0" as="nachisl">
          <column table="a" column="nachisl" />
        </call>
        <column table="a" column="cust" />
        
        <column table="a" column="nachisl" as="nachisl_by_ym" dimname="ym">
          <pivot title=" по периодам ">
            <column table="a" column="ym" group="1"/>
            <query order="ym">
              <select>
                <column table="ym_list" column="ym"/>
                <column table="ym_list" column="name"/>
              </select>
              <from>
                <query name="kr_calc_list" as="ym_list"/>
              </from>
              <where>
                <call function="or">
                  <call function="false"/>
                  <call function="between" optional="1">
                    <column table="ym_list" column="ym"/>
                    <call function="date to ym">
                      <useparam name="date1"/>
                    </call>
                    <call function="date to ym">
                      <useparam name="date2"/>
                    </call>
                  </call>
                </call>
              </where>
            </query>
          </pivot>
        </column>
        <column table="a" column="cust" as="cust_by_ym" dimname="ym"/>
        
        <column table="a"  column="nachisl" as="nachisl_by_vid_t" dimname="vid_t">
          <pivot title=" по видам товара">
            <column table="a" column="vid_t"/>
            <query order="full_name">
              <select>
                <column table="sk_nachisl" column="vid_t"/>
                <column table="sk_nachisl" column="full_name"/>
              </select>
              <from>
                <query name="sk_nachisl" as="sk_nachisl"/>
              </from>
              <where>
                <call function="or">
                  <call function="false"/>
                  <call function="in" optional="1">
                    <column table="sk_nachisl" column="vid_t"/>
                    <useparam name="vidt_col"/>
                  </call>
                </call>
              </where>
            </query>
          </pivot>
        </column>
        <column table="a" column="cust" as="cust_by_vid_t" dimname="vid_t"/>

      </select>
      <from>
        <query name="tnr_account" as="a">
          <link name="vid_t"/>
        </query>
      </from>
      <where>
        <call function="and">
          <call function="true"/>
          
          <call function="ge" optional="1">
            <column table="a" column="ym"/>
            <call function="date to ym">
              <useparam name="date1"/>
            </call>
          </call>
          <call function="le" optional="1">
            <column table="a" column="ym"/>
            <call function="date to ym">
              <useparam name="date2"/>
            </call>
          </call>
        </call>
      </where>
    </query>


    <!--<array>162,270,297,401,775,834,1009,1039,1771,2021,10010863,10019549</array>-->
    <query name="fingenbyt_opl_nach_period" title="Оплата">
      <params>
        <param name="date1">
          <const>sysdate-4000</const>
        </param>
        <param name="date2">
          <const>sysdate</const>
        </param>
        <param name="vidt_col">
        </param>
        <param name="typeopl_col"></param>
        <param name="vidopl_col"></param>
      </params>
      <select>
        <column table="a" column="kod_account"/>
        <column table="kod_opl" column="kod_dog" />
        <column table="kod_opl" column="kod_izv"/>
        <const as="vid_t">null</const>
        <const as="edizm">null</const>
        <column table="kod_opl" column="ym" />
        <column table="kod_opl" column="kod_numobj" />
        <column table="kod_opl" column="vid_real" />
        <column table="kod_opl" column="kod_opl" />
        <call function="nvl" as="kod_opl_main">
          <column table="kod_opl" column="kod_parent" />
          <column table="kod_opl" column="kod_opl" />
        </call>
        <column table="kod_opl" column="num_opl"/>
        <column table="kod_opl" column="dat_opl"/>

        <column table="a" column="opl" title="Оплачено, руб." nvl="0" />

        <column table="a"  column="opl" as="opl_by_ym" dimname="ym">
          <pivot title=" по периодам ">
            <column table="kod_opl" column="ym" group="1"/>
            <query order="ym">
              <select>
                <column table="ym_list" column="ym"/>
                <column table="ym_list" column="name"/>
              </select>
              <from>
                <query name="kr_calc_list" as="ym_list"/>
              </from>
              <where>
                <call function="or">
                  <call function="false"/>
                  <call function="between" optional="1">
                    <column table="ym_list" column="ym"/>
                    <call function="date to ym">
                      <useparam name="date1"/>
                    </call>
                    <call function="date to ym">
                      <useparam name="date2"/>
                    </call>
                  </call>
                </call>
              </where>
            </query>
          </pivot>
        </column>
        <column table="a" column="cust_o" as="cust" title="Оплачено, нат. пок." />

        <!--<column table="a" column="nal" title="Оплачено, руб. (налоги)" />
        <call function="-" as="opl_not_nal" title="Оплачено, руб. (без налогов)">
          <column table="a" column="opl" />
          <column table="a" column="nal" />
        </call>-->

        <column table="a" column="opl" as="opl_by_typeopl"  dimname="kod_type_opl">
          <pivot title=" по типам оплат">
            <column table="kod_opl" column="kod_type_opl"/>
            <query order="name">
              <select>
                <column table="sk_type_opl" column="kod_type_opl"/>
                <column table="sk_type_opl" column="name"/>
              </select>
              <from>
                <query name="sk_type_opl" as="sk_type_opl"/>
              </from>
              <where>
                <call function="or">
                  <call function="false"/>
                  <call function="in" optional="1">
                    <column table="sk_type_opl" column="kod_type_opl"/>
                    <useparam name="typeopl_col"/>
                  </call>
                </call>
              </where>
            </query>
          </pivot>
        </column>

        <column table="a" column="opl" as="opl_by_vidopl"  dimname="kod_vidopl">
          <pivot title=" по видам оплат">
            <column table="kod_opl" column="kod_vidopl"/>
            <query order="full_name">
              <select>
                <column table="ss_vidopl" column="kod_vidopl"/>
                <column table="ss_vidopl" column="full_name"/>
              </select>
              <from>
                <query name="ss_vidopl" as="ss_vidopl"/>
              </from>
              <where>
                <call function="or">
                  <call function="false"/>
                  <call function="in" optional="1">
                    <column table="ss_vidopl" column="kod_vidopl"/>
                    <useparam name="vidopl_col"/>
                  </call>
                </call>
              </where>
            </query>
          </pivot>
        </column>
        
      </select>
      <from>
        <query name="tnr_accopl" as="a">
          <link name="kod_opl">
          </link>
        </query>
      </from>
      <where>
        <call function="and">
          <call function="true"/>
          <call function="ge" optional="1">
            <column table="kod_opl" column="dat_oper"/>
            <useparam name="date1"/>
          </call>
          <call function="le" optional="1">
            <column table="kod_opl" column="dat_oper"/>
            <useparam name="date2"/>
          </call>
        </call>
      </where>
    </query>

    <query name="fingenbyt_opl_period" title="Оплата">
      <params>
        <param name="date1">
          <const>sysdate-4000</const>
        </param>
        <param name="date2">
          <const>sysdate</const>
        </param>
        <param name="typeopl"></param>
        <param name="vidopl"></param>
      </params>
      <select>
        <column table="kod_opl" column="kod_dog" />
        <column table="kod_opl" column="ym" />
        <const as="vid_t">null</const>
        <const as="edizm">null</const>
        <column table="kod_opl" column="kod_numobj" />
        <column table="kod_opl" column="kod_opl" />
        <call function="nvl" as="kod_opl_main">
          <column table="kod_opl" column="kod_parent" />
          <column table="kod_opl" column="kod_opl" />
        </call>
        <column table="kod_opl" column="kod_izv" />
        <!--Наверное нужно завести 2 разные колонки vid_real, одна будет показывать (opl.vid_real)  а другая 2-ку по авансам и переплатам чтобы аванс садился в кредит по основной-->
        <call function="if" as="vid_real">
          <call function="=">
            <column table="kod_opl" column="vid_real"/>
            <const>0</const>
          </call>
          <const>2</const>
          <column table="kod_opl" column="vid_real"/>
        </call>

        <column table="kod_opl" column="opl" />
               
        <call function="if" as="opl_per" title="Переплата, руб.">
          <call function="=">
            <column table="kod_opl" column="kod_type_opl"/>
            <const>1</const>
          </call>
          <column table="this" column="opl" />
        </call>
        
        <call function="if" as="opl_pfact_per" title="Погашение факта переплатой, руб.">
          <call function="=">
            <column table="kod_opl" column="kod_type_opl"/>
            <const>3</const>
          </call>
          <column table="this" column="opl" />
        </call>
        
        <!--<call function="if" as="opl_storno_per" title="Сторно переплаты, руб.">
          <call function="=">
            <column table="kod_opl" column="kod_type_opl"/>
            <const>5</const>
          </call>
          <column table="kod_opl" column="oplf" />
        </call>-->
        
        <call function="if" as="opl_avans" title="Аванс, руб.">
          <call function="=">
            <column table="kod_opl" column="kod_type_opl"/>
            <const>2</const>
          </call>
          <column table="this" column="opl" />
        </call>
        
        <!--<call function="if" as="opl_avans_as_per" title="Аванс как переплата, руб.">
          <call function="and">
            <call function="=">
              <column table="kod_opl" column="kod_type_opl"/>
              <const>2</const>
            </call>
            <call function="and">
              <call function="is not null">
                <column table="kod_sf" column="dat_ezad"/>
              </call>
              <call function="ge" optional="1">
                <useparam name="date2"/>
                <column table="kod_sf" column="dat_ezad"/>
              </call>
            </call>
          </call>
          <column table="kod_opl" column="oplf" />
          <const>0</const>
        </call>-->
        <call function="if" as="opl_pfact_avans" title="Погашение факта авансом, руб.">
          <call function="=">
            <column table="kod_opl" column="kod_type_opl"/>
            <const>4</const>
          </call>
          <column table="this" column="opl" />
        </call>
        
        <!--<call function="if" as="opl_storno_avans" title="Сторно аванса, руб.">
          <call function="=">
            <column table="kod_opl" column="kod_type_opl"/>
            <const>6</const>
          </call>
          <column table="kod_opl" column="oplf" />
        </call>-->
        
        <!--<call function="if" as="opl_storno_avans_as_per" title="Сторно аванса как переплата, руб.">
          <call function="and">
            <call function="=">
              <column table="kod_opl" column="kod_type_opl"/>
              <const>6</const>
            </call>
            <call function="and">
              <call function="is not null">
                <column table="kod_sf" column="dat_ezad"/>
              </call>
              <call function="ge" optional="1">
                <useparam name="date2"/>
                <column table="kod_sf" column="dat_ezad"/>
              </call>
            </call>
          </call>
          <column table="kod_opl" column="oplf" />
        </call>-->
        
        <!--<call function="+" as="opl_storno_avans_per" title="Сторно переплаты и аванса, руб.">
          <column table="this" column="opl_storno_per" />
          <column table="this" column="opl_storno_avans" />
        </call>-->
        <call function="+" as="opl_pfact_avans_per" title="Погашение факта переплатой и авансом, руб.">
          <column table="this" column="opl_pfact_per" />
          <column table="this" column="opl_pfact_avans" />
        </call>
        <call function="+" as="opl_avans_per" title="Переплата и аванс, руб.">
          <column table="this" column="opl_per" />
          <column table="this" column="opl_avans" />
        </call>
        <call function="if" as="opl_kred" title="Кредит, руб.">
          <call function="in">
            <column table="kod_opl" column="kod_type_opl"/>
            <const>(1,2,5,6)</const>
          </call>
          <call function="+nvl">
            <column table="this" column="opl" />
            <!--<column table="kod_opl" column="opls" />-->
            <const>0</const>
          </call>
        </call>
        <!--<call function="+" as="opl_kred_per" title="Кредит переплата, руб.">
          <column table="this" column="opl_per" />
          <column table="this" column="opl_storno_per"/>
        </call>-->
        <!--<call function="+" as="opl_kred_per_avans" title="Кредит переплата и авансы прошлых периодов, руб.">
          <column table="this" column="opl_per" />
          <column table="this" column="opl_storno_per"/>
          <column table="this" column="opl_avans_as_per" />
          <column table="this" column="opl_storno_avans_as_per"/>
        </call>
        <call function="+" as="opl_kred_avans" title="Кредит аванса, руб.">
          <column table="this" column="opl_avans" />
          <column table="this" column="opl_storno_avans"/>
        </call>
        <call function="-" as="opl_kred_avans_no_pros" title="Кредит аванса без авансов прошлых периодов, руб.">
          <column table="this" column="opl_kred_avans" />
          <column table="this" column="opl_avans_as_per"/>
          <column table="this" column="opl_storno_avans_as_per"/>
        </call>-->

        <!--Задаток-->
        <!--<call function="if" as="opl_zadat" title="Задаток, руб.">
          <call function="and">
            <call function="=">
              <column table="kod_opl" column="kod_type_opl"/>
              <const>2</const>
            </call>
            <call function="=">
              <column table="kod_opl" column="vid_real"/>
              <const>1</const>
            </call>
            <call function="gt">
              <column table="this" column="opl" />
              <const>0</const>
            </call>
          </call>
          <column table="this" column="opl" />
        </call>
        <call function="if" as="opl_storno_zadat" title="Сторно задатка, руб.">
          <call function="and">
            <call function="=">
              <column table="kod_opl" column="kod_type_opl"/>
              <const>6</const>
            </call>
            <call function="=">
              <column table="kod_opl" column="vid_real"/>
              <const>1</const>
            </call>
          </call>
          <column table="kod_opl" column="oplf" />
        </call>
        
        <call function="if" as="opl_zadat_2" title="Задаток на основную реализацию, руб.">
          <call function="and">
            <call function="=">
              <column table="this" column="pr_raznos"/>
              <const>1</const>
            </call>
            <call function="=">
              <column table="kod_opl" column="vid_real"/>
              <const>2</const>
            </call>
            <call function="=">
              <column table="kod_opl_master" column="vid_real"/>
              <const>1</const>
            </call>
          </call>
          <column table="kod_opl" column="oplf" />
        </call>

        <call function="if" as="opl_zadat_0" title="Задаток на аванс, руб.">
          <call function="and">
            <call function="=">
              <column table="this" column="pr_raznos"/>
              <const>1</const>
            </call>
            <call function="=">
              <column table="kod_opl" column="vid_real"/>
              <const>0</const>
            </call>
            <call function="=">
              <column table="kod_opl_master" column="vid_real"/>
              <const>1</const>
            </call>
          </call>
          <column table="kod_opl" column="oplf" />
        </call>

        <call function="if" as="opl_zadat_fk" title="Финансовая корректировка задатка, руб.">
          <call function="and">
            <call function="=">
              <column table="this" column="pr_raznos"/>
              <const>0</const>
            </call>
            <call function="=">
              <column table="kod_opl_master" column="vid_real"/>
              <const>1</const>
            </call>
          </call>
          <column table="kod_opl" column="oplf" />
        </call>
        
        <call function="+" as="opl_kred_zadat" title="Кредит задатка, руб.">
          <column table="this" column="opl_zadat" />
          <column table="this" column="opl_storno_zadat"/>
          <column table="this" column="opl_zadat_fk"/>
        </call>-->
        
      </select>
      <from>
        <query name="tsr_opl" as="kod_opl">
        </query>
      </from>
      <where>
        <call function="and">
          <call function="true"/>
          <call function="ge" optional="1">
            <column table="kod_opl" column="ym"/>
            <call function="date to ym">
              <useparam name="date1"/>
            </call>
          </call>
          <call function="le" optional="1">
             <column table="kod_opl" column="ym"/>
            <call function="date to ym">
              <useparam name="date2"/>
            </call>
          </call>
          <call function="in" optional="1">
            <column table="kod_opl" column="kod_type_opl"/>
            <useparam name="typeopl"/>
          </call>
          <call function="in" optional="1">
            <column table="kod_opl" column="kod_vidopl"/>
            <useparam name="vidopl"/>
          </call>
        </call>
      </where>
    </query>

  </queries>

</root>