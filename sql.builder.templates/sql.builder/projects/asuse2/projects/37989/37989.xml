<?xml version="1.0" encoding="utf-8"?>
<root>
  <queries>
    <query name="37989-dat" timestamp="22.10.2018 19:37:57" use-repository="1" is-report="1" materialize="1">
      <params>
        <usepart part="37989-params" />
      </params>
      <expressions>
        <call function="lt" as="is_dolg" dontpushpred="1">
          <column table="kod_sf" column="dat_bzad_uved_kaz_el" />
          <useparam name="p_dat" />
        </call>
        <call function="le" as="is_do_dat" dontpushpred="1">
          <column table="dat" column="val" />
          <useparam name="p_dat" />
        </call>
        <call function="and" as="is_not_dolg" dontpushpred="1">
          <call function="ge" dontpushpred="1">
            <call function="nvl">
              <column table="kod_sf" column="dat_bzad_uved_kaz_el" />
              <call function="doomsday" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <column table="kod_deb" column="dat_deb" />
            <useparam name="p_dat" />
          </call>
        </call>
        <call function="and" as="is_av_pr" dontpushpred="1">
          <call function="lt">
            <call function="nvl">
              <column table="kod_sf" column="dat_ezad_uved_kaz_el" />
              <call function="doomsday" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <column table="dat" column="val" />
            <useparam name="p_dat" />
          </call>
          <call function="in" dontpushpred="1">
            <column table="vid_real" column="vid_real" />
            <array>0</array>
          </call>
        </call>
        <call function="and" as="is_av_ftr" dontpushpred="1">
          <call function="ge" dontpushpred="1">
            <column table="kod_sf" column="dat_bzad_uved_kaz_el" />
            <useparam name="p_dat" />
          </call>
          <call function="ge">
            <call function="nvl">
              <column table="kod_sf" column="dat_ezad_uved_kaz_el" />
              <call function="doomsday" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <column table="dat" column="val" />
            <useparam name="p_dat" />
          </call>
          <call function="in" dontpushpred="1">
            <column table="vid_real" column="vid_real" />
            <array>0</array>
          </call>
        </call>
        <call function="and" as="is_av_ftr1" dontpushpred="1">
          <call function="ge" dontpushpred="1">
            <column table="kod_sf" column="dat_bzad_uved_kaz_el" />
            <useparam name="p_dat" />
          </call>
          <call function="ge">
            <call function="nvl">
              <column table="kod_sf" column="dat_ezad_uved_kaz_el" />
              <call function="doomsday" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <column table="dat" column="val" />
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <column table="kod_sf" column="dat_sf" />
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <call function="nvl">
              <column table="kod_deb" column="dat_deb" />
              <useparam name="p_dat" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="in" dontpushpred="1">
            <column table="vid_real" column="vid_real" />
            <array>0</array>
          </call>
        </call>
        <call function="and" as="is_av_tek" dontpushpred="1">
          <call function="lt" dontpushpred="1">
            <column table="kod_sf" column="dat_bzad_uved_kaz_el" />
            <useparam name="p_dat" />
          </call>
          <call function="ge">
            <call function="nvl">
              <column table="kod_sf" column="dat_ezad_uved_kaz_el" />
              <call function="doomsday" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <call function="nvl">
              <column table="kod_deb" column="dat_deb" />
              <useparam name="p_dat" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <column table="dat" column="val" />
            <useparam name="p_dat" />
          </call>
          <call function="in" dontpushpred="1">
            <column table="vid_real" column="vid_real" />
            <array>0</array>
          </call>
        </call>
        <call function="and" as="is_mon1" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_sf" column="rym" />
            <useparam name="p_ym" />
          </call>
        </call>
        <call function="and" as="is_mon0" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_sf" column="rym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-1</const>
            </call>
          </call>
        </call>
        <call function="and" as="is_mon_pred_osn" dontpushpred="1">
          <call function="lt" dontpushpred="1">
            <column table="kod_sf" column="ym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-2</const>
            </call>
          </call>
        </call>
        <call function="and" as="is_mon_tek_osn" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_sf" column="ym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-1</const>
            </call>
          </call>
        </call>
        <call function="and" as="is_mon_sled_osn" dontpushpred="1">
          <call function="gt" dontpushpred="1">
            <column table="kod_sf" column="ym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-1</const>
            </call>
          </call>
        </call>
        <call function="and" as="is_mon_pred1_osn" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_sf" column="ym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-2</const>
            </call>
          </call>
        </call>
        <call function="and" as="is_fst" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_sf" column="perc" />
            <const>30</const>
          </call>
        </call>
        <call function="and" as="is_scnd" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_sf" column="perc" />
            <const>40</const>
          </call>
        </call>
        <call function="and" as="is_virt_tek" dontpushpred="1">
          <call function="lt" dontpushpred="1">
            <column table="kod_avans_uved" column="dat_bzad_uved_kaz_el" />
            <useparam name="p_dat" />
          </call>
          <call function="ge">
            <column table="kod_avans_uved" column="dat_ezad" />
            <useparam name="p_dat" />
          </call>
        </call>
        <call function="and" as="is_virt_mon1" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_avans_uved" column="rym" />
            <useparam name="p_ym" />
          </call>
        </call>
        <call function="and" as="is_virt_mon0" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_avans_uved" column="rym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-1</const>
            </call>
          </call>
        </call>
        <call function="and" as="is_virt_fst" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_avans_uved" column="perc" />
            <const>30</const>
          </call>
        </call>
        <call function="and" as="is_virt_scnd" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_avans_uved" column="perc" />
            <const>40</const>
          </call>
        </call>
        <call function="and" as="is_othr_av" dontpushpred="1">
          <call function="not in" dontpushpred="1">
            <call function="nvl">
              <column table="kod_sf" column="perc" />
              <const>0</const>
            </call>
            <array>30,40</array>
          </call>
        </call>
        <call function="is null" as="is_used_state" exclude="1">
          <call function="if">
            <call function="le">
              <column table="kod_debet_state" column="dat_ust" />
            </call>
          </call>
        </call>
        <call function="and" as="is_3m" dontpushpred="1">
          <call function="between" dontpushpred="1">
            <column table="kod_sf" column="ym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-3</const>
            </call>
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-1</const>
            </call>
          </call>
        </call>
        <call function="and" as="is_1m" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_sf" column="ym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-1</const>
            </call>
          </call>
        </call>
        <call function="()" as="nach_osn_3m" group="sum" type="number">
          <fact column="fin_ul_nachisl_osn" condition="is_3m" />
        </call>
        <call function="()" as="nach_osn_1m" group="sum" type="number">
          <fact column="fin_ul_nachisl_osn" condition="is_1m" />
        </call>
        <call function="()" as="opl_sf_osn_do_dat" group="sum" type="number">
          <fact column="fin_ul_opl_sf_osn" condition="is_do_dat" />
        </call>
        <call function="()" as="nach_osn_do_dat" group="sum" type="number">
          <fact column="fin_ul_nachisl_osn" condition="is_do_dat" />
        </call>
        <call function="()" as="opl_sf_av_do_dat" group="sum" type="number">
          <fact column="fin_ul_opl_sf_av" condition="is_do_dat" exclude="1" />
          <fact column="fin_ul_opl_kred_av" condition="is_do_dat" />
        </call>
        <call function="()" as="nach_osn_pr" group="sum" type="number">
          <fact column="fin_ul_nachisl_osn" condition="is_dolg" />
        </call>
        <call function="0-" as="opl_osn_pr" group="sum" type="number">
          <fact column="opl_sf_osn_do_dat" condition="is_dolg" />
        </call>
        <call function="()" as="nach_osn_np" group="sum" type="number">
          <fact column="nach_osn_do_dat" condition="is_not_dolg" />
        </call>
        <call function="0-" as="opl_osn_np" group="sum" type="number">
          <fact column="opl_sf_osn_do_dat" condition="is_not_dolg" />
        </call>
        <call function="+nvl" as="dlg_osn_pr" group="sum">
          <fact column="nach_osn_pr" />
          <fact column="opl_osn_pr" />
        </call>
        <call function="()" as="dlg_osn_pr_cur" group="sum">
          <fact column="dlg_osn_pr" condition="is_mon_tek_osn" />
        </call>
        <call function="()" as="dlg_osn_pr_nxt" group="sum">
          <fact column="dlg_osn_pr" condition="is_mon_sled_osn" />
        </call>
        <call function="()" as="dlg_osn_pr_pred1" group="sum">
          <fact column="dlg_osn_pr" condition="is_mon_pred1_osn" />
        </call>
        <call function="()" as="dlg_osn_pr_pred" group="sum">
          <fact column="dlg_osn_pr" condition="is_mon_pred_osn" />
        </call>
        <call function="+nvl" as="dlg_osn_np" group="sum">
          <fact column="nach_osn_np" />
          <fact column="opl_osn_np" />
        </call>
        <call function="()" as="dlg_osn_np_cur" group="sum">
          <fact column="dlg_osn_np" condition="is_mon_tek_osn" />
        </call>
        <call function="0-" as="kred_osn" group="sum" type="number">
          <fact column="fin_ul_ob_kr_os" condition="is_do_dat" />
        </call>
        <call function="0-" as="kred_av" group="sum" type="number">
          <fact column="fin_ul_ob_kr_av" condition="is_do_dat" />
        </call>
        <call function="()" as="kred_av_pr" group="sum" type="number">
          <fact column="kred_av" condition="is_av_pr" />
        </call>
        <call function="()" as="kred_av_ftr" group="sum" type="number">
          <fact column="kred_av" condition="is_av_ftr" />
        </call>
        <call function="()" as="nach_av_tek" group="sum" type="number">
          <fact column="fin_ul_nachisl_av" condition="is_av_tek" />
        </call>
        <call function="()" as="nach_av_ftr" group="sum" type="number">
          <fact column="fin_ul_nachisl_av" condition="is_av_ftr1" />
        </call>
        <call function="0-" as="opl_av_tek" group="sum" type="number">
          <fact column="opl_sf_av_do_dat" condition="is_av_tek" />
        </call>
        <call function="0-" as="opl_av_ftr" group="sum" type="number">
          <fact column="opl_sf_av_do_dat" condition="is_av_ftr1" />
        </call>
        <call function="0-" as="stor_av_tek" group="sum" type="number">
          <fact column="sr_opl_opl_stor" condition="is_av_tek" />
        </call>
        <call function="+nvl" group="sum" as="dlg_av_tek">
          <fact column="nach_av_tek" />
          <fact column="opl_av_tek" />
        </call>
        <call function="+nvl" group="sum" as="dlg_av_ftr">
          <fact column="nach_av_ftr" />
          <fact column="opl_av_ftr" />
        </call>
        <call function="+nvl" group="sum" as="kred_av_tek">
          <fact column="opl_av_tek" />
          <fact column="stor_av_tek" />
        </call>
        <call function="()" as="nach_av_tek_fst" group="sum" type="number" exclude="1">
          <fact column="nach_av_tek" condition="is_fst" />
        </call>
        <call function="()" as="nach_av_tek_scnd" group="sum" type="number" exclude="1">
          <fact column="nach_av_tek" condition="is_scnd" />
        </call>
        <call function="()" as="nach_av_tek_othr" group="sum" type="number" exclude="1">
          <fact column="nach_av_tek" condition="is_othr" />
        </call>
        <call function="()" as="nach_av_tek_cur" group="sum" type="number">
          <fact column="nach_av_tek" condition="is_mon1" />
        </call>
        <call function="()" as="opl_av_tek_cur" group="sum" type="number">
          <fact column="opl_av_tek" condition="is_mon1" />
        </call>
        <call function="()" as="stor_av_tek_cur" group="sum" type="number">
          <fact column="stor_av_tek" condition="is_mon1" />
        </call>
        <call function="()" as="dlg_av_tek_cur" group="sum" type="number">
          <fact column="dlg_av_tek" condition="is_mon1" />
        </call>
        <call function="()" as="kred_av_tek_cur" group="sum" type="number">
          <fact column="kred_av_tek" condition="is_mon1" />
        </call>
        <call function="()" as="nach_av_tek_prev" group="sum" type="number">
          <fact column="nach_av_tek" condition="is_mon0" />
        </call>
        <call function="()" as="opl_av_tek_prev" group="sum" type="number">
          <fact column="opl_av_tek" condition="is_mon0" />
        </call>
        <call function="()" as="stor_av_tek_prev" group="sum" type="number">
          <fact column="stor_av_tek" condition="is_mon0" />
        </call>
        <call function="()" as="dlg_av_tek_prev" group="sum" type="number">
          <fact column="dlg_av_tek" condition="is_mon0" />
        </call>
        <call function="()" as="kred_av_tek_prev" group="sum" type="number">
          <fact column="kred_av_tek" condition="is_mon0" />
        </call>
        <call function="()" as="nach_av_tek_cur_fst" group="sum" type="number">
          <fact column="nach_av_tek_cur" condition="is_fst" />
        </call>
        <call function="()" as="opl_av_tek_cur_fst" group="sum" type="number">
          <fact column="opl_av_tek_cur" condition="is_fst" />
        </call>
        <call function="()" as="stor_av_tek_cur_fst" group="sum" type="number">
          <fact column="stor_av_tek_cur" condition="is_fst" />
        </call>
        <call function="()" as="dlg_av_tek_cur_fst" group="sum" type="number">
          <fact column="dlg_av_tek_cur" condition="is_fst" />
        </call>
        <call function="()" as="kred_av_tek_cur_fst" group="sum" type="number">
          <fact column="kred_av_tek_cur" condition="is_fst" />
        </call>
        <call function="()" as="nach_av_tek_prev_fst" group="sum" type="number">
          <fact column="nach_av_tek_prev" condition="is_fst" />
        </call>
        <call function="()" as="opl_av_tek_prev_fst" group="sum" type="number">
          <fact column="opl_av_tek_prev" condition="is_fst" />
        </call>
        <call function="()" as="stor_av_tek_prev_fst" group="sum" type="number">
          <fact column="stor_av_tek_prev" condition="is_fst" />
        </call>
        <call function="()" as="dlg_av_tek_prev_fst" group="sum" type="number">
          <fact column="dlg_av_tek_prev" condition="is_fst" />
        </call>
        <call function="()" as="kred_av_tek_prev_fst" group="sum" type="number">
          <fact column="kred_av_tek_prev" condition="is_fst" />
        </call>
        <call function="()" as="nach_av_tek_cur_scnd" group="sum" type="number">
          <fact column="nach_av_tek_cur" condition="is_scnd" />
        </call>
        <call function="()" as="opl_av_tek_cur_scnd" group="sum" type="number">
          <fact column="opl_av_tek_cur" condition="is_scnd" />
        </call>
        <call function="()" as="stor_av_tek_cur_scnd" group="sum" type="number">
          <fact column="stor_av_tek_cur" condition="is_scnd" />
        </call>
        <call function="()" as="dlg_av_tek_cur_scnd" group="sum" type="number">
          <fact column="dlg_av_tek_cur" condition="is_scnd" />
        </call>
        <call function="()" as="kred_av_tek_cur_scnd" group="sum" type="number">
          <fact column="kred_av_tek_cur" condition="is_scnd" />
        </call>
        <call function="()" as="nach_av_tek_prev_scnd" group="sum" type="number">
          <fact column="nach_av_tek_prev" condition="is_scnd" />
        </call>
        <call function="()" as="opl_av_tek_prev_scnd" group="sum" type="number">
          <fact column="opl_av_tek_prev" condition="is_scnd" />
        </call>
        <call function="()" as="stor_av_tek_prev_scnd" group="sum" type="number">
          <fact column="stor_av_tek_prev" condition="is_scnd" />
        </call>
        <call function="()" as="dlg_av_tek_prev_scnd" group="sum" type="number">
          <fact column="dlg_av_tek_prev" condition="is_scnd" />
        </call>
        <call function="()" as="kred_av_tek_prev_scnd" group="sum" type="number">
          <fact column="kred_av_tek_prev" condition="is_scnd" />
        </call>
        <call function="()" as="virt_av_tek" group="sum" type="number">
          <fact column="sr_avans_uved_avans" condition="is_virt_tek" />
        </call>
        <call function="()" as="virt_av_tek_prev" group="sum" type="number">
          <fact column="virt_av_tek" condition="is_virt_mon0" />
        </call>
        <call function="()" as="virt_av_tek_prev_fst" group="sum" type="number">
          <fact column="virt_av_tek_prev" condition="is_virt_fst" />
        </call>
        <call function="()" as="virt_av_tek_prev_scnd" group="sum" type="number">
          <fact column="virt_av_tek_prev" condition="is_virt_scnd" />
        </call>
        <call function="()" as="virt_av_tek_cur" group="sum" type="number">
          <fact column="virt_av_tek" condition="is_virt_mon1" />
        </call>
        <call function="()" as="virt_av_tek_cur_fst" group="sum" type="number">
          <fact column="virt_av_tek_cur" condition="is_virt_fst" />
        </call>
        <call function="()" as="virt_av_tek_cur_scnd" group="sum" type="number">
          <fact column="virt_av_tek_cur" condition="is_virt_scnd" />
        </call>
        <call function="()" as="nach_av_tek_othr" group="sum" type="number">
          <fact column="nach_av_tek" condition="is_othr_av" />
        </call>
        <call function="()" as="opl_av_tek_othr" group="sum" type="number">
          <fact column="opl_av_tek" condition="is_othr_av" />
        </call>
        <call function="()" as="stor_av_tek_othr" group="sum" type="number">
          <fact column="stor_av_tek" condition="is_othr_av" />
        </call>
        <call function="()" as="dlg_av_tek_othr" group="sum" type="number">
          <fact column="dlg_av_tek" condition="is_othr_av" />
        </call>
        <call function="()" as="dlg_av_tek_prev_othr" group="sum" type="number">
          <fact column="dlg_av_tek_prev" condition="is_othr_av" />
        </call>
        <call function="()" as="kred_av_tek_othr" group="sum" type="number">
          <fact column="kred_av_tek" condition="is_othr_av" />
        </call>
        <call function="()" as="sld_av_ftr_othr" group="sum" type="number">
          <fact column="dlg_av_ftr" condition="is_othr_av" />
        </call>
      </expressions>
      <select>
        <call function="||" as="id" key="1">
          <column table="this" column="kod_dog" />
          <const>'-'</const>
          <column table="this" column="kod_sf" />
          <const>'-'</const>
          <column table="this" column="kod_opl" />
        </call>
        <column table="kod_dog_fin" column="ndog" />
        <column table="vid_real" column="vid_real" />
        <column table="vid_real" column="name" as="vid_real_name" />
        <call function="()" as="ym_rasch" type="number">
          <useparam name="p_ym" />
        </call>
        <band title="Настройки">
          <column table="nastr" column="virt_avans" as="set_virt_avans" />
          <column table="nastr" column="pereplata" as="set_pereplata" />
          <column table="nastr" column="pereplata_current" as="set_pereplata_cur" />
          <column table="nastr" column="pereplata_future" as="set_pereplata_ftr" />
          <column table="nastr" column="oplata_virt_avans" as="set_opl_virt_av" />
        </band>
        <band title="Документ начисления">
          <column table="kod_sf" column="kod_sf" />
          <column table="kod_sf" column="name" as="sf_name" />
          <column table="kod_sf" column="kod_deb" />
          <column table="kod_sf" column="dat_sf" />
          <column table="kod_sf" column="ym" />
          <column table="kod_sf" column="rym" title="Период потребления" />
          <column table="kod_deb" column="dat_bzad" />
          <column table="kod_deb" column="name1" as="deb_name" />
          <column table="kod_deb" column="dat_deb" />
          <column table="kod_sf" column="dat_ezad" />
          <column table="kod_sf" column="perc1" as="perc" />
        </band>
        <column table="kod_dog_fin" column="dep" />
        <column table="kod_dog_fin" column="kod_dog" />
        <fact column="kr_vd_pr_illegal_av" as="pr_virt_av" title="Признак применения виртуальных авансов" />
        <call function="if" as="pr_legal_av" type="number" exclude="1">
          <call function="and">
            <call function="=0">
              <column table="kod_sf" column="vid_real" />
            </call>
            <call function="in">
              <column table="this" column="perc" />
              <array>30,40</array>
            </call>
          </call>
          <const>1</const>
        </call>
        <fact column="kr_vd_pr_3040_av" as="pr_3040_av" />
        <call as="dlg_deb" function="+nvl" title="Долг по документу">
          <fact column="dlg_osn_pr" title="Просроченный" table="sf" />
          <fact column="dlg_av_tek" title="Просроченный" table="sf" />
        </call>
        <fact column="nach_osn_3m" table="sf" />
        <fact column="nach_osn_1m" title="Просроченный" table="sf" />
        <fact column="dlg_osn_pr" title="Просроченный" table="sf" />
        <fact column="dlg_av_tek" title="Просроченный" table="sf" />
        <fact column="opl_osn_pr" title="Просроченный" table="sf" />
        <call as="dlg_kred" function="+nvl" title="Кред. задолженность">
          <fact column="kred_osn" title="Просроченный" table="kred" />
          <fact column="kred_av" title="Просроченный" table="kred" />
        </call>
        <band title="Задолженность по основной реализации">
          <fact column="dlg_osn_pr_pred" title="Ранее" table="sf" />
          <fact column="dlg_osn_pr_pred1" title="За предыдущий период" table="sf" />
          <band title="Окончательный платеж">
            <fact column="dlg_osn_pr_cur" title="Просроченный" table="sf" />
            <fact column="dlg_osn_np_cur" title="Не просроченный" table="sf" />
          </band>
          <fact column="dlg_osn_pr_nxt" title="Следующий период" table="sf" />
        </band>
        <band title="Кредиторская задолженность">
          <column table="kod_opl_kred" column="kod_opl" />
          <column table="kod_opl_kred" column="dat_opl" title="Дата оплаты" />
          <fact column="kred_osn" title="Переплата" table="kred" />
          <fact column="kred_av_pr" title="Авансы прошлых периодов (наступила дата окончания действия)" table="kred" />
          <fact column="kred_av_ftr" title="Авансы будущих периодов (дата оплаты не наступила)" table="kred" />
          <fact column="kred_av_tek" title="Авансы текущие" table="kred" />
        </band>
        <band title="Реальные авансы 30% 40%">
          <band title="Прошлый период">
            <band title="1-й платеж (30%)">
              <fact column="dlg_av_tek_prev_fst" title="Задолженность" table="sf" />
            </band>
            <band title="2-й платеж (40%)">
              <fact column="dlg_av_tek_prev_scnd" title="Задолженность" table="sf" />
            </band>
          </band>
          <band title="Текущий период">
            <band title="1-й платеж (30%)">
              <fact column="dlg_av_tek_cur_fst" title="Задолженность" table="sf" />
            </band>
            <band title="2-й платеж (40%)">
              <fact column="nach_av_tek_cur_scnd" title="Начислено" table="sf" />
              <fact column="dlg_av_tek_cur_scnd" title="Задолженность" table="sf" />
            </band>
          </band>
        </band>
        <band title="Реальные авансы не 30% 40%">
          <fact column="nach_av_tek_othr" title="Начислено" exclude="1" />
          <fact column="opl_av_tek_othr" title="Оплата" exclude="1" />
          <fact column="stor_av_tek_othr" title="Сторно (пошло в погашение)" exclude="1" />
          <fact column="dlg_av_tek_othr" title="Задолженность" table="sf" />
          <fact column="dlg_av_tek_prev_othr" title="Задолженность" table="sf" />
          <call function="if" as="dlg_av_tek_othr_leg" type="number" exclude="1">
            <call function="=1">
              <column table="this" column="pr_legal_av" />
            </call>
            <fact column="dlg_av_tek_othr" title="Задолженность" table="sf" />
          </call>
          <fact column="kred_av_tek_othr" title="Кредит" exclude="1" />
          <fact column="sld_av_ftr_othr" title="Дата оплаты не наступила" exclude="1" />
        </band>
        <band title="Виртуальные авансы 30% 40%">
          <band title="Прошлый период" exclude="1">
            <band title="1-й платеж (30%)">
              <fact column="virt_av_tek_prev_fst" title="Начислено" />
            </band>
            <band title="2-й платеж (40%)">
              <fact column="virt_av_tek_prev_scnd" title="Начислено" />
            </band>
          </band>
          <band title="Текущий период">
            <band title="1-й платеж (30%)">
              <fact column="virt_av_tek_cur_fst" title="Начислено" />
            </band>
            <band title="2-й платеж (40%)">
              <fact column="virt_av_tek_cur_scnd" title="Начислено" />
            </band>
          </band>
        </band>
        <band title="Из уведомлений" exclude="1">
          <fact column="kr_predabon_kod_pred" title="Аванс" table="pred" />
          <fact column="kr_predabon_avans" title="Аванс" table="pred" />
          <fact column="kr_predabon_prom_plat1" title="Первый платеж" table="pred" />
          <fact column="kr_predabon_prom_plat2" title="Второй платеж" table="pred" />
          <fact column="kr_predabon_okon_plat" title="Окончательный платеж" table="pred" />
          <fact column="kr_predabon_osn_dolg" title="Основной долг" table="pred" />
          <fact column="kr_predabon_pereplata" title="Переплата" table="pred" />
          <fact column="kr_predabon_dolg_no_per" title="Долг без переплаты" table="pred" />
        </band>
      </select>
      <from>
        <qube merge-dimsets="1">
          <link name="kod_dog" as="d">
            <link name="kod_dog_fin" />
            <link name="dep">
              <elink name="ks_tf_nastr_rep_uved" as="nastr" />
            </link>
          </link>
          <link name="kod_sf" exclude="1">
            <link name="kod_deb" />
          </link>
          <link name="dat" exclude="1" />
          <dimset as="sf">
            <link name="kod_sf">
              <link name="kod_deb" />
            </link>
            <link name="vid_real" />
          </dimset>
          <dimset as="kred">
            <link name="kod_sf">
              <link name="kod_deb" />
            </link>
            <link name="kod_opl_kred" />
            <link name="vid_real" />
          </dimset>
          <dimset as="pred">
            <link name="kod_pred" />
            <where>
              <call function="and">
                <call function="=">
                  <call function="trunc">
                    <column table="kod_pred" column="dat_ras" />
                  </call>
                  <useparam name="p_dat" />
                </call>
                <call function="=1">
                  <column table="kod_pred" column="pr_last_on_dat" />
                </call>
                <call function="!=nvl">
                  <column table="kod_pred" column="pr_arx" />
                  <const>1</const>
                </call>
              </call>
            </where>
          </dimset>
          <where>
            <call function="in">
              <column table="kod_dog_fin" column="kod_dog" />
              <call function="vr_number_array.get">
                <useparam name="p_kod_dog_array_id" />
              </call>
            </call>
            <call function="=" exclude="1">
              <column table="kod_dog" column="dep" />
              <const>1172</const>
            </call>
            <call function="=">
              <column table="kod_dog_fin" column="pr_active" />
              <const>0</const>
            </call>
            <call function="le" exclude="1">
              <column table="dat" column="val" />
              <useparam name="p_dat" />
            </call>
          </where>
        </qube>
      </from>
      <where>
        <call function="and">
          <call function="gt">
            <call function="nvl">
              <column table="kod_dog_fin" column="dat_fin" />
              <call function="doomsday" />
            </call>
            <call function="sysdate" />
          </call>
          <call function="!=0">
            <column table="this" column="dlg_deb" />
            <column table="this" column="dlg_kred" />
            <column table="this" column="dlg_osn_np_cur" />
            <column table="this" column="virt_av_tek_cur_fst" />
            <column table="this" column="virt_av_tek_cur_scnd" />
            <column table="this" column="pr_3040_av" />
            <column table="this" column="nach_osn_3m" />
            <column table="this" column="pr_virt_av" />
          </call>
        </call>
      </where>
    </query>
    <query name="37989-1" timestamp="16.06.2017 18:07:26" use-repository="1" is-report="1">
      <params>
        <param type="date" name="p_dat">
          <const>to_date('04.05.2017','DD.MM.YYYY')</const>
        </param>
        <param type="number" name="p_ym">
          <const>2017.04</const>
        </param>
      </params>
      <expressions>
        <call function="lt" as="is_dolg" dontpushpred="1">
          <column table="kod_sf" column="dat_bzad_uved_kaz_el" />
          <useparam name="p_dat" />
        </call>
        <call function="le" as="is_do_dat" dontpushpred="1">
          <column table="dat" column="val" />
          <useparam name="p_dat" />
        </call>
        <call function="and" as="is_not_dolg" dontpushpred="1">
          <call function="ge" dontpushpred="1">
            <call function="nvl">
              <column table="kod_sf" column="dat_bzad_uved_kaz_el" />
              <call function="doomsday" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <column table="kod_deb" column="dat_deb" />
            <useparam name="p_dat" />
          </call>
        </call>
        <call function="and" as="is_av_pr" dontpushpred="1">
          <call function="lt">
            <call function="nvl">
              <column table="kod_sf" column="dat_ezad_uved_kaz_el" />
              <call function="doomsday" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <column table="dat" column="val" />
            <useparam name="p_dat" />
          </call>
          <call function="in" dontpushpred="1">
            <column table="vid_real" column="vid_real" />
            <array>0</array>
          </call>
        </call>
        <call function="and" as="is_av_ftr" dontpushpred="1">
          <call function="ge" dontpushpred="1">
            <column table="kod_sf" column="dat_bzad_uved_kaz_el" />
            <useparam name="p_dat" />
          </call>
          <call function="ge">
            <call function="nvl">
              <column table="kod_sf" column="dat_ezad_uved_kaz_el" />
              <call function="doomsday" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <column table="dat" column="val" />
            <useparam name="p_dat" />
          </call>
          <call function="in" dontpushpred="1">
            <column table="vid_real" column="vid_real" />
            <array>0</array>
          </call>
        </call>
        <call function="and" as="is_av_ftr1" dontpushpred="1">
          <call function="ge" dontpushpred="1">
            <column table="kod_sf" column="dat_bzad_uved_kaz_el" />
            <useparam name="p_dat" />
          </call>
          <call function="ge">
            <call function="nvl">
              <column table="kod_sf" column="dat_ezad_uved_kaz_el" />
              <call function="doomsday" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <column table="dat" column="val" />
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <column table="kod_sf" column="dat_sf" />
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <call function="nvl">
              <column table="kod_deb" column="dat_deb" />
              <useparam name="p_dat" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="in" dontpushpred="1">
            <column table="vid_real" column="vid_real" />
            <array>0</array>
          </call>
        </call>
        <call function="and" as="is_av_tek" dontpushpred="1">
          <call function="lt" dontpushpred="1">
            <column table="kod_sf" column="dat_bzad_uved_kaz_el" />
            <useparam name="p_dat" />
          </call>
          <call function="ge">
            <call function="nvl">
              <column table="kod_sf" column="dat_ezad_uved_kaz_el" />
              <call function="doomsday" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <call function="nvl">
              <column table="kod_deb" column="dat_deb" />
              <useparam name="p_dat" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <column table="dat" column="val" />
            <useparam name="p_dat" />
          </call>
          <call function="in" dontpushpred="1">
            <column table="vid_real" column="vid_real" />
            <array>0</array>
          </call>
        </call>
        <call function="and" as="is_mon1" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_sf" column="rym" />
            <useparam name="p_ym" />
          </call>
        </call>
        <call function="and" as="is_mon0" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_sf" column="rym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-1</const>
            </call>
          </call>
        </call>
        <call function="and" as="is_mon_pred_osn" dontpushpred="1">
          <call function="lt" dontpushpred="1">
            <column table="kod_sf" column="ym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-2</const>
            </call>
          </call>
        </call>
        <call function="and" as="is_mon_tek_osn" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_sf" column="ym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-1</const>
            </call>
          </call>
        </call>
        <call function="and" as="is_mon_sled_osn" dontpushpred="1">
          <call function="gt" dontpushpred="1">
            <column table="kod_sf" column="ym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-1</const>
            </call>
          </call>
        </call>
        <call function="and" as="is_mon_pred1_osn" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_sf" column="ym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-2</const>
            </call>
          </call>
        </call>
        <call function="and" as="is_fst" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_sf" column="perc1" />
            <const>30</const>
          </call>
        </call>
        <call function="and" as="is_scnd" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_sf" column="perc1" />
            <const>40</const>
          </call>
        </call>
        <call function="and" as="is_virt_tek" dontpushpred="1">
          <call function="lt" dontpushpred="1">
            <column table="kod_avans_uved" column="dat_bzad_uved_kaz_el" />
            <useparam name="p_dat" />
          </call>
          <call function="ge">
            <column table="kod_avans_uved" column="dat_ezad" />
            <useparam name="p_dat" />
          </call>
        </call>
        <call function="and" as="is_virt_mon1" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_avans_uved" column="rym" />
            <useparam name="p_ym" />
          </call>
        </call>
        <call function="and" as="is_virt_mon0" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_avans_uved" column="rym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-1</const>
            </call>
          </call>
        </call>
        <call function="and" as="is_virt_fst" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_avans_uved" column="perc" />
            <const>30</const>
          </call>
        </call>
        <call function="and" as="is_virt_scnd" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_avans_uved" column="perc" />
            <const>40</const>
          </call>
        </call>
        <call function="and" as="is_othr_av" dontpushpred="1">
          <call function="not in" dontpushpred="1">
            <call function="nvl">
              <column table="kod_sf" column="perc1" />
              <const>0</const>
            </call>
            <array>30,40</array>
          </call>
        </call>
        <call function="is null" as="is_used_state" exclude="1">
          <call function="if">
            <call function="le">
              <column table="kod_debet_state" column="dat_ust" />
            </call>
          </call>
        </call>
        <call function="()" as="opl_sf_osn_do_dat" group="sum" type="number">
          <fact column="fin_ul_opl_sf_osn" condition="is_do_dat" />
        </call>
        <call function="()" as="nach_osn_do_dat" group="sum" type="number">
          <fact column="fin_ul_nachisl_osn" condition="is_do_dat" />
        </call>
        <call function="()" as="opl_sf_av_do_dat" group="sum" type="number">
          <fact column="fin_ul_opl_sf_av" condition="is_do_dat" />
        </call>
        <call function="()" as="nach_osn_pr" group="sum" type="number">
          <fact column="fin_ul_nachisl_osn" condition="is_dolg" />
        </call>
        <call function="0-" as="opl_osn_pr" group="sum" type="number">
          <fact column="opl_sf_osn_do_dat" condition="is_dolg" />
        </call>
        <call function="()" as="nach_osn_np" group="sum" type="number">
          <fact column="nach_osn_do_dat" condition="is_not_dolg" />
        </call>
        <call function="0-" as="opl_osn_np" group="sum" type="number">
          <fact column="opl_sf_osn_do_dat" condition="is_not_dolg" />
        </call>
        <call function="+nvl" as="dlg_osn_pr" group="sum">
          <fact column="nach_osn_pr" />
          <fact column="opl_osn_pr" />
        </call>
        <call function="()" as="dlg_osn_pr_cur" group="sum">
          <fact column="dlg_osn_pr" condition="is_mon_tek_osn" />
        </call>
        <call function="()" as="dlg_osn_pr_nxt" group="sum">
          <fact column="dlg_osn_pr" condition="is_mon_sled_osn" />
        </call>
        <call function="()" as="dlg_osn_pr_pred1" group="sum">
          <fact column="dlg_osn_pr" condition="is_mon_pred1_osn" />
        </call>
        <call function="()" as="dlg_osn_pr_pred" group="sum">
          <fact column="dlg_osn_pr" condition="is_mon_pred_osn" />
        </call>
        <call function="+nvl" as="dlg_osn_np" group="sum">
          <fact column="nach_osn_np" />
          <fact column="opl_osn_np" />
        </call>
        <call function="()" as="dlg_osn_np_cur" group="sum">
          <fact column="dlg_osn_np" condition="is_mon_tek_osn" />
        </call>
        <call function="0-" as="kred_osn" group="sum" type="number">
          <fact column="fin_ul_ob_kr_os" condition="is_do_dat" />
        </call>
        <call function="0-" as="kred_av" group="sum" type="number">
          <fact column="fin_ul_ob_kr_av" condition="is_do_dat" />
        </call>
        <call function="()" as="kred_av_pr" group="sum" type="number">
          <fact column="kred_av" condition="is_av_pr" />
        </call>
        <call function="()" as="kred_av_ftr" group="sum" type="number">
          <fact column="kred_av" condition="is_av_ftr" />
        </call>
        <call function="()" as="nach_av_tek" group="sum" type="number">
          <fact column="fin_ul_nachisl_av" condition="is_av_tek" />
        </call>
        <call function="()" as="nach_av_ftr" group="sum" type="number">
          <fact column="fin_ul_nachisl_av" condition="is_av_ftr1" />
        </call>
        <call function="0-" as="opl_av_tek" group="sum" type="number">
          <fact column="opl_sf_av_do_dat" condition="is_av_tek" />
        </call>
        <call function="0-" as="opl_av_ftr" group="sum" type="number">
          <fact column="opl_sf_av_do_dat" condition="is_av_ftr1" />
        </call>
        <call function="0-" as="stor_av_tek" group="sum" type="number">
          <fact column="sr_opl_opl_stor" condition="is_av_tek" />
        </call>
        <call function="+nvl" group="sum" as="dlg_av_tek">
          <fact column="nach_av_tek" />
          <fact column="opl_av_tek" />
        </call>
        <call function="+nvl" group="sum" as="dlg_av_ftr">
          <fact column="nach_av_ftr" />
          <fact column="opl_av_ftr" />
        </call>
        <call function="+nvl" group="sum" as="kred_av_tek">
          <fact column="opl_av_tek" />
          <fact column="stor_av_tek" />
        </call>
        <call function="()" as="nach_av_tek_fst" group="sum" type="number" exclude="1">
          <fact column="nach_av_tek" condition="is_fst" />
        </call>
        <call function="()" as="nach_av_tek_scnd" group="sum" type="number" exclude="1">
          <fact column="nach_av_tek" condition="is_scnd" />
        </call>
        <call function="()" as="nach_av_tek_othr" group="sum" type="number" exclude="1">
          <fact column="nach_av_tek" condition="is_othr" />
        </call>
        <call function="()" as="nach_av_tek_cur" group="sum" type="number">
          <fact column="nach_av_tek" condition="is_mon1" />
        </call>
        <call function="()" as="opl_av_tek_cur" group="sum" type="number">
          <fact column="opl_av_tek" condition="is_mon1" />
        </call>
        <call function="()" as="stor_av_tek_cur" group="sum" type="number">
          <fact column="stor_av_tek" condition="is_mon1" />
        </call>
        <call function="()" as="dlg_av_tek_cur" group="sum" type="number">
          <fact column="dlg_av_tek" condition="is_mon1" />
        </call>
        <call function="()" as="kred_av_tek_cur" group="sum" type="number">
          <fact column="kred_av_tek" condition="is_mon1" />
        </call>
        <call function="()" as="nach_av_tek_prev" group="sum" type="number">
          <fact column="nach_av_tek" condition="is_mon0" />
        </call>
        <call function="()" as="opl_av_tek_prev" group="sum" type="number">
          <fact column="opl_av_tek" condition="is_mon0" />
        </call>
        <call function="()" as="stor_av_tek_prev" group="sum" type="number">
          <fact column="stor_av_tek" condition="is_mon0" />
        </call>
        <call function="()" as="dlg_av_tek_prev" group="sum" type="number">
          <fact column="dlg_av_tek" condition="is_mon0" />
        </call>
        <call function="()" as="kred_av_tek_prev" group="sum" type="number">
          <fact column="kred_av_tek" condition="is_mon0" />
        </call>
        <call function="()" as="nach_av_tek_cur_fst" group="sum" type="number">
          <fact column="nach_av_tek_cur" condition="is_fst" />
        </call>
        <call function="()" as="opl_av_tek_cur_fst" group="sum" type="number">
          <fact column="opl_av_tek_cur" condition="is_fst" />
        </call>
        <call function="()" as="stor_av_tek_cur_fst" group="sum" type="number">
          <fact column="stor_av_tek_cur" condition="is_fst" />
        </call>
        <call function="()" as="dlg_av_tek_cur_fst" group="sum" type="number">
          <fact column="dlg_av_tek_cur" condition="is_fst" />
        </call>
        <call function="()" as="kred_av_tek_cur_fst" group="sum" type="number">
          <fact column="kred_av_tek_cur" condition="is_fst" />
        </call>
        <call function="()" as="nach_av_tek_prev_fst" group="sum" type="number">
          <fact column="nach_av_tek_prev" condition="is_fst" />
        </call>
        <call function="()" as="opl_av_tek_prev_fst" group="sum" type="number">
          <fact column="opl_av_tek_prev" condition="is_fst" />
        </call>
        <call function="()" as="stor_av_tek_prev_fst" group="sum" type="number">
          <fact column="stor_av_tek_prev" condition="is_fst" />
        </call>
        <call function="()" as="dlg_av_tek_prev_fst" group="sum" type="number">
          <fact column="dlg_av_tek_prev" condition="is_fst" />
        </call>
        <call function="()" as="kred_av_tek_prev_fst" group="sum" type="number">
          <fact column="kred_av_tek_prev" condition="is_fst" />
        </call>
        <call function="()" as="nach_av_tek_cur_scnd" group="sum" type="number">
          <fact column="nach_av_tek_cur" condition="is_scnd" />
        </call>
        <call function="()" as="opl_av_tek_cur_scnd" group="sum" type="number">
          <fact column="opl_av_tek_cur" condition="is_scnd" />
        </call>
        <call function="()" as="stor_av_tek_cur_scnd" group="sum" type="number">
          <fact column="stor_av_tek_cur" condition="is_scnd" />
        </call>
        <call function="()" as="dlg_av_tek_cur_scnd" group="sum" type="number">
          <fact column="dlg_av_tek_cur" condition="is_scnd" />
        </call>
        <call function="()" as="kred_av_tek_cur_scnd" group="sum" type="number">
          <fact column="kred_av_tek_cur" condition="is_scnd" />
        </call>
        <call function="()" as="nach_av_tek_prev_scnd" group="sum" type="number">
          <fact column="nach_av_tek_prev" condition="is_scnd" />
        </call>
        <call function="()" as="opl_av_tek_prev_scnd" group="sum" type="number">
          <fact column="opl_av_tek_prev" condition="is_scnd" />
        </call>
        <call function="()" as="stor_av_tek_prev_scnd" group="sum" type="number">
          <fact column="stor_av_tek_prev" condition="is_scnd" />
        </call>
        <call function="()" as="dlg_av_tek_prev_scnd" group="sum" type="number">
          <fact column="dlg_av_tek_prev" condition="is_scnd" />
        </call>
        <call function="()" as="kred_av_tek_prev_scnd" group="sum" type="number">
          <fact column="kred_av_tek_prev" condition="is_scnd" />
        </call>
        <call function="()" as="virt_av_tek" group="sum" type="number">
          <fact column="sr_avans_uved_avans" condition="is_virt_tek" />
        </call>
        <call function="()" as="virt_av_tek_prev" group="sum" type="number">
          <fact column="virt_av_tek" condition="is_virt_mon0" />
        </call>
        <call function="()" as="virt_av_tek_prev_fst" group="sum" type="number">
          <fact column="virt_av_tek_prev" condition="is_virt_fst" />
        </call>
        <call function="()" as="virt_av_tek_prev_scnd" group="sum" type="number">
          <fact column="virt_av_tek_prev" condition="is_virt_scnd" />
        </call>
        <call function="()" as="virt_av_tek_cur" group="sum" type="number">
          <fact column="virt_av_tek" condition="is_virt_mon1" />
        </call>
        <call function="()" as="virt_av_tek_cur_fst" group="sum" type="number">
          <fact column="virt_av_tek_cur" condition="is_virt_fst" />
        </call>
        <call function="()" as="virt_av_tek_cur_scnd" group="sum" type="number">
          <fact column="virt_av_tek_cur" condition="is_virt_scnd" />
        </call>
        <call function="()" as="nach_av_tek_othr" group="sum" type="number">
          <fact column="nach_av_tek" condition="is_othr_av" />
        </call>
        <call function="()" as="opl_av_tek_othr" group="sum" type="number">
          <fact column="opl_av_tek" condition="is_othr_av" />
        </call>
        <call function="()" as="stor_av_tek_othr" group="sum" type="number">
          <fact column="stor_av_tek" condition="is_othr_av" />
        </call>
        <call function="()" as="dlg_av_tek_othr" group="sum" type="number">
          <fact column="dlg_av_tek" condition="is_othr_av" />
        </call>
        <call function="()" as="kred_av_tek_othr" group="sum" type="number">
          <fact column="kred_av_tek" condition="is_othr_av" />
        </call>
        <call function="()" as="sld_av_ftr_othr" group="sum" type="number">
          <fact column="dlg_av_ftr" condition="is_othr_av" />
        </call>
      </expressions>
      <select>
        <column table="kod_sf" column="kod_sf" exclude="1" />
        <column table="kod_sf" column="dat_sf" exclude="1" />
        <column table="kod_sf" column="ym" exclude="1" />
        <column table="kod_sf" column="rym" exclude="1" />
        <column table="kod_deb" column="dat_bzad" exclude="1" />
        <column table="kod_deb" column="dat_deb" exclude="1" />
        <column table="kod_dog" column="ndog" />
        <column table="kod_dog" column="dep" />
        <column table="kod_dog" column="kod_dog" />
        <fact column="kr_vd_pr_illegal_av" as="pr_virt_av" title="Признак применения виртуальных авансов" />
        <band title="Задолженность по основной реализации">
          <fact column="dlg_osn_pr_pred" title="Ранее" />
          <fact column="dlg_osn_pr_pred1" title="За предыдущий период" />
          <band title="Окончательный платеж">
            <fact column="dlg_osn_pr_cur" title="Просроченный" />
            <fact column="dlg_osn_np_cur" title="Не просроченный" />
          </band>
          <fact column="dlg_osn_pr_nxt" title="Следующий период" />
        </band>
        <band title="Кредиторская задолженность">
          <fact column="kred_osn" title="Переплата" />
          <fact column="kred_av_pr" title="Авансы прошлых периодов (наступила дата окончания действия)" />
          <fact column="kred_av_ftr" title="Авансы будущих периодов (дата оплаты не наступила)" />
          <fact column="kred_av_tek" title="Авансы текущие" />
        </band>
        <band title="Реальные авансы 30% 40%">
          <band title="Прошлый период">
            <band title="1-й платеж (30%)">
              <fact column="dlg_av_tek_prev_fst" title="Задолженность" />
            </band>
            <band title="2-й платеж (40%)">
              <fact column="dlg_av_tek_prev_scnd" title="Задолженность" />
            </band>
          </band>
          <band title="Текущий период">
            <band title="1-й платеж (30%)">
              <fact column="dlg_av_tek_cur_fst" title="Задолженность" />
            </band>
            <band title="2-й платеж (40%)">
              <fact column="dlg_av_tek_cur_scnd" title="Задолженность" />
            </band>
          </band>
        </band>
        <band title="Реальные авансы не 30% 40%">
          <fact column="nach_av_tek_othr" title="Начислено" />
          <fact column="opl_av_tek_othr" title="Оплата" />
          <fact column="stor_av_tek_othr" title="Сторно (пошло в погашение)" />
          <fact column="dlg_av_tek_othr" title="Задолженность" />
          <fact column="kred_av_tek_othr" title="Кредит" />
          <fact column="sld_av_ftr_othr" title="Дата оплаты не наступила" />
        </band>
        <band title="Виртуальные авансы 30% 40%">
          <band title="Прошлый период">
            <band title="1-й платеж (30%)">
              <fact column="virt_av_tek_prev_fst" title="Начислено" />
            </band>
            <band title="2-й платеж (40%)">
              <fact column="virt_av_tek_prev_scnd" title="Начислено" />
            </band>
          </band>
          <band title="Текущий период">
            <band title="1-й платеж (30%)">
              <fact column="virt_av_tek_cur_fst" title="Начислено" />
            </band>
            <band title="2-й платеж (40%)">
              <fact column="virt_av_tek_cur_scnd" title="Начислено" />
            </band>
          </band>
        </band>
        <band title="Из уведомлений">
          <fact column="kr_predabon_kod_pred" title="Аванс" table="pred" />
          <fact column="kr_predabon_avans" title="Аванс" table="pred" />
          <fact column="kr_predabon_prom_plat1" title="Первый платеж" table="pred" />
          <fact column="kr_predabon_prom_plat2" title="Второй платеж" table="pred" />
          <fact column="kr_predabon_okon_plat" title="Окончательный платеж" table="pred" />
          <fact column="kr_predabon_osn_dolg" title="Основной долг" table="pred" />
          <fact column="kr_predabon_pereplata" title="Переплата" table="pred" />
          <fact column="kr_predabon_dolg_no_per" title="Долг без переплаты" table="pred" />
        </band>
      </select>
      <from>
        <qube merge-dimsets="1">
          <link name="kod_dog" />
          <link name="kod_sf" exclude="1">
            <link name="kod_deb" />
          </link>
          <link name="dat" exclude="1" />
          <dimset as="pred">
            <link name="kod_pred" />
            <where>
              <call function="and">
                <call function="=">
                  <call function="trunc">
                    <column table="kod_pred" column="dat_ras" />
                  </call>
                  <useparam name="p_dat" />
                </call>
                <call function="=1">
                  <column table="kod_pred" column="pr_last_on_dat" />
                </call>
                <call function="!=nvl">
                  <column table="kod_pred" column="pr_arx" />
                  <const>1</const>
                </call>
              </call>
            </where>
          </dimset>
          <where>
            <call function="in" exclude="1">
              <column table="kod_dog" column="kod_dog" />
              <array>6982</array>
            </call>
            <call function="=">
              <column table="kod_dog" column="dep" />
              <const>1172</const>
            </call>
            <call function="=">
              <column table="kod_dog" column="pr_active" />
              <const>0</const>
            </call>
            <call function="le" exclude="1">
              <column table="dat" column="val" />
              <useparam name="p_dat" />
            </call>
          </where>
        </qube>
      </from>
      <where>
        <call function="gt">
          <call function="nvl">
            <column table="kod_dog" column="dat_fin" />
            <call function="doomsday" />
          </call>
          <call function="sysdate" />
        </call>
        <call function="!=0" exclude="1">
          <column table="this" column="dlg_osn_pr" />
          <column table="this" column="kred_osn" />
          <column table="this" column="kred_av_pr" />
          <column table="this" column="dlg_av_tek" />
          <column table="this" column="kred_av_tek" />
          <column table="this" column="kred_av_ftr" />
        </call>
      </where>
    </query>
    <query name="37989-dog" timestamp="26.12.2017 12:17:03" use-repository="1">
      <params>
        <usepart part="37989-params" />
      </params>
      <select>
        <column table="a" column="kod_dog" key="1" />
        <call function="()" type="date" as="dat_calc">
          <useparam name="p_dat" />
        </call>
        <column table="a" column="pr_virt_av" nvl="0" format="N0" />
        <column table="a" column="dlg_av_tek_cur_fst" />
        <column table="a" column="dlg_av_tek_cur_scnd" />
        <column table="a" column="nach_av_tek_cur_scnd" />
        <column table="a" column="dlg_av_tek_prev_fst" />
        <column table="a" column="dlg_av_tek_prev_scnd" />
        <column table="a" column="dlg_av_tek_prev_othr" />
        <column table="a" column="dlg_av_tek_othr" />
        <column table="a" column="dlg_av_tek_othr_leg" exclude="1" />
        <column table="a" column="dlg_osn_pr_cur" />
        <column table="a" column="dlg_osn_np_cur" />
        <call function="+nvl" as="dlg_osn_cur" part-id="37989-dlg_osn_cur" title="Окончательный платеж за предыдущий месяц" excel-calc="1">
          <column table="this" column="final2_i" />
          <column table="this" column="dlg_osn_np_cur_i" />
        </call>
        <column table="a" column="cntper_zadol" exclude="1" />
        <call function="if" type="number" as="cntper_zadol">
          <call function="!=0">
            <column table="this" column="zadol_vidreal2_bez_per" />
            <column table="this" column="first_pay_pre" />
            <column table="this" column="last_pay" />
            <column table="this" column="other_pay" />
            <column table="this" column="no_pay" />
          </call>
          <column table="a" column="cntper_zadol" />
          <const>0</const>
        </call>
        <column table="a" column="dlg_osn_pr_pred" />
        <column table="a" column="dlg_osn_pr_pred1" />
        <column table="a" column="ym_rasch" />
        <column table="a" column="kred_osn" />
        <column table="a" column="kred_av_pr" />
        <column table="a" column="kred_av_tek" />
        <column table="a" column="kred_av_ftr" />
        <column table="a" column="dlg_osn_pr_nxt" />
        <column table="a" column="virt_av_tek_cur_fst" />
        <column table="a" column="virt_av_tek_cur_scnd" />
        <column table="a" column="set_virt_avans" nvl="0" format="N0" />
        <column table="a" column="set_pereplata" nvl="0" format="N0" />
        <column table="a" column="set_pereplata_cur" nvl="0" format="N0" />
        <column table="a" column="set_pereplata_ftr" nvl="0" format="N0" />
        <column table="a" column="set_opl_virt_av" nvl="0" format="N0" />
        <call function="if" type="number" as="other_pay" excel-calc="1" part-id="37989-other_pay" title="Прочие авансы">
          <call function="=1">
            <column table="this" column="set_virt_avans" />
          </call>
          <const>0</const>
          <column table="this" column="dlg_av_tek_othr" />
        </call>
        <call function="if" type="number" as="other_pay_prev" excel-calc="1" part-id="37989-other_pay_prev" title="Прочие авансы (предыдущего периода)">
          <call function="=1">
            <column table="this" column="set_virt_avans" />
          </call>
          <const>0</const>
          <column table="this" column="dlg_av_tek_prev_othr" />
        </call>
        <call function="if" type="number" as="pr_use_virt_av" part-id="37989-pr_use_virt_av" title="Используются  виртуальные авансы" nvl="0" format="N0" excel-calc="1">
          <call function="=1">
            <column table="this" column="pr_virt_av" />
            <column table="this" column="set_virt_avans" />
          </call>
          <const>1</const>
          <const>0</const>
        </call>
        <call function="if" type="number" as="first_pay_pre" excel-calc="1" part-id="37989-first_pay_pre" title="1-й пром. платеж (30%)">
          <call function="=1">
            <column table="this" column="pr_use_virt_av" />
          </call>
          <column table="this" column="dlg_virt_av_tek_cur_fst" />
          <column table="this" column="dlg_av_tek_cur_fst" />
        </call>
        <call function="+nvl" as="first_pay" part-id="37989-first_pay" excel-calc="1" title="Первый промежуточный платеж" format="N2">
          <call function="-nvl">
            <column table="this" column="other_pay" />
            <column table="this" column="other_pay_prev" />
          </call>
          <column table="this" column="first_pay_pre" />
        </call>
        <call function="if" as="last_pay" type="number" excel-calc="1" title="2-й пром. платеж (40%)" part-id="37989-last_pay">
          <call function="=1">
            <column table="this" column="pr_use_virt_av" />
          </call>
          <column table="this" column="dlg_virt_av_tek_cur_scnd" />
          <column table="this" column="dlg_av_tek_cur_scnd" />
        </call>
        <call function="+nvl" as="zadol_bez_mor_vidreal2" part-id="37989-zadol_bez_mor_vidreal2" excel-calc="1" title="Задолженность осн. реал.">
          <column table="this" column="zadol_vidreal2_bez_per" />
          <column table="this" column="kredit" />
        </call>
        <call function="+nvl" as="no_pay" title="Платежи за прошлый период." part-id="37989-no_pay" excel-calc="1">
          <column table="this" column="dlg_av_tek_prev_fst" />
          <column table="this" column="dlg_av_tek_prev_scnd" />
          <column table="this" column="other_pay_prev" />
        </call>
        <column table="a" column="cntper_zadol2" />
        <call function="()" type="number" as="zadol_mor">
          <const>0</const>
        </call>
        <column table="a" column="per_zadol_vidreal2" />
        <column table="a" column="per_zadol_vidreal0" />
        <column table="a" column="per_potr" />
        <column table="a" column="dat_zadol_2" />
        <column table="a" column="opl_osn_pr" as="opl_by_money_2" />
        <column table="a" column="opl_osn_pr" as="opl_by_not_money_2" />
        <column table="a" column="cnt_kod_deb_zadol" />
        <call function="()" as="final2" type="number" part-id="37989-final2" excel-calc="1" title="Окончательный платеж за текущий период">
          <column table="this" column="dlg_osn_pr_cur" />
        </call>
        <call function="+nvl" as="basic_debt">
          <column table="this" column="dlg_osn_pr_pred_all" />
          <column table="this" column="no_pay" />
          <column table="this" column="dlg_av_tek_prev_fst" exclude="1" />
          <column table="this" column="dlg_av_tek_prev_scnd" exclude="1" />
          <column table="this" column="other_pay_prev" exclude="1" />
        </call>
        <call function="||" as="smirnov18">
          <call function="date to char">
            <call function="date add days">
              <call function="ym begin time">
                <column table="this" column="ym_rasch" />
              </call>
              <const>17</const>
            </call>
          </call>
          <const>' - '</const>
          <call function="to_char">
            <call function="nvl0">
              <column table="this" column="dlg_osn_cur" />
            </call>
          </call>
          <const>' руб.'</const>
        </call>
        <call function="||" as="smirnov25">
          <call function="date to char">
            <call function="date add days">
              <call function="ym begin time">
                <column table="a" column="ym_rasch" />
              </call>
              <const>24</const>
            </call>
          </call>
          <const>' - '</const>
          <call function="to_char">
            <call function="nvl0">
              <column table="this" column="last_pay" />
            </call>
          </call>
          <const>' руб.'</const>
        </call>
        <call function="+nvl" as="kredit" part-id="37989-kredit" title="Переплата" excel-calc="1">
          <call function="if">
            <call function="=1">
              <column table="this" column="set_pereplata" />
            </call>
            <call function="+nvl">
              <column table="this" column="kred_osn_i" />
              <column table="this" column="kred_av_pr_i" />
            </call>
          </call>
          <call function="if">
            <call function="=1">
              <column table="this" column="set_pereplata_cur" />
            </call>
            <column table="this" column="kred_av_tek_i" />
          </call>
          <call function="if">
            <call function="=1">
              <column table="this" column="set_pereplata_ftr" />
            </call>
            <column table="this" column="kred_av_ftr_i" />
          </call>
        </call>
        <call function="+nvl" as="kredit" title="Переплата" excel-calc="1" exclude="1">
          <column table="this" column="kred_osn" />
          <column table="this" column="kred_av_pr" />
          <column table="this" column="kred_av_tek" />
          <column table="this" column="kred_av_ftr" />
        </call>
        <call function="+nvl" as="dlg_osn_pr_pred_all">
          <column table="this" column="dlg_osn_pr_pred" />
          <column table="this" column="dlg_osn_pr_pred1" />
        </call>
        <call function="+nvl" as="zadol_vidreal2_bez_per" part-id="37989-zadol_vidreal2_bez_per" title="Всего" excel-calc="1">
          <column table="this" column="dlg_osn_pr_pred_all" />
          <column table="this" column="dlg_osn_pr_cur" />
          <column table="this" column="dlg_osn_pr_nxt" />
        </call>
        <column table="a" column="skod_sflist" />
        <column table="a" column="nach_osn_3m" />
        <call as="mid_elptr" function="/" title="Долг по документу">
          <column table="this" column="nach_osn_3m" />
          <const>3</const>
        </call>
        <column table="a" column="pr_3040_av_dog" />
        <call function="if" as="pr_3040_av" type="number">
          <call function="!=0">
            <column table="this" column="dlg_av_tek_cur_fst" />
            <column table="this" column="dlg_av_tek_cur_scnd" />
            <column table="this" column="virt_av_tek_cur_fst" />
            <column table="this" column="virt_av_tek_cur_scnd" />
            <column table="this" column="pr_3040_av_dog" />
          </call>
          <const>1</const>
          <const>0</const>
        </call>
        <column table="a" column="deb_names" />
        <call function="if" as="pr_nach_osn_3m" type="number">
          <call function="!=0">
            <column table="this" column="nach_osn_3m" />
          </call>
          <const>1</const>
          <const>0</const>
        </call>
        <call function="+nvl" as="kred_av" exclude="1">
          <column table="this" column="kred_av_pr" />
          <column table="this" column="kred_av_tek" />
          <column table="this" column="kred_av_ftr" />
        </call>
        <call function="if" type="number" as="kred_av_for_opl_virt" excel-calc="1" part-id="37989-kred_av_for_opl_virt" title="Кредит для оплаты вирт. авансов.">
          <call function="=1">
            <column table="this" column="set_opl_virt_av" />
          </call>
          <column table="this" column="kred_av_tek" />
        </call>
        <call function="greatest_num" as="opl_first_virt_av" excel-calc="1" part-id="37989-opl_first_virt_av" title="Оплата" type="number">
          <column table="this" column="kred_av_for_opl_virt" />
          <call function="0-">
            <call function="nvl0">
              <column table="this" column="virt_av_tek_cur_fst" />
            </call>
          </call>
        </call>
        <call function="+nvl" as="dlg_virt_av_tek_cur_fst" excel-calc="1" part-id="37989-dlg_virt_av_tek_cur_fst" title="Задолженность" type="number">
          <column table="this" column="virt_av_tek_cur_fst" />
          <column table="this" column="opl_first_virt_av" />
        </call>
        <call function="greatest_num" as="opl_last_virt_av" excel-calc="1" part-id="37989-opl_last_virt_av" title="Оплата">
          <call function="-nvl">
            <column table="this" column="kred_av_for_opl_virt" />
            <column table="this" column="opl_first_virt_av" />
          </call>
          <call function="0-">
            <call function="nvl0">
              <column table="this" column="virt_av_tek_cur_scnd" />
            </call>
          </call>
        </call>
        <call function="+nvl" as="dlg_virt_av_tek_cur_scnd" excel-calc="1" part-id="37989-dlg_virt_av_tek_cur_scnd" title="Задолженность">
          <column table="this" column="virt_av_tek_cur_scnd" />
          <column table="this" column="opl_last_virt_av" />
        </call>
        <call function="()" as="kred_osn_i" type="number" excel-calc="1" part-id="37989-kred_osn_i">
          <column table="this" column="kred_osn" type="number" />
        </call>
        <call function="()" as="kred_av_pr_i" type="number" excel-calc="1" part-id="37989-kred_av_pr_i">
          <column table="this" column="kred_av_pr" type="number" />
        </call>
        <call function="()" as="kred_av_tek_i" type="number" excel-calc="1" part-id="37989-kred_av_tek_i">
          <column table="this" column="kred_av_tek" type="number" />
        </call>
        <call function="()" as="kred_av_ftr_i" type="number" excel-calc="1" part-id="37989-kred_av_ftr_i">
          <column table="this" column="kred_av_ftr" type="number" />
        </call>
        <call function="()" as="dlg_osn_pr_pred_all_i" type="number" excel-calc="1" title="Прошлые периоды" part-id="37989-dlg_osn_pr_pred_all_i">
          <column table="this" column="dlg_osn_pr_pred_all" type="number" />
        </call>
        <call function="()" as="final2_i" type="number" excel-calc="1" title="Окончательный платеж за предыдущий месяц" part-id="37989-final2_i">
          <column table="this" column="dlg_osn_pr_cur" type="number" />
        </call>
        <call function="()" as="dlg_osn_np_cur_i" type="number" excel-calc="1" title="Окончательный платеж за предыдущий месяц" part-id="37989-dlg_osn_np_cur_i">
          <column table="this" column="dlg_osn_np_cur" type="number" />
        </call>
        <call function="+nvl" as="dolg_all_no_per" excel-calc="1" title="Общая задолженност без учета переплаты" format="N2" part-id="37989-dolg_all_no_per">
          <column table="this" column="zadol_vidreal2_bez_per" />
          <column table="this" column="avans" />
        </call>
        <call function="+nvl" as="dolg_all" type="number" title="Общая задолженност с учетом переплаты" excel-calc="1" part-id="37989-dolg_all">
          <column table="this" column="dolg_all_no_per" />
          <column table="this" column="kredit" />
        </call>
        <call function="+nvl" as="avans" excel-calc="1" title="Задолженность аванс" format="N2" part-id="37989-avans">
          <column table="this" column="first_pay" />
          <column table="this" column="last_pay" />
          <column table="this" column="no_pay" />
        </call>
      </select>
      <from>
        <query name="37989-dog-pre" as="a">
          <withparams>
            <usepart part="37989-withparams" />
          </withparams>
        </query>
      </from>
    </query>
    <query name="37989-dog-pre" timestamp="27.02.2019 17:30:11" use-repository="1" materialize="1">
      <params>
        <usepart part="37989-params" />
      </params>
      <select>
        <column table="a" column="ndog" group="1" />
        <column table="a" column="kod_dog" group="1" />
        <call function="if" as="cntper_zadol" group="count_dist">
          <call function="!=0">
            <column table="a" column="dlg_deb" />
            <column table="a" column="virt_av_tek_cur_fst" />
            <column table="a" column="virt_av_tek_cur_scnd" />
          </call>
          <call function="if">
            <call function="=0">
              <column table="a" column="vid_real" />
            </call>
            <call function="nvl">
              <column table="a" column="rym" />
              <column table="a" column="ym_rasch" />
            </call>
            <column table="a" column="ym" />
          </call>
        </call>
        <call function="if" group="max" as="dolg_ym">
          <call function="!=0">
            <column table="a" column="dlg_deb" />
            <column table="a" column="virt_av_tek_cur_fst" />
            <column table="a" column="virt_av_tek_cur_scnd" />
          </call>
          <call function="if">
            <call function="=0">
              <column table="a" column="vid_real" />
            </call>
            <call function="nvl">
              <column table="a" column="rym" />
              <column table="a" column="ym_rasch" />
            </call>
            <column table="a" column="ym" />
          </call>
        </call>
        <call function="if" as="cntper_zadol2" group="count_dist">
          <call function="!=0">
            <column table="a" column="dlg_osn_pr" />
          </call>
          <column table="a" column="ym" />
        </call>
        <call as="per_zadol_vidreal2" function="vg_period.ym_enum_str_to_ym_ranges_str">
          <call function="||">
            <call function="if" group="stragg">
              <call function="!=0">
                <column table="a" column="dlg_osn_pr" />
              </call>
              <column table="a" column="ym" />
            </call>
            <const>','</const>
            <call function="if" group="stragg">
              <call function="!=0">
                <column table="a" column="dlg_av_tek" />
                <column table="a" column="virt_av_tek_cur_fst" />
                <column table="a" column="virt_av_tek_cur_scnd" />
              </call>
              <call function="nvl">
                <column table="a" column="rym" />
                <column table="a" column="ym_rasch" />
              </call>
            </call>
          </call>
        </call>
        <call function="||" as="per_potr">
          <const>'с '</const>
          <call function="date to char">
            <call function="ym begin time">
              <column table="this" column="dolg_ym" group="min" />
            </call>
          </call>
          <const>' по '</const>
          <call function="date to char">
            <call function="ym end day">
              <column table="this" column="dolg_ym" group="max" />
            </call>
          </call>
        </call>
        <call function="if" group="max" as="dat_zadol_2">
          <call function="!=0">
            <column table="a" column="dlg_deb" />
          </call>
          <column table="a" column="dat_bzad" />
        </call>
        <call as="per_zadol_vidreal0" function="vg_period.ym_enum_str_to_ym_ranges_str">
          <call function="if" group="stragg">
            <call function="!=0">
              <column table="a" column="dlg_av_tek" />
              <column table="a" column="virt_av_tek_cur_fst" />
              <column table="a" column="virt_av_tek_cur_scnd" />
            </call>
            <call function="nvl">
              <column table="a" column="rym" />
              <column table="a" column="ym_rasch" />
            </call>
          </call>
        </call>
        <column table="a" column="kod_deb" as="cnt_kod_deb_zadol" group="count" />
        <call function="if" as="skod_sflist" group="stragg" type="string">
          <call function="!=0">
            <column table="a" column="dlg_deb" />
          </call>
          <column table="a" column="kod_sf" />
        </call>
        <column table="a" column="opl_osn_pr" group="sum" />
        <column table="a" column="pr_virt_av" group="max" />
        <column table="a" column="ym_rasch" group="max" />
        <column table="a" column="dlg_deb" group="sum" />
        <column table="a" column="dlg_kred" group="sum" />
        <column table="a" column="dlg_osn_pr_pred" group="sum" />
        <column table="a" column="dlg_osn_pr_pred1" group="sum" />
        <column table="a" column="dlg_osn_pr_cur" group="sum" />
        <column table="a" column="dlg_osn_np_cur" group="sum" />
        <column table="a" column="dlg_osn_pr_nxt" group="sum" />
        <column table="a" column="kred_osn" group="sum" />
        <column table="a" column="kred_av_pr" group="sum" />
        <column table="a" column="kred_av_ftr" group="sum" />
        <column table="a" column="kred_av_tek" group="sum" />
        <column table="a" column="dlg_av_tek_prev_fst" group="sum" />
        <column table="a" column="dlg_av_tek_prev_scnd" group="sum" />
        <column table="a" column="dlg_av_tek_cur_fst" group="sum" />
        <column table="a" column="dlg_av_tek_cur_scnd" group="sum" />
        <column table="a" column="dlg_av_tek_othr" group="sum" />
        <column table="a" column="dlg_av_tek_prev_othr" group="sum" />
        <column table="a" column="dlg_av_tek_othr_leg" group="sum" exclude="1" />
        <column table="a" column="virt_av_tek_cur_fst" group="sum" />
        <column table="a" column="virt_av_tek_cur_scnd" group="sum" />
        <column table="a" column="nach_osn_1m" group="sum" />
        <column table="a" column="nach_osn_3m" group="sum" />
        <column table="a" column="pr_3040_av" group="max" as="pr_3040_av_dog" />
        <call as="deb_names" type="string" function="substr">
          <call function="replace" as="" type="">
            <call function="if" group="stragg" type="string">
              <call function="!=0">
                <column table="a" column="dlg_deb" />
              </call>
              <column table="a" column="deb_name" />
            </call>
            <const>','</const>
            <const>'; '</const>
          </call>
          <const>0</const>
          <const>1000</const>
        </call>
        <column table="a" column="set_virt_avans" group="max" />
        <column table="a" column="set_pereplata" group="max" />
        <column table="a" column="set_pereplata_cur" group="max" />
        <column table="a" column="set_pereplata_ftr" group="max" />
        <column table="a" column="set_opl_virt_av" group="max" />
        <column table="a" column="nach_av_tek_cur_scnd" group="sum" />
      </select>
      <from>
        <query name="37989-dat" as="a">
          <withparams>
            <usepart part="37989-withparams" />
          </withparams>
        </query>
      </from>
    </query>
    <query name="37989-det" timestamp="26.12.2017 13:31:52" use-repository="1">
      <params>
        <usepart part="37989-params" />
      </params>
      <select>
        <column table="a" column="*" />
      </select>
      <from>
        <query name="37989-dat" as="a">
          <withparams>
            <usepart part="37989-withparams" />
          </withparams>
        </query>
      </from>
    </query>
    <query name="37989-main" timestamp="26.06.2017 01:36:42">
      <params>
        <usepart part="37989-params" />
      </params>
      <select>
        <call function="()" type="date" as="dat_start">
          <useparam name="p_dat_start" />
        </call>
        <call function="()" type="date" as="dat_calc">
          <useparam name="p_dat" />
        </call>
        <call function="()" type="number" as="calc_id">
          <useparam name="p_calc_id" />
        </call>
        <column table="a" column="kod_dog" group="count" as="cnt_dog" />
      </select>
      <from>
        <query name="37989-dog-pre" as="a">
          <withparams>
            <usepart part="37989-withparams" />
          </withparams>
        </query>
      </from>
    </query>
    <query name="37989_anl_rep" class="1" timestamp="31.10.2017 13:41:35" title="Анализ расчета уведомлений" is-report="1">
      <content>
        <fieldgroup title="Расчет на дату">
          <usefield field="cmn_date" title="С" name="dat1">
            <defaultquery>
              <query name="spr_time_date_last_month" />
            </defaultquery>
          </usefield>
          <usefield field="cmn_date" title="По" name="dat2" />
        </fieldgroup>
        <usefield field="asuse_dep" />
        <usefield field="asuse_kod_dog" />
        <usefield field="cmn_list" title="Расчет" name="p_calc_id" type="number" column-mandatory="1">
          <listquery>
            <query name="37989-calc-list" />
          </listquery>
        </usefield>
      </content>
      <customers>
        <customer id="10" />
      </customers>
      <select>
        <column table="a" column="dog_id" type="number" title="" key="1" />
        <column table="a" column="calc_id" type="number" title="Id Расчета" format="N0" />
        <column table="calc_id" column="u_m" title="Ползователь" />
        <column table="calc_id" column="dat_start" title="Запуск" format="dd.MM.yyyy HH:mm" />
        <column table="calc_id" column="d_m" title="Окончание" format="dd.MM.yyyy HH:mm" />
        <column table="a" column="dat_calc" title="Расчет на дату" />
        <column table="a" column="kod_dog" type="number" />
        <band title="Настройки расчета">
          <column table="a" column="set_virt_avans" type="number" title="Применять вирт. авансы" nvl="0" format="N0" />
          <call function="decode" as="set_virt_avans_name" type="string" title="Применять вирт. авансы" exclude="1">
            <column table="a" column="set_virt_avans" type="number" />
            <const>1</const>
            <const>'Да'</const>
            <const>'Нет'</const>
          </call>
          <column table="a" column="set_pereplata" type="number" nvl="0" format="N0" title="Учитывать переплату прошлых периодов" />
          <column table="a" column="set_pereplata_cur" type="number" nvl="0" format="N0" title="Учитывать переплату текущего периода" />
          <column table="a" column="set_pereplata_ftr" type="number" nvl="0" format="N0" title="Учитывать переплату будущих периодов" />
          <call function="decode" as="set_pereplata_name" type="string" title="Учет переплат" exclude="1">
            <column table="a" column="set_pereplata" type="number" />
            <const>1</const>
            <const>'Да'</const>
            <const>'Нет'</const>
          </call>
          <column table="a" column="set_opl_virt_av" type="number" title="Вычислять оплату для вирт. авансов" nvl="0" format="N0" />
          <call function="decode" as="set_opl_virt_av_name" type="string" title="Вычислять оплату для вирт. авансов" exclude="1">
            <column table="a" column="set_opl_virt_av" type="number" />
            <const>1</const>
            <const>'Да'</const>
            <const>'Нет'</const>
          </call>
        </band>
        <band title="Договор">
          <column table="dep" column="name" title="Отделение" as="dep_name" />
          <column table="kod_dog" column="ndog" />
          <column table="kodp" column="nump" />
          <column table="kodp" column="name" as="kodp_name" />
          <column table="a" column="pr_virt_av" type="number" title="Есть нелегальные авансы по договору" nvl="0" format="N0" />
          <call function="decode" as="pr_virt_av_name" type="string" title="Есть нелегальные авансы по договору" exclude="1">
            <column table="a" column="pr_virt_av" type="number" />
            <const>1</const>
            <const>'Да'</const>
            <const>'Нет'</const>
          </call>
          <column table="a" column="pr_use_virt_av" type="number" title="" exclude="1" />
          <call function="decode" as="pr_use_virt_av_name" type="string" title="Используется виртуальный аванс" exclude="1">
            <column table="a" column="pr_use_virt_av" type="number" title="Используется виртуальный аванс" />
            <const>1</const>
            <const>'Да'</const>
            <const>'Нет'</const>
          </call>
        </band>
        <band title="Исходные данные">
          <band title="Кред. задолженность">
            <column table="a" column="kred_osn" type="number" title="Переплата" />
            <column table="a" column="kred_av_pr" type="number" title="Авансы прошлых периодов (наступила дата окончания действия)" />
            <column table="a" column="kred_av_tek" type="number" title="Авансы текущие" />
            <column table="a" column="kred_av_ftr" type="number" title="Авансы будущих периодов (дата оплаты не наступила)" />
          </band>
          <band title="Деб. задолженность осн. реал">
            <band title="Срок оплаты не наступил">
              <column table="a" column="dlg_osn_np_cur" type="number" title="Окончательный платеж за предыдущий месяц" />
            </band>
            <band title="Срок оплаты наступил">
              <call function="+nvl" as="dlg_osn_pr_pred_all" title="Прошлые периоды">
                <column table="a" column="dlg_osn_pr_pred" />
                <column table="a" column="dlg_osn_pr_pred1" />
              </call>
              <column table="a" column="dlg_osn_pr_cur" type="number" title="Окончательный платеж за предыдущий месяц" />
              <column table="a" column="dlg_osn_pr_nxt" type="number" title="Перерасчеты" />
            </band>
          </band>
          <band title="Реальные авансы 30% 40% (задолженность)">
            <band title="Прошлый период">
              <column table="a" column="dlg_av_tek_prev_fst" type="number" title="1-й платеж (30%)" />
              <column table="a" column="dlg_av_tek_prev_scnd" type="number" title="2-й платеж (40%)" />
            </band>
            <band title="Текущий период">
              <column table="a" column="dlg_av_tek_cur_fst" type="number" title="1-й платеж (30%)" />
              <band title="2-й платеж (40%)">
                <column table="a" column="nach_av_tek_cur_scnd" type="number" title="Начислено" />
                <column table="a" column="dlg_av_tek_cur_scnd" type="number" title="Задолженность" />
              </band>
            </band>
          </band>
          <band title="Реальные авансы НЕ 30% 40% (задолженность)">
            <column table="a" column="dlg_av_tek_othr" type="number" title="Всего" />
            <column table="a" column="dlg_av_tek_prev_othr" type="number" title="За предыдущий период" />
          </band>
          <band title="Виртуальные авансы (начисленно)">
            <column table="a" column="virt_av_tek_cur_fst" type="number" title="1-й платеж (30%)" />
            <column table="a" column="virt_av_tek_cur_scnd" type="number" title="2-й платеж (40%)" />
          </band>
        </band>
        <band title="Расчет">
          <usepart part="37989-pr_use_virt_av" />
          <usepart part="37989-kred_av_for_opl_virt" />
          <band title="Виртуальные авансы">
            <band title="1-й платеж (30%)">
              <usepart part="37989-opl_first_virt_av" />
              <usepart part="37989-dlg_virt_av_tek_cur_fst" />
            </band>
            <band title="2-й платеж (40%)">
              <usepart part="37989-opl_last_virt_av" />
              <usepart part="37989-dlg_virt_av_tek_cur_scnd" />
            </band>
          </band>
        </band>
        <band title="Итоговые данные (подробно)">
          <band title="Кред. задолженность">
            <usepart part="37989-kred_osn_i" />
            <usepart part="37989-kred_av_pr_i" />
            <usepart part="37989-kred_av_tek_i" />
            <usepart part="37989-kred_av_ftr_i" />
          </band>
          <band title="Деб. задолженность осн. реал">
            <band title="Срок оплаты не наступил">
              <usepart part="37989-dlg_osn_np_cur_i" />
            </band>
            <band title="Срок оплаты наступил">
              <usepart part="37989-dlg_osn_pr_pred_all_i" />
              <usepart part="37989-final2_i" />
              <usepart part="37989-zadol_vidreal2_bez_per" />
            </band>
          </band>
          <band title="Деб. задолженность аванс">
            <usepart part="37989-first_pay_pre" />
            <usepart part="37989-last_pay" />
            <usepart part="37989-other_pay" />
            <usepart part="37989-other_pay_prev" />
            <usepart part="37989-no_pay" />
          </band>
          <column table="a" column="cntper_zadol" type="number" title="Количество периодов задолженности" />
          <column table="a" column="kredit" type="number" title="Переплата" exclude="1" />
          <column table="a" column="zadol_bez_mor_vidreal2" type="number" title="Всего" exclude="1" />
          <column table="a" column="first_pay_pre" type="number" title="Первый пром. платеж" exclude="1" />
          <column table="a" column="last_pay" type="number" title="Второй пром. платеж" exclude="1" />
          <column table="a" column="no_pay" type="number" title="Промежуточные платежи за прошлый период" exclude="1" />
          <column table="a" column="other_pay" type="number" title="Другие авансы " exclude="1" />
          <column table="a" column="basic_debt" type="number" title="" exclude="1" />
        </band>
        <band title="Итоговые данные для таблицы уведомлений">
          <usepart part="37989-dolg_all_no_per" />
          <usepart part="37989-kredit" />
          <usepart part="37989-dolg_all" />
          <usepart part="37989-zadol_bez_mor_vidreal2" />
          <usepart part="37989-avans" />
          <usepart part="37989-first_pay" />
          <call excel-calc="1" as="last_pay_t" type="number" function="()" title="Второй промежуточный платеж" format="N2">
            <column table="this" column="last_pay" />
          </call>
          <call excel-calc="1" as="final2_t" type="number" function="()" title="Окончательный платеж за предыдущий месяц" format="N2">
            <column table="this" column="final2_i" />
          </call>
        </band>
        <call as="dlg_osn" excel-calc="1" function="+nvl" title="Основной долг (с учетом настройки учета переплат) " format="N2">
          <column table="this" column="zadol_vidreal2_bez_per" />
          <column table="this" column="kredit" />
          <column table="this" column="no_pay" />
        </call>
        <band title="Данные в уведомлениях">
          <band title="Для уведомлений за пром плат. 40%">
            <call excel-calc="1" as="basic_p_40" type="number" function="+nvl" title="Основной долг" format="N2">
              <column table="this" column="dlg_osn" />
              <column table="this" column="first_pay" />
            </call>
            <call excel-calc="1" as="last_pay_p_40" type="number" function="()" title="Аванс/промежуточный платеж" format="N2">
              <column table="this" column="last_pay_t" />
            </call>
          </band>
          <band title="Для остальных">
            <call excel-calc="1" type="number" function="()" title="Основной долг" as="basic_p" format="N2">
              <column table="this" column="dlg_osn" />
            </call>
            <call excel-calc="1" as="last_pay_p" type="number" function="()" title="Аванс/промежуточный платеж" format="N2">
              <column table="this" column="first_pay" />
            </call>
          </band>
          <band title="Кроме того">
            <usepart part="37989-dlg_osn_cur" />
            <call excel-calc="1" as="pl25" type="number" function="()" title="Аванс/промежуточный платеж" format="N2">
              <column table="this" column="nach_av_tek_cur_scnd" />
            </call>
          </band>
        </band>
      </select>
      <from>
        <query name="vr_37989_dog_tbl" as="a">
          <link name="kod_dog">
            <link name="dep" />
            <link name="kodp" />
          </link>
          <link name="calc_id" />
        </query>
      </from>
      <where>
        <call function="and">
          <call function="in" optional="1">
            <column table="a" column="calc_id" />
            <useparam name="p_calc_id" />
          </call>
          <call function="in" optional="1">
            <column table="kod_dog" column="dep" />
            <useparam name="dep" />
          </call>
          <call function="in" optional="1">
            <column table="a" column="kod_dog" />
            <useparam name="kod_dog" />
          </call>
          <call function="ge" optional="1" exclude="1">
            <column table="a" column="dat_calc" />
            <useparam name="dat1" />
          </call>
          <call function="le" optional="1" exclude="1">
            <column table="a" column="dat_calc" />
            <useparam name="dat2" />
          </call>
        </call>
      </where>
    </query>
    <query name="37989-calc-list" timestamp="30.10.2017 23:17:45">
      <params>
        <param name="dat1" type="date" />
        <param name="dat2" type="date" />
        <param type="array" name="dep" />
        <param type="array" name="kod_dog" />
      </params>
      <select>
        <column table="a" column="calc_id" key="1" />
        <call function="||" title="ID расчета" as="id">
          <call function="date to char">
            <column table="a" column="dat_start" />
          </call>
          <const>'('</const>
          <column table="a" column="calc_id" />
          <const>')'</const>
        </call>
        <column table="a" column="dat_calc" title="Расчет на дату" />
        <column table="a" column="dat_start" title="Дата запуска" format="dd.MM.yyyy HH:mm" />
        <column table="a" column="cnt_dog" title="Количество договоров" />
        <column table="a" column="u_m" title="Пользователь" />
      </select>
      <from>
        <query name="vr_37989_calc_tbl" as="a" />
      </from>
      <where>
        <call function="and">
          <call function="exists">
            <query>
              <select>
                <column table="b" column="dog_id" />
              </select>
              <from>
                <query name="vr_37989_dog_tbl" as="b">
                  <link name="kod_dog" />
                </query>
              </from>
              <where>
                <call function="and">
                  <call function="=">
                    <column table="b" column="calc_id" />
                    <column table="a" column="calc_id" />
                  </call>
                  <call function="in" optional="1">
                    <column table="kod_dog" column="dep" />
                    <useparam name="dep" />
                  </call>
                  <call function="in" optional="1">
                    <column table="b" column="kod_dog" />
                    <useparam name="kod_dog" />
                  </call>
                  <call function="ge" optional="1">
                    <column table="b" column="dat_calc" />
                    <useparam name="dat1" />
                  </call>
                  <call function="le" optional="1">
                    <column table="b" column="dat_calc" />
                    <useparam name="dat2" />
                  </call>
                </call>
              </where>
            </query>
          </call>
          <call function="ge" optional="1">
            <column table="a" column="dat_calc" />
            <useparam name="dat1" />
          </call>
          <call function="le" optional="1">
            <column table="a" column="dat_calc" />
            <useparam name="dat2" />
          </call>
        </call>
      </where>
    </query>
    <query name="37989-test" timestamp="25.12.2017 18:58:40" use-repository="1">
      <params>
        <usepart part="37989-params" />
      </params>
      <expressions>
        <call function="lt" as="is_dolg" dontpushpred="1">
          <column table="kod_sf" column="dat_bzad_uved_kaz_el" />
          <useparam name="p_dat" />
        </call>
        <call function="le" as="is_do_dat" dontpushpred="1">
          <column table="dat" column="val" />
          <useparam name="p_dat" />
        </call>
        <call function="and" as="is_not_dolg" dontpushpred="1">
          <call function="ge" dontpushpred="1">
            <call function="nvl">
              <column table="kod_sf" column="dat_bzad_uved_kaz_el" />
              <call function="doomsday" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <column table="kod_deb" column="dat_deb" />
            <useparam name="p_dat" />
          </call>
        </call>
        <call function="and" as="is_av_pr" dontpushpred="1">
          <call function="lt">
            <call function="nvl">
              <column table="kod_sf" column="dat_ezad_uved_kaz_el" />
              <call function="doomsday" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <column table="dat" column="val" />
            <useparam name="p_dat" />
          </call>
          <call function="in" dontpushpred="1">
            <column table="vid_real" column="vid_real" />
            <array>0</array>
          </call>
        </call>
        <call function="and" as="is_av_ftr" dontpushpred="1">
          <call function="ge" dontpushpred="1">
            <column table="kod_sf" column="dat_bzad_uved_kaz_el" />
            <useparam name="p_dat" />
          </call>
          <call function="ge">
            <call function="nvl">
              <column table="kod_sf" column="dat_ezad_uved_kaz_el" />
              <call function="doomsday" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <column table="dat" column="val" />
            <useparam name="p_dat" />
          </call>
          <call function="in" dontpushpred="1">
            <column table="vid_real" column="vid_real" />
            <array>0</array>
          </call>
        </call>
        <call function="and" as="is_av_ftr1" dontpushpred="1">
          <call function="ge" dontpushpred="1">
            <column table="kod_sf" column="dat_bzad_uved_kaz_el" />
            <useparam name="p_dat" />
          </call>
          <call function="ge">
            <call function="nvl">
              <column table="kod_sf" column="dat_ezad_uved_kaz_el" />
              <call function="doomsday" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <column table="dat" column="val" />
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <column table="kod_sf" column="dat_sf" />
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <call function="nvl">
              <column table="kod_deb" column="dat_deb" />
              <useparam name="p_dat" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="in" dontpushpred="1">
            <column table="vid_real" column="vid_real" />
            <array>0</array>
          </call>
        </call>
        <call function="and" as="is_av_tek" dontpushpred="1">
          <call function="lt" dontpushpred="1">
            <column table="kod_sf" column="dat_bzad_uved_kaz_el" />
            <useparam name="p_dat" />
          </call>
          <call function="ge">
            <call function="nvl">
              <column table="kod_sf" column="dat_ezad_uved_kaz_el" />
              <call function="doomsday" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <call function="nvl">
              <column table="kod_deb" column="dat_deb" />
              <useparam name="p_dat" />
            </call>
            <useparam name="p_dat" />
          </call>
          <call function="le" dontpushpred="1">
            <column table="dat" column="val" />
            <useparam name="p_dat" />
          </call>
          <call function="in" dontpushpred="1">
            <column table="vid_real" column="vid_real" />
            <array>0</array>
          </call>
        </call>
        <call function="and" as="is_mon1" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_sf" column="rym" />
            <useparam name="p_ym" />
          </call>
        </call>
        <call function="and" as="is_mon0" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_sf" column="rym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-1</const>
            </call>
          </call>
        </call>
        <call function="and" as="is_mon_pred_osn" dontpushpred="1">
          <call function="lt" dontpushpred="1">
            <column table="kod_sf" column="ym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-2</const>
            </call>
          </call>
        </call>
        <call function="and" as="is_mon_tek_osn" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_sf" column="ym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-1</const>
            </call>
          </call>
        </call>
        <call function="and" as="is_mon_sled_osn" dontpushpred="1">
          <call function="gt" dontpushpred="1">
            <column table="kod_sf" column="ym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-1</const>
            </call>
          </call>
        </call>
        <call function="and" as="is_mon_pred1_osn" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_sf" column="ym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-2</const>
            </call>
          </call>
        </call>
        <call function="and" as="is_fst" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_sf" column="perc" />
            <const>30</const>
          </call>
        </call>
        <call function="and" as="is_scnd" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_sf" column="perc" />
            <const>40</const>
          </call>
        </call>
        <call function="and" as="is_virt_tek" dontpushpred="1">
          <call function="lt" dontpushpred="1">
            <column table="kod_avans_uved" column="dat_bzad_uved_kaz_el" />
            <useparam name="p_dat" />
          </call>
          <call function="ge">
            <column table="kod_avans_uved" column="dat_ezad" />
            <useparam name="p_dat" />
          </call>
        </call>
        <call function="and" as="is_virt_mon1" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_avans_uved" column="rym" />
            <useparam name="p_ym" />
          </call>
        </call>
        <call function="and" as="is_virt_mon0" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_avans_uved" column="rym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-1</const>
            </call>
          </call>
        </call>
        <call function="and" as="is_virt_fst" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_avans_uved" column="perc" />
            <const>30</const>
          </call>
        </call>
        <call function="and" as="is_virt_scnd" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_avans_uved" column="perc" />
            <const>40</const>
          </call>
        </call>
        <call function="and" as="is_othr_av" dontpushpred="1">
          <call function="not in" dontpushpred="1">
            <call function="nvl">
              <column table="kod_sf" column="perc" />
              <const>0</const>
            </call>
            <array>30,40</array>
          </call>
        </call>
        <call function="is null" as="is_used_state" exclude="1">
          <call function="if">
            <call function="le">
              <column table="kod_debet_state" column="dat_ust" />
            </call>
          </call>
        </call>
        <call function="and" as="is_3m" dontpushpred="1">
          <call function="between" dontpushpred="1">
            <column table="kod_sf" column="ym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-3</const>
            </call>
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-1</const>
            </call>
          </call>
        </call>
        <call function="and" as="is_1m" dontpushpred="1">
          <call function="=" dontpushpred="1">
            <column table="kod_sf" column="ym" />
            <call function="ym add month">
              <useparam name="p_ym" />
              <const>-1</const>
            </call>
          </call>
        </call>
        <call function="()" as="nach_osn_3m" group="sum" type="number">
          <fact column="fin_ul_nachisl_osn" condition="is_3m" />
        </call>
        <call function="()" as="nach_osn_1m" group="sum" type="number">
          <fact column="fin_ul_nachisl_osn" condition="is_1m" />
        </call>
        <call function="()" as="opl_sf_osn_do_dat" group="sum" type="number">
          <fact column="fin_ul_opl_sf_osn" condition="is_do_dat" />
        </call>
        <call function="()" as="nach_osn_do_dat" group="sum" type="number">
          <fact column="fin_ul_nachisl_osn" condition="is_do_dat" />
        </call>
        <call function="()" as="opl_sf_av_do_dat" group="sum" type="number">
          <fact column="fin_ul_opl_sf_av" condition="is_do_dat" exclude="1" />
          <fact column="fin_ul_opl_kred_av" condition="is_do_dat" />
        </call>
        <call function="()" as="nach_osn_pr" group="sum" type="number">
          <fact column="fin_ul_nachisl_osn" condition="is_dolg" />
        </call>
        <call function="0-" as="opl_osn_pr" group="sum" type="number">
          <fact column="opl_sf_osn_do_dat" condition="is_dolg" />
        </call>
        <call function="()" as="nach_osn_np" group="sum" type="number">
          <fact column="nach_osn_do_dat" condition="is_not_dolg" />
        </call>
        <call function="0-" as="opl_osn_np" group="sum" type="number">
          <fact column="opl_sf_osn_do_dat" condition="is_not_dolg" />
        </call>
        <call function="+nvl" as="dlg_osn_pr" group="sum">
          <fact column="nach_osn_pr" />
          <fact column="opl_osn_pr" />
        </call>
        <call function="()" as="dlg_osn_pr_cur" group="sum">
          <fact column="dlg_osn_pr" condition="is_mon_tek_osn" />
        </call>
        <call function="()" as="dlg_osn_pr_nxt" group="sum">
          <fact column="dlg_osn_pr" condition="is_mon_sled_osn" />
        </call>
        <call function="()" as="dlg_osn_pr_pred1" group="sum">
          <fact column="dlg_osn_pr" condition="is_mon_pred1_osn" />
        </call>
        <call function="()" as="dlg_osn_pr_pred" group="sum">
          <fact column="dlg_osn_pr" condition="is_mon_pred_osn" />
        </call>
        <call function="+nvl" as="dlg_osn_np" group="sum">
          <fact column="nach_osn_np" />
          <fact column="opl_osn_np" />
        </call>
        <call function="()" as="dlg_osn_np_cur" group="sum">
          <fact column="dlg_osn_np" condition="is_mon_tek_osn" />
        </call>
        <call function="0-" as="kred_osn" group="sum" type="number">
          <fact column="fin_ul_ob_kr_os" condition="is_do_dat" />
        </call>
        <call function="0-" as="kred_av" group="sum" type="number">
          <fact column="fin_ul_ob_kr_av" condition="is_do_dat" />
        </call>
        <call function="()" as="kred_av_pr" group="sum" type="number">
          <fact column="kred_av" condition="is_av_pr" />
        </call>
        <call function="()" as="kred_av_ftr" group="sum" type="number">
          <fact column="kred_av" condition="is_av_ftr" />
        </call>
        <call function="()" as="nach_av_tek" group="sum" type="number">
          <fact column="fin_ul_nachisl_av" condition="is_av_tek" />
        </call>
        <call function="()" as="nach_av_ftr" group="sum" type="number">
          <fact column="fin_ul_nachisl_av" condition="is_av_ftr1" />
        </call>
        <call function="0-" as="opl_av_tek" group="sum" type="number">
          <fact column="opl_sf_av_do_dat" condition="is_av_tek" />
        </call>
        <call function="0-" as="opl_av_ftr" group="sum" type="number">
          <fact column="opl_sf_av_do_dat" condition="is_av_ftr1" />
        </call>
        <call function="0-" as="stor_av_tek" group="sum" type="number">
          <fact column="sr_opl_opl_stor" condition="is_av_tek" />
        </call>
        <call function="+nvl" group="sum" as="dlg_av_tek">
          <fact column="nach_av_tek" />
          <fact column="opl_av_tek" />
        </call>
        <call function="+nvl" group="sum" as="dlg_av_ftr">
          <fact column="nach_av_ftr" />
          <fact column="opl_av_ftr" />
        </call>
        <call function="+nvl" group="sum" as="kred_av_tek">
          <fact column="opl_av_tek" />
          <fact column="stor_av_tek" />
        </call>
        <call function="()" as="nach_av_tek_fst" group="sum" type="number" exclude="1">
          <fact column="nach_av_tek" condition="is_fst" />
        </call>
        <call function="()" as="nach_av_tek_scnd" group="sum" type="number" exclude="1">
          <fact column="nach_av_tek" condition="is_scnd" />
        </call>
        <call function="()" as="nach_av_tek_othr" group="sum" type="number" exclude="1">
          <fact column="nach_av_tek" condition="is_othr" />
        </call>
        <call function="()" as="nach_av_tek_cur" group="sum" type="number">
          <fact column="nach_av_tek" condition="is_mon1" />
        </call>
        <call function="()" as="opl_av_tek_cur" group="sum" type="number">
          <fact column="opl_av_tek" condition="is_mon1" />
        </call>
        <call function="()" as="stor_av_tek_cur" group="sum" type="number">
          <fact column="stor_av_tek" condition="is_mon1" />
        </call>
        <call function="()" as="dlg_av_tek_cur" group="sum" type="number">
          <fact column="dlg_av_tek" condition="is_mon1" />
        </call>
        <call function="()" as="kred_av_tek_cur" group="sum" type="number">
          <fact column="kred_av_tek" condition="is_mon1" />
        </call>
        <call function="()" as="nach_av_tek_prev" group="sum" type="number">
          <fact column="nach_av_tek" condition="is_mon0" />
        </call>
        <call function="()" as="opl_av_tek_prev" group="sum" type="number">
          <fact column="opl_av_tek" condition="is_mon0" />
        </call>
        <call function="()" as="stor_av_tek_prev" group="sum" type="number">
          <fact column="stor_av_tek" condition="is_mon0" />
        </call>
        <call function="()" as="dlg_av_tek_prev" group="sum" type="number">
          <fact column="dlg_av_tek" condition="is_mon0" />
        </call>
        <call function="()" as="kred_av_tek_prev" group="sum" type="number">
          <fact column="kred_av_tek" condition="is_mon0" />
        </call>
        <call function="()" as="nach_av_tek_cur_fst" group="sum" type="number">
          <fact column="nach_av_tek_cur" condition="is_fst" />
        </call>
        <call function="()" as="opl_av_tek_cur_fst" group="sum" type="number">
          <fact column="opl_av_tek_cur" condition="is_fst" />
        </call>
        <call function="()" as="stor_av_tek_cur_fst" group="sum" type="number">
          <fact column="stor_av_tek_cur" condition="is_fst" />
        </call>
        <call function="()" as="dlg_av_tek_cur_fst" group="sum" type="number">
          <fact column="dlg_av_tek_cur" condition="is_fst" />
        </call>
        <call function="()" as="kred_av_tek_cur_fst" group="sum" type="number">
          <fact column="kred_av_tek_cur" condition="is_fst" />
        </call>
        <call function="()" as="nach_av_tek_prev_fst" group="sum" type="number">
          <fact column="nach_av_tek_prev" condition="is_fst" />
        </call>
        <call function="()" as="opl_av_tek_prev_fst" group="sum" type="number">
          <fact column="opl_av_tek_prev" condition="is_fst" />
        </call>
        <call function="()" as="stor_av_tek_prev_fst" group="sum" type="number">
          <fact column="stor_av_tek_prev" condition="is_fst" />
        </call>
        <call function="()" as="dlg_av_tek_prev_fst" group="sum" type="number">
          <fact column="dlg_av_tek_prev" condition="is_fst" />
        </call>
        <call function="()" as="kred_av_tek_prev_fst" group="sum" type="number">
          <fact column="kred_av_tek_prev" condition="is_fst" />
        </call>
        <call function="()" as="nach_av_tek_cur_scnd" group="sum" type="number">
          <fact column="nach_av_tek_cur" condition="is_scnd" />
        </call>
        <call function="()" as="opl_av_tek_cur_scnd" group="sum" type="number">
          <fact column="opl_av_tek_cur" condition="is_scnd" />
        </call>
        <call function="()" as="stor_av_tek_cur_scnd" group="sum" type="number">
          <fact column="stor_av_tek_cur" condition="is_scnd" />
        </call>
        <call function="()" as="dlg_av_tek_cur_scnd" group="sum" type="number">
          <fact column="dlg_av_tek_cur" condition="is_scnd" />
        </call>
        <call function="()" as="kred_av_tek_cur_scnd" group="sum" type="number">
          <fact column="kred_av_tek_cur" condition="is_scnd" />
        </call>
        <call function="()" as="nach_av_tek_prev_scnd" group="sum" type="number">
          <fact column="nach_av_tek_prev" condition="is_scnd" />
        </call>
        <call function="()" as="opl_av_tek_prev_scnd" group="sum" type="number">
          <fact column="opl_av_tek_prev" condition="is_scnd" />
        </call>
        <call function="()" as="stor_av_tek_prev_scnd" group="sum" type="number">
          <fact column="stor_av_tek_prev" condition="is_scnd" />
        </call>
        <call function="()" as="dlg_av_tek_prev_scnd" group="sum" type="number">
          <fact column="dlg_av_tek_prev" condition="is_scnd" />
        </call>
        <call function="()" as="kred_av_tek_prev_scnd" group="sum" type="number">
          <fact column="kred_av_tek_prev" condition="is_scnd" />
        </call>
        <call function="()" as="virt_av_tek" group="sum" type="number">
          <fact column="sr_avans_uved_avans" condition="is_virt_tek" />
        </call>
        <call function="()" as="virt_av_tek_prev" group="sum" type="number">
          <fact column="virt_av_tek" condition="is_virt_mon0" />
        </call>
        <call function="()" as="virt_av_tek_prev_fst" group="sum" type="number">
          <fact column="virt_av_tek_prev" condition="is_virt_fst" />
        </call>
        <call function="()" as="virt_av_tek_prev_scnd" group="sum" type="number">
          <fact column="virt_av_tek_prev" condition="is_virt_scnd" />
        </call>
        <call function="()" as="virt_av_tek_cur" group="sum" type="number">
          <fact column="virt_av_tek" condition="is_virt_mon1" />
        </call>
        <call function="()" as="virt_av_tek_cur_fst" group="sum" type="number">
          <fact column="virt_av_tek_cur" condition="is_virt_fst" />
        </call>
        <call function="()" as="virt_av_tek_cur_scnd" group="sum" type="number">
          <fact column="virt_av_tek_cur" condition="is_virt_scnd" />
        </call>
        <call function="()" as="nach_av_tek_othr" group="sum" type="number">
          <fact column="nach_av_tek" condition="is_othr_av" />
        </call>
        <call function="()" as="opl_av_tek_othr" group="sum" type="number">
          <fact column="opl_av_tek" condition="is_othr_av" />
        </call>
        <call function="()" as="stor_av_tek_othr" group="sum" type="number">
          <fact column="stor_av_tek" condition="is_othr_av" />
        </call>
        <call function="()" as="dlg_av_tek_othr" group="sum" type="number">
          <fact column="dlg_av_tek" condition="is_othr_av" />
        </call>
        <call function="()" as="dlg_av_tek_prev_othr" group="sum" type="number">
          <fact column="dlg_av_tek_prev" condition="is_othr_av" />
        </call>
        <call function="()" as="kred_av_tek_othr" group="sum" type="number">
          <fact column="kred_av_tek" condition="is_othr_av" />
        </call>
        <call function="()" as="sld_av_ftr_othr" group="sum" type="number">
          <fact column="dlg_av_ftr" condition="is_othr_av" />
        </call>
      </expressions>
      <select>
        <column table="kod_dog" column="ndog" />
        <column table="vid_real" column="vid_real" />
        <column table="vid_real" column="name" as="vid_real_name" />
        <call function="()" as="ym_rasch" type="number">
          <useparam name="p_ym" />
        </call>
        <band title="Настройки">
          <column table="nastr" column="virt_avans" as="set_virt_avans" />
          <column table="nastr" column="pereplata" as="set_pereplata" />
          <column table="nastr" column="pereplata_current" as="set_pereplata_cur" />
          <column table="nastr" column="pereplata_future" as="set_pereplata_ftr" />
          <column table="nastr" column="oplata_virt_avans" as="set_opl_virt_av" />
        </band>
        <band title="Документ начисления">
          <column table="kod_sf" column="kod_sf" />
          <column table="kod_sf" column="name" as="sf_name" />
          <column table="kod_sf" column="kod_deb" />
          <column table="kod_sf" column="dat_sf" />
          <column table="kod_sf" column="ym" />
          <column table="kod_sf" column="rym" title="Период потребления" />
          <column table="kod_deb" column="dat_bzad" />
          <column table="kod_deb" column="name1" as="deb_name" />
          <column table="kod_deb" column="dat_deb" />
          <column table="kod_sf" column="dat_ezad" />
          <column table="kod_sf" column="perc1" as="perc" />
        </band>
        <column table="kod_dog" column="dep" />
        <column table="kod_dog" column="kod_dog" />
        <fact column="kr_vd_pr_illegal_av" as="pr_virt_av" title="Признак применения виртуальных авансов" />
        <call function="if" as="pr_legal_av" type="number" exclude="1">
          <call function="and">
            <call function="=0">
              <column table="kod_sf" column="vid_real" />
            </call>
            <call function="in">
              <column table="this" column="perc" />
              <array>30,40</array>
            </call>
          </call>
          <const>1</const>
        </call>
        <fact column="kr_vd_pr_3040_av" as="pr_3040_av" />
        <call as="dlg_deb" function="+nvl" title="Долг по документу">
          <fact column="dlg_osn_pr" title="Просроченный" table="sf" />
          <fact column="dlg_av_tek" title="Просроченный" table="sf" />
        </call>
        <fact column="nach_osn_3m" table="sf" />
        <fact column="nach_osn_1m" title="Просроченный" table="sf" />
        <fact column="dlg_osn_pr" title="Просроченный" table="sf" />
        <fact column="dlg_av_tek" title="Просроченный" table="sf" />
        <fact column="opl_osn_pr" title="Просроченный" table="sf" />
        <call as="dlg_kred" function="+nvl" title="Кред. задолженность">
          <fact column="kred_osn" title="Просроченный" table="kred" />
          <fact column="kred_av" title="Просроченный" table="kred" />
        </call>
        <band title="Задолженность по основной реализации">
          <fact column="dlg_osn_pr_pred" title="Ранее" table="sf" />
          <fact column="dlg_osn_pr_pred1" title="За предыдущий период" table="sf" />
          <band title="Окончательный платеж">
            <fact column="dlg_osn_pr_cur" title="Просроченный" table="sf" />
            <fact column="dlg_osn_np_cur" title="Не просроченный" table="sf" />
          </band>
          <fact column="dlg_osn_pr_nxt" title="Следующий период" table="sf" />
        </band>
        <band title="Кредиторская задолженность">
          <column table="kod_opl_kred" column="kod_opl" />
          <column table="kod_opl_kred" column="dat_opl" title="Дата оплаты" />
          <fact column="kred_osn" title="Переплата" table="kred" />
          <fact column="kred_av_pr" title="Авансы прошлых периодов (наступила дата окончания действия)" table="kred" />
          <fact column="kred_av_ftr" title="Авансы будущих периодов (дата оплаты не наступила)" table="kred" />
          <fact column="kred_av_tek" title="Авансы текущие" table="kred" />
        </band>
        <band title="Реальные авансы 30% 40%">
          <band title="Прошлый период">
            <band title="1-й платеж (30%)">
              <fact column="dlg_av_tek_prev_fst" title="Задолженность" table="sf" />
            </band>
            <band title="2-й платеж (40%)">
              <fact column="dlg_av_tek_prev_scnd" title="Задолженность" table="sf" />
            </band>
          </band>
          <band title="Текущий период">
            <band title="1-й платеж (30%)">
              <fact column="dlg_av_tek_cur_fst" title="Задолженность" table="sf" />
            </band>
            <band title="2-й платеж (40%)">
              <fact column="nach_av_tek_cur_scnd" title="Начислено" table="sf" />
              <fact column="dlg_av_tek_cur_scnd" title="Задолженность" table="sf" />
            </band>
          </band>
        </band>
        <band title="Реальные авансы не 30% 40%">
          <fact column="nach_av_tek_othr" title="Начислено" exclude="1" />
          <fact column="opl_av_tek_othr" title="Оплата" exclude="1" />
          <fact column="stor_av_tek_othr" title="Сторно (пошло в погашение)" exclude="1" />
          <fact column="dlg_av_tek_othr" title="Задолженность" table="sf" />
          <fact column="dlg_av_tek_prev_othr" title="Задолженность" table="sf" />
          <call function="if" as="dlg_av_tek_othr_leg" type="number" exclude="1">
            <call function="=1">
              <column table="this" column="pr_legal_av" />
            </call>
            <fact column="dlg_av_tek_othr" title="Задолженность" table="sf" />
          </call>
          <fact column="kred_av_tek_othr" title="Кредит" exclude="1" />
          <fact column="sld_av_ftr_othr" title="Дата оплаты не наступила" exclude="1" />
        </band>
        <band title="Виртуальные авансы 30% 40%">
          <band title="Прошлый период" exclude="1">
            <band title="1-й платеж (30%)">
              <fact column="virt_av_tek_prev_fst" title="Начислено" />
            </band>
            <band title="2-й платеж (40%)">
              <fact column="virt_av_tek_prev_scnd" title="Начислено" />
            </band>
          </band>
          <band title="Текущий период">
            <band title="1-й платеж (30%)">
              <fact column="virt_av_tek_cur_fst" title="Начислено" />
            </band>
            <band title="2-й платеж (40%)">
              <fact column="virt_av_tek_cur_scnd" title="Начислено" />
            </band>
          </band>
        </band>
        <band title="Из уведомлений" exclude="1">
          <fact column="kr_predabon_kod_pred" title="Аванс" table="pred" />
          <fact column="kr_predabon_avans" title="Аванс" table="pred" />
          <fact column="kr_predabon_prom_plat1" title="Первый платеж" table="pred" />
          <fact column="kr_predabon_prom_plat2" title="Второй платеж" table="pred" />
          <fact column="kr_predabon_okon_plat" title="Окончательный платеж" table="pred" />
          <fact column="kr_predabon_osn_dolg" title="Основной долг" table="pred" />
          <fact column="kr_predabon_pereplata" title="Переплата" table="pred" />
          <fact column="kr_predabon_dolg_no_per" title="Долг без переплаты" table="pred" />
        </band>
      </select>
      <from>
        <qube merge-dimsets="1">
          <link name="kod_dog">
            <link name="dep">
              <elink name="ks_tf_nastr_rep_uved" as="nastr" />
            </link>
          </link>
          <link name="kod_sf" exclude="1">
            <link name="kod_deb" />
          </link>
          <link name="dat" exclude="1" />
          <dimset as="sf">
            <link name="kod_sf">
              <link name="kod_deb" />
            </link>
            <link name="vid_real" />
          </dimset>
          <dimset as="kred">
            <link name="kod_sf">
              <link name="kod_deb" />
            </link>
            <link name="kod_opl_kred" />
            <link name="vid_real" />
          </dimset>
          <dimset as="pred">
            <link name="kod_pred" />
            <where>
              <call function="and">
                <call function="=">
                  <call function="trunc">
                    <column table="kod_pred" column="dat_ras" />
                  </call>
                  <useparam name="p_dat" />
                </call>
                <call function="=1">
                  <column table="kod_pred" column="pr_last_on_dat" />
                </call>
                <call function="!=nvl">
                  <column table="kod_pred" column="pr_arx" />
                  <const>1</const>
                </call>
              </call>
            </where>
          </dimset>
          <where>
            <call function="in">
              <column table="kod_dog" column="kod_dog" />
              <call function="vr_number_array.get">
                <useparam name="p_kod_dog_array_id" />
              </call>
            </call>
            <call function="=" exclude="1">
              <column table="kod_dog" column="dep" />
              <const>1172</const>
            </call>
            <call function="=">
              <column table="kod_dog" column="pr_active" />
              <const>0</const>
            </call>
            <call function="le" exclude="1">
              <column table="dat" column="val" />
              <useparam name="p_dat" />
            </call>
          </where>
        </qube>
      </from>
    </query>
  </queries>
  <parts>
    <part id="37989-params" timestamp="25.12.2017 18:52:47">
      <param type="date" name="p_dat">
        <const>to_date('17.11.2017','DD.MM.YYYY')</const>
      </param>
      <param type="number" name="p_ym">
        <const>2017.11</const>
      </param>
      <param type="string" name="p_kod_dog_array_id">
        <const>'dog1'</const>
      </param>
      <param type="number" name="p_calc_id">
        <const>8</const>
      </param>
      <param type="date" name="p_dat_start">
        <const>to_date('17.11.2017','DD.MM.YYYY')</const>
      </param>
    </part>
    <part id="37989-withparams" timestamp="25.06.2017 21:15:31">
      <useparam name="p_dat" />
      <useparam name="p_ym" />
      <useparam name="p_kod_dog_array_id" />
      <useparam name="p_calc_id" />
      <useparam name="p_dat_start" />
    </part>
  </parts>
  <reports>
    <report name="37989" timestamp="20.06.2017 13:43:00" use-repository="1">
      <params>
        <usepart part="37989-params" />
      </params>
      <queries>
        <query name="37989-main" as="main" update-target="vr_37989_calc_tbl">
          <withparams>
            <usepart part="37989-withparams" />
          </withparams>
          <query name="37989-dog" as="dog" update-target="vr_37989_dog_tbl">
            <withparams>
              <usepart part="37989-withparams" />
            </withparams>
            <call function="is not null" comment="заплатка,нужно условие со ссылкой на колонку master, по другому не работает">
              <column table="main" column="dat_calc" />
            </call>
            <query name="37989-det" as="sf" update-target="vr_37989_det_tbl">
              <withparams>
                <usepart part="37989-withparams" />
              </withparams>
              <call function="=">
                <column table="dog" column="kod_dog" />
                <column table="sf" column="kod_dog" />
              </call>
            </query>
          </query>
        </query>
      </queries>
    </report>
  </reports>
</root>